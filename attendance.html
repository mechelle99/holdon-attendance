<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>出勤檢視</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6f8;padding:16px;margin:0;}
    .header{margin-bottom:15px;display:flex;gap:10px;align-items:center;}
    .card{background:#fff;padding:12px;border-radius:12px;margin-bottom:10px;box-shadow:0 2px 5px rgba(0,0,0,0.05);display:flex;align-items:center;}
    .date-box{width:60px;text-align:center;border-right:1px solid #eee;margin-right:10px;}
    .date-day{font-size:18px;font-weight:bold;color:#333;}
    .date-w{font-size:12px;color:#999;}
    .info{flex:1;}
    .time-row{font-size:14px;color:#444;line-height:1.6;}
    .tag{font-size:13px;padding:4px 10px;border-radius:6px;color:#fff;font-weight:bold;min-width:60px;text-align:center;}
    /* 狀態顏色 */
    .ok{background:#34c759} .late{background:#ff9500} .miss{background:#ff3b30}
    .off{background:#e5e5ea;color:#999} .leave{background:#007aff}
    select{padding:8px;border-radius:8px;background:white;}
    button{padding:8px 15px;background:#111;color:#fff;border-radius:8px;border:none;}
  </style>
</head>
<body>
  <div class="header">
    <button onclick="location.href='app.html'">←</button>
    <select id="y"></select>
    <select id="m"></select>
    <button onclick="load()">查詢</button>
  </div>
  <div id="list"></div>
  <script src="config.js"></script>
  <script>
    const uid = localStorage.getItem("employeeId");
    const yS = document.getElementById("y");
    const mS = document.getElementById("m");
    const now = new Date();

    if (yS && mS) {
        for(let i=2024; i<=2026; i++) yS.add(new Option(i, i, i===now.getFullYear(), i===now.getFullYear()));
        for(let i=1; i<=12; i++) mS.add(new Option(i, i, i===(now.getMonth()+1), i===(now.getMonth()+1)));
    }

    function api(a, d={}) {
      return new Promise(r => {
        const endpoint = window.CONFIG ? window.CONFIG.GAS_ENDPOINT : null;
        if (!endpoint) { alert("Config Error"); return; }
        const s = document.createElement("script");
        s.src = `${endpoint}?action=${a}&payload=${encodeURIComponent(JSON.stringify({...d, userId:uid}))}&callback=cb${Date.now()}`;
        window[`cb${Date.now()}`] = (res) => { r(res); s.remove(); };
        document.body.appendChild(s);
      });
    }

    async function load() {
      const listDiv = document.getElementById("list");
      listDiv.innerHTML = "載入中...";
      
      const y = parseInt(yS.value);
      const m = parseInt(mS.value);
      
      // 直接拿後端算好的 dailyData
      const r = await api("get_dashboard", {year:y, month:m});
      listDiv.innerHTML = "";

      if(r && r.ok && r.dailyData) {
        if(r.dailyData.length === 0) {
            listDiv.innerHTML = "<div style='text-align:center;padding:20px;color:#999'>無資料</div>";
            return;
        }
        r.dailyData.forEach(d => {
          listDiv.innerHTML += `
            <div class="card">
              <div class="date-box">
                <div class="date-day">${d.date}</div>
                <div class="date-w">${d.week}</div>
              </div>
              <div class="info">
                <div class="time-row"><span>上班</span> ${d.in}</div>
                <div class="time-row"><span>下班</span> ${d.out}</div>
              </div>
              <div class="tag ${d.cls}">${d.tag}</div>
            </div>`;
        });
      } else {
         listDiv.innerHTML = `<div style='text-align:center;color:red'>讀取失敗: ${r?r.message:'Unknown'}</div>`;
      }
    }
    load();
  </script>
</body>
</html>
