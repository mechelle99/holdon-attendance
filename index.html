<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HOLDON æ‰“å¡</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 14px; }
    button { margin: 6px 6px 0 0; padding: 10px 12px; }
    #debug { margin-top: 12px; padding: 10px; border: 1px solid #ddd; white-space: pre-wrap; font-size: 12px; }
    .muted { color:#666; font-size:12px; }
  </style>
</head>
<body>
  <h2>HOLDON å‡ºå‹¤æ‰“å¡</h2>
  <div class="muted">å¦‚æœä½ çœ‹å¾—åˆ°é€™è¡Œå­—ï¼Œä»£è¡¨é é¢è¼‰å…¥æ­£å¸¸ï¼ˆä¸æ˜¯ç©ºç™½ï¼‰ã€‚</div>

  <p id="user">è¼‰å…¥ä¸­...</p>
  <p id="status" class="muted"></p>

  <button id="btnIn"  disabled>ğŸŸ¢ ä¸Šç­æ‰“å¡</button>
  <button id="btnOut" disabled>ğŸ”´ ä¸‹ç­æ‰“å¡</button>
  <button id="btnOT"  disabled>ğŸ•’ åŠ ç­æ‰“å¡</button>

  <div id="debug">debug: start</div>

<script>
  const LIFF_ID = "2009036245-XmZMSuuS";
  const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbz0YAlbpIYDqN6UC99TmaksEfzylud1QzuwTaupCp9zGdpUlReuRxaG8cvryxziHli_/exec";

  let userId = "";
  let displayName = "";
  let ready = false;

  const $ = (id) => document.getElementById(id);

  function log(msg){
    $("debug").innerText += "\n" + msg;
  }
  function setStatus(msg){ $("status").innerText = msg; }
  function setButtons(on){
    $("btnIn").disabled  = !on;
    $("btnOut").disabled = !on;
    $("btnOT").disabled  = !on;
  }

  window.onerror = function(message, source, lineno, colno, error) {
    log("window.onerror: " + message + " @ " + lineno + ":" + colno);
  };

  async function init(){
    try{
      setButtons(false);
      setStatus("åˆå§‹åŒ–ä¸­...");
      log("origin=" + location.origin);
      log("href=" + location.href);

      log("liff.init start");
      await liff.init({ liffId: LIFF_ID });
      log("liff.init ok");

      log("isLoggedIn=" + liff.isLoggedIn());
      if(!liff.isLoggedIn()){
        log("calling liff.login()");
        liff.login();
        return;
      }

      log("getProfile start");
      const profile = await liff.getProfile();
      log("getProfile ok");

      userId = profile.userId || "";
      displayName = profile.displayName || "";

      $("user").innerText = "ä½ å¥½ï¼Œ" + displayName;

      $("btnIn").onclick  = () => sendLog("ä¸Šç­");
      $("btnOut").onclick = () => sendLog("ä¸‹ç­");
      $("btnOT").onclick  = () => sendLog("åŠ ç­");

      ready = true;
      setButtons(true);
      setStatus("å¯ä»¥æ‰“å¡äº† âœ…");
      log("ready=true");
    }catch(e){
      setStatus("åˆå§‹åŒ–å¤±æ•—ï¼ˆçœ‹ debugï¼‰");
      log("ERROR: " + (e?.message || e));
    }
  }

  async function sendLog(type){
    if(!ready){
      setStatus("å°šæœªåˆå§‹åŒ–å®Œæˆ");
      return;
    }

    setStatus("é€å‡ºä¸­...");
    log("sendLog=" + type);

    const body = new URLSearchParams({
      type,
      userId,
      displayName,
      ts: String(Date.now())
    }).toString();

    try{
      await fetch(GAS_WEBAPP_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
        body
      });

      setStatus("å·²é€å‡º âœ…ï¼ˆå» Sheet çœ‹æœ‰æ²’æœ‰æ–°å¢ï¼‰");
      log("sent");
    }catch(err){
      setStatus("é€å‡ºå¤±æ•—ï¼ˆçœ‹ debugï¼‰");
      log("ERR: " + (err?.message || err));
    }
  }

  init();
</script>
</body>
</html>
