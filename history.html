<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>ç´€éŒ„æŸ¥è©¢</title>
  <style>
    :root { --primary: #4F46E5; --bg: #F3F4F6; --card: #FFFFFF; --text: #1F2937; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; padding: 20px 20px 80px 20px; color: var(--text); }

    .header { margin-bottom: 15px; }
    h2 { margin: 0; font-size: 22px; font-weight: 700; }

    .tabs { display: flex; background: #E5E7EB; border-radius: 12px; padding: 4px; margin-bottom: 20px; }
    .tab { flex: 1; text-align: center; padding: 12px; font-size: 15px; font-weight: 700; color: #6B7280; border-radius: 10px; cursor: pointer; transition: all 0.2s; }
    .tab.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

    .filter-card {
      background: var(--card); padding: 16px; border-radius: 16px; margin-bottom: 20px;
      display: flex; align-items: center; gap: 15px; width: 100%; box-sizing: border-box;
      box-shadow: 0 2px 6px rgba(0,0,0,0.02);
    }
    .filter-group { flex: 1; display: flex; flex-direction: column; min-width: 0; }
    .filter-group label { font-size: 12px; margin-bottom: 6px; color: #6B7280; font-weight: 600; }
    .filter-group select {
      width: 100%; box-sizing: border-box; height: 42px; padding: 0 12px;
      border: 1px solid #E5E7EB; border-radius: 10px; background: #F9FAFB;
      font-size: 14px; outline: none; -webkit-appearance: none;
    }

    .content-area { display: none; }
    .content-area.active { display: block; }

    .att-card {
      background: white; padding: 15px; border-radius: 16px;
      display: flex; align-items: center; margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.03);
      border-left: 5px solid transparent;
    }
    .att-date {
      width: 60px; text-align: center; border-right: 1px solid #eee; margin-right: 15px; padding-right: 15px;
    }
    .d-num { font-size: 20px; font-weight: 800; color: #333; }
    .d-week { font-size: 12px; color: #999; margin-top: 2px; }
    .weekend .d-num, .weekend .d-week { color: #EF4444; }

    .att-info { flex: 1; font-size: 14px; color: #374151; line-height: 1.5; }
    .time-row { display: flex; align-items: center; margin-bottom: 2px; }
    .time-label { color: #9CA3AF; font-size: 12px; width: 40px; }

    .att-tag {
      padding: 6px 12px; border-radius: 8px; font-size: 13px; font-weight: 700;
      color: white; min-width: 60px; text-align: center;
    }

    .cls-ok { border-left-color: #10B981; } .tag-ok { background: #10B981; }
    .cls-late { border-left-color: #F59E0B; } .tag-late { background: #F59E0B; }
    .cls-miss { border-left-color: #EF4444; } .tag-miss { background: #EF4444; }
    .cls-leave { border-left-color: #3B82F6; } .tag-leave { background: #3B82F6; }
    .cls-off { border-left-color: #E5E7EB; } .tag-off { background: #E5E7EB; color: #9CA3AF; }

    .req-card { background: var(--card); padding: 16px; border-radius: 16px; margin-bottom: 12px; border-left: 4px solid #ddd; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
    .req-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .req-title { font-weight: 700; font-size: 16px; display: flex; align-items: center; gap: 6px; }
    .status-badge { padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; }
    .status-PENDING { background: #FEF3C7; color: #92400E; }
    .status-APPROVED { background: #D1FAE5; color: #065F46; }
    .status-REJECTED { background: #FEE2E2; color: #991B1B; }
    .req-time { font-size: 13px; color: #6B7280; display: flex; align-items: center; gap: 4px; }
    .req-reason { margin-top: 8px; background: #F3F4F6; padding: 10px; border-radius: 8px; font-size: 14px; color: #4B5563; word-break: break-all; }

    .nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); padding: 12px 20px; padding-bottom: max(12px, env(safe-area-inset-bottom)); display: flex; justify-content: space-around; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); border-top-left-radius: 24px; border-top-right-radius: 24px; z-index: 100; }
    .nav-item { text-decoration: none; color: #9CA3AF; display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 4px; }
    .nav-item.active { color: var(--primary); } .nav-icon { font-size: 22px; }
  </style>
</head>
<body>

  <div class="header"><h2>ğŸ“‹ ç´€éŒ„æŸ¥è©¢</h2></div>

  <div class="tabs">
    <div class="tab active" onclick="switchTab('att', this)">æ¯æ—¥å‡ºå‹¤</div>
    <div class="tab" onclick="switchTab('req', this)">ç”³è«‹å–®æ“š</div>
  </div>

  <div class="filter-card">
    <div class="filter-group">
      <label>æœˆä»½</label>
      <select id="mSelect" onchange="refresh()"></select>
    </div>

    <div class="filter-group" id="statusFilter" style="display:none;">
      <label>ç‹€æ…‹</label>
      <select id="sSelect" onchange="refresh()">
        <option value="">å…¨éƒ¨</option>
        <option value="PENDING">å¯©æ ¸ä¸­</option>
        <option value="APPROVED">å·²é€šé</option>
        <option value="REJECTED">å·²é§å›</option>
      </select>
    </div>
  </div>

  <div id="view-att" class="content-area active">
    <div id="list-att" style="text-align:center;color:#999;padding:40px;">è¼‰å…¥ä¸­...</div>
  </div>

  <div id="view-req" class="content-area">
    <div id="list-req" style="text-align:center;color:#999;padding:40px;">è¼‰å…¥ä¸­...</div>
  </div>

  <nav class="nav">
    <a href="app.html" class="nav-item"><span class="nav-icon">ğŸ </span>é¦–é </a>
    <a href="request.html" class="nav-item"><span class="nav-icon">ğŸ“</span>ç”³è«‹</a>
    <a href="history.html" class="nav-item active"><span class="nav-icon">ğŸ“‹</span>ç´€éŒ„</a>
    <a href="schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span>æ’ç­</a>
    <a href="manager.html" class="nav-item" id="mgrBtn" style="display:none"><span class="nav-icon">ğŸ‘‘</span>ä¸»ç®¡</a>
  </nav>

<script src="config.js"></script>
<script>
  const uid = localStorage.getItem("employeeId");
  const isMgr = localStorage.getItem("isManager") === "true";
  if(isMgr) document.getElementById("mgrBtn").style.display = 'flex';

  // ---- åŸºç¤é˜²å‘†ï¼šæ²’æœ‰ uid ç›´æ¥æç¤º ----
  if(!uid){
    alert("æ‰¾ä¸åˆ° employeeIdï¼ˆè«‹å…ˆç™»å…¥æˆ–å›é¦–é é‡æ–°ç™»å…¥ï¼‰");
  }

  // 1) åˆå§‹åŒ–æœˆä»½ (æœ€è¿‘ 6 å€‹æœˆ)
  const mSel = document.getElementById("mSelect");
  const now = new Date();
  for(let i=0; i<6; i++) {
    const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
    const v = `${d.getFullYear()}/${d.getMonth()+1}`;
    const t = `${d.getFullYear()}å¹´${String(d.getMonth()+1).padStart(2,'0')}æœˆ`;
    mSel.add(new Option(t, v));
  }

  let currentTab = 'att';

  function switchTab(tab, el) {
    currentTab = tab;

    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    if (el) el.classList.add('active');

    document.querySelectorAll('.content-area').forEach(c => c.classList.remove('active'));
    document.getElementById(`view-${tab}`).classList.add('active');

    document.getElementById('statusFilter').style.display = (tab === 'req') ? 'flex' : 'none';
    refresh();
  }

  function refresh() {
    if (currentTab === 'att') loadAttendance();
    else loadRequests();
  }

  // âœ… ä¿®å¥½ JSONP callback åç¨±ä¸€è‡´ + timeout
  function api(act, d={}) {
    return new Promise((resolve) => {
      const cbName = `cb_${Date.now()}_${Math.floor(Math.random()*100000)}`;
      const s = document.createElement("script");

      const payloadObj = {...d, userId: uid};
      const payloadStr = encodeURIComponent(JSON.stringify(payloadObj));
      s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${encodeURIComponent(act)}&payload=${payloadStr}&callback=${cbName}`;

      const timer = setTimeout(() => {
        cleanup();
        resolve({ ok:false, message:"API timeout" });
      }, 15000);

      function cleanup(){
        clearTimeout(timer);
        try { delete window[cbName]; } catch(_){}
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }

      window[cbName] = (res) => {
        cleanup();
        resolve(res);
      };

      s.onerror = () => {
        cleanup();
        resolve({ ok:false, message:"API load error" });
      };

      document.body.appendChild(s);
    });
  }

  function renderEmpty(el) {
    el.innerHTML = `<div style="text-align:center;padding:40px;color:#9CA3AF;">ç„¡ç›¸é—œè³‡æ–™</div>`;
  }

  // ---- æ™‚é–“å·¥å…·ï¼šè®“ start å¯èƒ½æ˜¯ Date / å­—ä¸²éƒ½èƒ½è™•ç† ----
  function toYMDHM(v){
    if(!v) return "";
    // å¦‚æœæ˜¯ Date ç‰©ä»¶
    if (v instanceof Date && !isNaN(v.getTime())) {
      const y=v.getFullYear();
      const m=String(v.getMonth()+1).padStart(2,'0');
      const d=String(v.getDate()).padStart(2,'0');
      const hh=String(v.getHours()).padStart(2,'0');
      const mm=String(v.getMinutes()).padStart(2,'0');
      return `${y}-${m}-${d} ${hh}:${mm}`;
    }
    // å­—ä¸²
    const s = String(v);
    return s.replace('T',' ').slice(0,16);
  }

  function getMonthKeyFromStart(v){
    if(!v) return "";
    if (v instanceof Date && !isNaN(v.getTime())){
      return `${v.getFullYear()}-${String(v.getMonth()+1).padStart(2,'0')}`;
    }
    const s = String(v);
    // æœŸæœ› yyyy-MM
    const m = s.match(/^(\d{4})-(\d{2})/);
    if (m) return `${m[1]}-${m[2]}`;
    return "";
  }

  function classifyByLeaveType(leaveType){
    const t = String(leaveType||"").toLowerCase();
    if (t === "ot" || t.includes("åŠ ç­")) return { icon:"â±ï¸", label:"åŠ ç­" };
    if (t === "outing" || t.includes("å¤–å‡º")) return { icon:"ğŸš¶", label:"å¤–å‡º" };
    if (t === "correction" || t.includes("è£œå¡")) return { icon:"ğŸ› ï¸", label:"è£œå¡" };
    // å…¶ä»–éƒ½ç•¶è«‹å‡
    return { icon:"ğŸ—“ï¸", label:"è«‹å‡" };
  }

  function typeName(leaveType){
    const t = String(leaveType||"").toLowerCase();
    if (t === "annual") return "ç‰¹ä¼‘";
    if (t === "comp") return "è£œä¼‘";
    if (t === "sick") return "ç—…å‡";
    if (t === "personal") return "äº‹å‡";
    if (t === "birthday") return "ç”Ÿæ—¥å‡";
    if (t === "ot") return "åŠ ç­";
    if (t === "outing") return "å¤–å‡º";
    if (t === "correction") return "è£œå¡";
    return leaveType || "ç”³è«‹";
  }

  // â˜… åŠŸèƒ½ 1: è¼‰å…¥æ¯æ—¥å‡ºå‹¤
  async function loadAttendance() {
    const listDiv = document.getElementById("list-att");
    listDiv.innerHTML = '<div style="text-align:center;color:#999;padding:40px;">è¼‰å…¥å‡ºå‹¤è³‡æ–™...</div>';

    const [y, m] = mSel.value.split('/');

    const res = await api("get_dashboard", {year: Number(y), month: Number(m)});
    if(!res.ok || !res.dailyData || res.dailyData.length === 0) {
      renderEmpty(listDiv); return;
    }

    let h = "";
    res.dailyData.forEach(d => {
      const isWk = (d.week==='æ—¥'||d.week==='å…­') ? 'weekend' : '';
      const cls = `cls-${d.cls || 'ok'}`;
      const tagCls = `tag-${d.cls || 'ok'}`;

      h += `
        <div class="att-card ${cls}">
          <div class="att-date ${isWk}">
            <div class="d-num">${d.date}</div>
            <div class="d-week">${d.week}</div>
          </div>
          <div class="att-info">
            <div class="time-row"><span class="time-label">ä¸Šç­</span> <b>${d.in || '--'}</b></div>
            <div class="time-row"><span class="time-label">ä¸‹ç­</span> <b>${d.out || '--'}</b></div>
          </div>
          <div class="att-tag ${tagCls}">${d.tag || 'æ­£å¸¸'}</div>
        </div>`;
    });

    listDiv.innerHTML = h;
  }

  // â˜… åŠŸèƒ½ 2: è¼‰å…¥ç”³è«‹å–®
  async function loadRequests() {
    const listDiv = document.getElementById("list-req");
    listDiv.innerHTML = '<div style="text-align:center;color:#999;padding:40px;">è¼‰å…¥ç”³è«‹è³‡æ–™...</div>';

    const status = document.getElementById("sSelect").value;
    const [y, m] = mSel.value.split('/');

    const res = await api("list_requests", { filterStatus: status });
    if(!res.ok || !res.list || res.list.length === 0) {
      renderEmpty(listDiv); return;
    }

    const targetMonth = `${y}-${String(m).padStart(2,'0')}`;
    const filtered = res.list.filter(r => getMonthKeyFromStart(r.start) === targetMonth);

    if(filtered.length === 0) {
      renderEmpty(listDiv); return;
    }

    let h = "";
    filtered.forEach(r => {
      const st = String(r.status || "PENDING").toUpperCase();

      let badge = "å¯©æ ¸ä¸­";
      if(st === 'APPROVED') badge = "å·²é€šé";
      if(st === 'REJECTED') badge = "å·²é§å›";

      const c = classifyByLeaveType(r.leaveType);
      const typeTxt = typeName(r.leaveType);

      const borderColor = (st==='PENDING') ? '#F59E0B' : (st==='APPROVED' ? '#10B981' : '#EF4444');

      h += `
        <div class="req-card" style="border-left-color:${borderColor}">
          <div class="req-header">
            <div class="req-title">
              <span>${c.icon}</span> ${typeTxt}
            </div>
            <div class="status-badge status-${st}">${badge}</div>
          </div>
          <div class="req-time">ğŸ“… ${toYMDHM(r.start)} (${Number(r.hours||0)}h)</div>
          <div class="req-reason">${r.reason || 'ç„¡å‚™è¨»'}</div>
        </div>`;
    });

    listDiv.innerHTML = h;
  }

  // å•Ÿå‹•
  refresh();
</script>
</body>
</html>
