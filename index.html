<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HOLDON 出勤系統 - 登入</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6f8;padding:24px;display:flex;justify-content:center;align-items:center;height:100vh;margin:0}
    .card{width:100%;max-width:360px;background:#fff;padding:24px;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
    input{width:100%;padding:12px;margin:8px 0;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;font-size:16px;}
    button{width:100%;padding:12px;background:#111;color:#fff;border:none;border-radius:8px;font-weight:bold;cursor:pointer;margin-top:10px;font-size:16px;}
    button:disabled{background:#ccc;cursor:wait;}
    .link{text-align:center;margin-top:16px;font-size:13px}
    .link a{color:#666;text-decoration:none;border-bottom:1px dotted #999}
    .hidden{display:none}
    
    /* Loading 動畫 */
    #loading{color:#007aff;font-size:14px;text-align:center;margin-top:15px;display:none;font-weight:500;}
    .spinner {
      display:inline-block; width:12px; height:12px; border:2px solid #007aff; border-radius:50%;
      border-top-color:transparent; animation:spin 1s linear infinite; margin-right:5px; vertical-align:middle;
    }
    @keyframes spin {to{transform: rotate(360deg);}}
  </style>
</head>
<body>
  <div class="card" id="loginCard">
    <h2 style="margin-top:0;text-align:center;">HOLDON 登入</h2>
    <input id="empId" placeholder="員工編號 (例如 M001)" />
    <input id="pass" type="password" placeholder="密碼" />
    <button id="btnLogin" onclick="login()">登入</button>
    
    <div id="loading">
      <span class="spinner"></span><span id="loadText">系統連線中...</span>
    </div>
    
    <div class="link">
      <a href="javascript:showForgot()">忘記密碼？</a>
    </div>
  </div>

  <div class="card hidden" id="forgotCard">
    <h2 style="margin-top:0">重設密碼</h2>
    <p style="font-size:13px;color:#666">將寄送驗證碼到您的 Email</p>
    <input id="f_empId" placeholder="員工編號" />
    <button id="btnSendForgot" onclick="sendForgot()">寄送驗證碼</button>
    <div class="link"><a href="javascript:showLogin()">回登入</a></div>
  </div>

  <div class="card hidden" id="resetCard">
    <h2 style="margin-top:0">設定新密碼</h2>
    <input id="r_token" placeholder="驗證碼" />
    <input id="r_p1" type="password" placeholder="新密碼" />
    <button id="btnReset" onclick="doReset()">確認重設</button>
    <div class="link"><a href="javascript:showLogin()">取消</a></div>
  </div>

  <script src="config.js"></script>
  <script>
    const ENDPOINT = window.CONFIG?.GAS_ENDPOINT || "";
    
    function showLogin(){ document.getElementById("loginCard").style.display="block"; document.getElementById("forgotCard").style.display="none"; document.getElementById("resetCard").style.display="none"; }
    function showForgot(){ document.getElementById("loginCard").style.display="none"; document.getElementById("forgotCard").style.display="block"; }
    function showReset(){ document.getElementById("forgotCard").style.display="none"; document.getElementById("resetCard").style.display="block"; }

    function jsonpCall(action, data){
      // ★★★ 修正：移除超時限制，避免誤報錯誤 ★★★
      return new Promise((resolve, reject)=>{
        const cbName = "cb" + Date.now();
        const script = document.createElement("script");
        const payload = JSON.stringify({ ...data, webhookKey: window.CONFIG?.WEBHOOK_KEY });
        const url = `${ENDPOINT}?action=${action}&payload=${encodeURIComponent(payload)}&callback=${cbName}`;
        
        window[cbName] = (res) => {
           resolve(res);
           delete window[cbName];
           script.remove();
        };
        
        // 只有真的網路斷線才會觸發這個
        script.onerror = () => { 
           reject("網路連線失敗，請檢查您的網路"); 
        };
        
        script.src = url;
        document.body.appendChild(script);
      });
    }

    async function login(){
       const empId = document.getElementById("empId").value.trim();
       const pass = document.getElementById("pass").value.trim();
       if(!empId || !pass) return alert("請輸入帳號與密碼");

       const btn = document.getElementById("btnLogin");
       const loading = document.getElementById("loading");
       const loadText = document.getElementById("loadText");

       btn.disabled = true;
       loading.style.display = "block";
       loadText.textContent = "系統連線中...";

       // 動態提示，安撫使用者耐心
       const msgTimer = setTimeout(() => { loadText.textContent = "正在喚醒資料庫 (首次需 20-30 秒)..."; }, 5000);
       const msgTimer2 = setTimeout(() => { loadText.textContent = "資料讀取中，請稍候..."; }, 15000);

       try {
         const res = await jsonpCall("login", { empId, pass });
         
         clearTimeout(msgTimer);
         clearTimeout(msgTimer2);
         loading.style.display = "none";
         btn.disabled = false;

         if(res.ok){
             localStorage.setItem("employeeId", res.empId);
             localStorage.setItem("employeeName", res.name);
             localStorage.setItem("isManager", res.isManager ? "Y":"N");
             localStorage.setItem("canSchedule", res.canSchedule ? "Y":"N");
             location.href = "app.html";
         } else {
             alert("❌ " + res.message);
         }
       } catch(e){ 
           clearTimeout(msgTimer);
           clearTimeout(msgTimer2);
           loading.style.display = "none";
           btn.disabled = false;
           alert("登入錯誤：" + e); 
       }
    }

    async function sendForgot(){
        const empId = document.getElementById("f_empId").value;
        const btn = document.getElementById("btnSendForgot");
        if(!empId) return alert("請輸入");
        
        btn.disabled = true; btn.textContent = "發送中...";
        try {
            const res = await jsonpCall("forgot_password", { empId });
            if(res.ok) { alert(res.message); showReset(); } else { alert(res.message); }
        } catch(e) { alert(e); }
        finally { btn.disabled = false; btn.textContent = "寄送驗證碼"; }
    }

    async function doReset(){
        const empId = document.getElementById("f_empId").value;
        const token = document.getElementById("r_token").value;
        const newPass = document.getElementById("r_p1").value;
        const btn = document.getElementById("btnReset");
        if(!token || !newPass) return alert("請填寫");
        
        btn.disabled = true; btn.textContent = "處理中...";
        try {
            const res = await jsonpCall("reset_password", { empId, token, newPass });
            if(res.ok){ alert("修改成功，請登入"); showLogin(); } else { alert(res.message); }
        } catch(e) { alert(e); }
        finally { btn.disabled = false; btn.textContent = "確認重設"; }
    }
  </script>
</body>
</html>
