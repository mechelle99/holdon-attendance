<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HOLDON ç³»çµ±</title>
  <style>
    :root{ --blue:#007aff; --bg:#f4f6f8; }
    body{font-family:-apple-system,sans-serif;background:var(--bg);margin:0;padding:16px;color:#333;padding-bottom:80px;}
    .card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05);margin-bottom:16px;}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
    .btn{width:100%;padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:bold;color:#fff;cursor:pointer;margin-top:8px;}
    .btn-in{background:var(--blue);}
    .btn-out{background:#ff9500;}
    .btn-gray{background:#555;}
    .btn-link{background:none;color:#007aff;border:1px solid #007aff;margin-top:10px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    input, select, textarea{width:100%;padding:12px;margin-top:6px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;font-size:16px;}
    label{font-size:13px;color:#666;font-weight:bold;margin-top:10px;display:block;}
    .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);display:none;justify-content:center;align-items:center;z-index:99;}
    .history-item{padding:10px 0;border-bottom:1px solid #eee;font-size:14px;}
    .hidden{display:none;}
  </style>
</head>
<body>

  <div id="loading" class="loading-overlay">è™•ç†ä¸­...</div>

  <div class="header">
    <div style="font-weight:bold;font-size:18px;" id="dispName">...</div>
    <a href="javascript:logout()" style="color:#c00;font-size:14px;text-decoration:none;">ç™»å‡º</a>
  </div>

  <div id="managerArea" class="hidden">
    <button class="btn" style="background:#6f42c1;" onclick="location.href='manager.html'">ğŸ‘‘ ä¸»ç®¡å¯©æ ¸å¾Œå°</button>
  </div>
  <div id="scheduleArea" class="hidden">
    <button class="btn" style="background:#17a2b8;" onclick="location.href='schedule.html'">ğŸ“… æ’ç­è¡¨</button>
  </div>

  <div class="card">
    <h3 style="margin-top:0">ğŸ“ æ‰“å¡</h3>
    <div class="grid">
      <button class="btn btn-in" onclick="doClock('clock_in')">ä¸Šç­</button>
      <button class="btn btn-out" onclick="doClock('clock_out')">ä¸‹ç­</button>
    </div>
    <div class="grid">
      <button class="btn btn-gray" onclick="doClock('outing_clock_in')">å¤–å‡ºå‡ºç™¼</button>
      <button class="btn btn-gray" onclick="doClock('outing_clock_out')">å¤–å‡ºè¿”å›</button>
    </div>
    <div id="clockStatus" style="text-align:center;font-size:13px;color:var(--blue);margin-top:8px;"></div>
  </div>

  <div class="card">
    <h3 style="margin-top:0">ğŸ“ ç”³è«‹å–®</h3>
    <label>é¡å‹</label>
    <select id="reqType" onchange="toggleFields()">
      <option value="LEAVE">è«‹å‡</option>
      <option value="OT">åŠ ç­</option>
      <option value="OUTING">å¤–å‡ºå…¬å‹™ (é å…ˆç”³è«‹)</option>
    </select>

    <div id="fieldLeave">
      <label>å‡åˆ¥</label>
      <select id="leaveType">
        <option value="annual">ç‰¹ä¼‘</option>
        <option value="personal">äº‹å‡</option>
        <option value="sick">ç—…å‡</option>
        <option value="comp">è£œä¼‘</option>
      </select>
    </div>

    <div class="grid">
      <div><label>é–‹å§‹</label><input type="datetime-local" id="startAt"></div>
      <div><label>çµæŸ</label><input type="datetime-local" id="endAt"></div>
    </div>
    
    <label>æ™‚æ•¸ (é¸å¡«)</label>
    <input type="number" id="hours" placeholder="ä¾‹å¦‚: 8">

    <label>äº‹ç”±</label>
    <textarea id="reason" rows="2"></textarea>
    
    <button class="btn btn-gray" onclick="submitReq()">é€å‡ºç”³è«‹</button>
    
    <button class="btn btn-link" onclick="location.href='history.html'">ğŸ“œ æŸ¥çœ‹æ‰€æœ‰ç´€éŒ„</button>
  </div>

  <div class="card">
    <h3 style="margin-top:0">ğŸ“Š æœ€è¿‘æ‰“å¡</h3>
    <div id="historyList">è¼‰å…¥ä¸­...</div>
  </div>

  <script src="config.js"></script>
  <script>
    const userId = localStorage.getItem("employeeId");
    if(!userId) location.href = "index.html";
    document.getElementById("dispName").textContent = localStorage.getItem("employeeName");

    // æ¬Šé™é¡¯ç¤º
    if(localStorage.getItem("isManager")==="Y") document.getElementById("managerArea").classList.remove("hidden");
    if(localStorage.getItem("isManager")==="Y" || localStorage.getItem("canSchedule")==="Y") {
      document.getElementById("scheduleArea").classList.remove("hidden");
    }

    // é€šç”¨ API å‘¼å« (JSONP)
    function api(action, payload = {}) {
      return new Promise((resolve, reject) => {
        document.getElementById("loading").style.display = "flex";
        
        payload.userId = userId;
        payload.webhookKey = window.CONFIG.WEBHOOK_KEY;
        
        const cbName = "cb" + Date.now() + Math.floor(Math.random()*1000);
        const script = document.createElement("script");
        const url = `${window.CONFIG.GAS_ENDPOINT}?action=${action}&payload=${encodeURIComponent(JSON.stringify(payload))}&callback=${cbName}`;
        
        window[cbName] = (res) => {
          document.getElementById("loading").style.display = "none";
          resolve(res);
          delete window[cbName];
          script.remove();
        };
        
        script.onerror = () => {
          document.getElementById("loading").style.display = "none";
          reject("Network Error");
          delete window[cbName];
          script.remove();
        };
        
        script.src = url;
        document.body.appendChild(script);
      });
    }

    // 1. æ‰“å¡
    function doClock(type) {
      if(!navigator.geolocation) return alert("ä¸æ”¯æ´å®šä½");
      navigator.geolocation.getCurrentPosition(async (pos) => {
        try {
          const res = await api(type, {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            accuracy: pos.coords.accuracy
          });
          alert(res.message);
          if(res.ok) {
            document.getElementById("clockStatus").textContent = `æœ€å¾Œæ‰“å¡: ${res.time}`;
            loadHistory();
          }
        } catch(e) { alert("éŒ¯èª¤: " + e); }
      }, (err) => alert("ç„¡æ³•å®šä½: " + err.message));
    }

    // 2. ç”³è«‹
    async function submitReq() {
      const type = document.getElementById("reqType").value;
      const data = {
        category: type,
        leaveType: (type === 'LEAVE') ? document.getElementById("leaveType").value : '',
        start_ts: document.getElementById("startAt").value, 
        end_ts: document.getElementById("endAt").value,
        hours: document.getElementById("hours").value,
        reason: document.getElementById("reason").value
      };
      
      if(data.start_ts) data.start_ts = new Date(data.start_ts).toISOString();
      if(data.end_ts) data.end_ts = new Date(data.end_ts).toISOString();

      try {
        const res = await api("submit_request", data);
        alert(res.message);
        if(res.ok) {
          document.getElementById("reason").value = "";
          loadHistory();
        }
      } catch(e) { alert("éŒ¯èª¤: " + e); }
    }

    function toggleFields() {
      const t = document.getElementById("reqType").value;
      document.getElementById("fieldLeave").style.display = (t === "LEAVE") ? "block" : "none";
    }

    // 3. è®€å–æ­·å²
    async function loadHistory() {
      try {
        const res = await api("get_my_dashboard");
        const div = document.getElementById("historyList");
        if(res.ok && res.attendance) {
          div.innerHTML = res.attendance.map(item => `
            <div class="history-item">
              <span style="font-weight:bold">${item.date}</span>
              <span style="float:right">${item.time}</span>
              <div style="color:#666;font-size:12px;">${item.type}</div>
            </div>
          `).join("");
        } else {
          div.innerHTML = "ç„¡è³‡æ–™";
        }
      } catch(e) { console.error(e); }
    }

    function logout() {
      localStorage.clear();
      location.href = "index.html";
    }

    loadHistory();
  </script>
</body>
</html>
