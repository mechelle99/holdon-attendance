<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>å¡«å¯«ç”³è«‹å–®</title>
  <style>
    :root { --primary: #4F46E5; --bg: #F3F4F6; --card: #FFFFFF; --text: #1F2937; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; padding: 20px 20px 80px 20px; color: var(--text); }
    h2 { font-size: 20px; margin-bottom: 20px; font-weight: 700; }
    .form-group { margin-bottom: 20px; }
    label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #4B5563; }
    input, select, textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #E5E7EB; background: #fff; font-size: 16px; box-sizing: border-box; -webkit-appearance: none; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
    textarea { resize: vertical; min-height: 80px; }
    .btn-submit { width: 100%; background: var(--primary); color: white; padding: 14px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; margin-top: 10px; cursor: pointer; }
    .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; }
    .nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); padding: 12px 20px; padding-bottom: max(12px, env(safe-area-inset-bottom)); display: flex; justify-content: space-around; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); border-top-left-radius: 24px; border-top-right-radius: 24px; z-index: 100; }
    .nav-item { text-decoration: none; color: #9CA3AF; display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 4px; }
    .nav-item.active { color: var(--primary); } .nav-icon { font-size: 22px; }
  </style>
</head>
<body>

  <h2>ğŸ“ å¡«å¯«ç”³è«‹å–®</h2>

  <div class="form-group">
    <label>ç”³è«‹é¡å‹</label>
    <select id="cat" onchange="toggleType()">
      <option value="LEAVE">è«‹å‡</option>
      <option value="OT">åŠ ç­</option>
      <option value="OUTING">å¤–å‡º</option>
      <option value="CORRECTION">è£œå¡</option>
    </select>
  </div>

  <div class="form-group" id="typeGroup">
    <label>å‡åˆ¥</label>
    <select id="type">
      <option value="annual">ç‰¹ä¼‘</option>
      <option value="comp">è£œä¼‘</option>
      <option value="personal">äº‹å‡</option>
      <option value="sick">ç—…å‡</option>
      <option value="official">å…¬å‡</option>
      <option value="marriage">å©šå‡</option>
      <option value="bereavement">å–ªå‡</option>
      <option value="menstrual">ç”Ÿç†å‡</option>
      <option value="maternity">ç”¢å‡</option>
      <option value="paternity">é™ªç”¢å‡</option>
      <option value="family">å®¶åº­ç…§é¡§å‡</option>
      <option value="birthday">ç”Ÿæ—¥å‡</option>
    </select>
  </div>

  <div class="form-group">
    <label>é–‹å§‹æ™‚é–“</label>
    <input type="datetime-local" id="start" onchange="calcDiff()">
  </div>

  <div class="form-group">
    <label>çµæŸæ™‚é–“</label>
    <input type="datetime-local" id="end" onchange="calcDiff()">
  </div>

  <div class="form-group" id="hoursGroup">
    <label>æ™‚æ•¸ (è‡ªå‹•è¨ˆç®—)</label>
    <input type="number" id="hours" value="0" readonly style="background-color: #F3F4F6;">
  </div>

  <div class="form-group">
    <label>äº‹ç”±</label>
    <textarea id="reason" placeholder="è«‹å¡«å¯«èªªæ˜..."></textarea>
  </div>

  <button class="btn-submit" id="submitBtn" onclick="submit()">é€å‡ºç”³è«‹</button>

  <nav class="nav">
    <a href="app.html" class="nav-item"><span class="nav-icon">ğŸ </span>é¦–é </a>
    <a href="request.html" class="nav-item active"><span class="nav-icon">ğŸ“</span>ç”³è«‹</a>
    <a href="history.html" class="nav-item"><span class="nav-icon">ğŸ“‹</span>ç´€éŒ„</a>
    <a href="schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span>æ’ç­</a>
    <a href="manager.html" class="nav-item"><span class="nav-icon">ğŸ‘‘</span>ä¸»ç®¡</a>
  </nav>

<script src="config.js"></script>
<script>
  const uid = localStorage.getItem("employeeId");
  if(!uid) location.href='index.html';

  // åˆå§‹åŒ–æ™‚é–“ï¼šé è¨­ä»Šå¤© 09:00 - 18:00
  const now = new Date();
  const ymd = now.toISOString().split('T')[0];
  document.getElementById("start").value = `${ymd}T09:00`;
  document.getElementById("end").value = `${ymd}T18:00`;

  // â˜… è£œä¸ Aï¼štoggleType åˆ†æ”¯å„ªåŒ–
  function toggleType() {
    const cat = document.getElementById("cat").value;
    const typeGroup = document.getElementById("typeGroup");
    const hoursGroup = document.getElementById("hoursGroup");
    const endWrap = document.getElementById("end").parentNode;

    if (cat === 'CORRECTION') {
      typeGroup.style.display = 'none';
      hoursGroup.style.display = 'none';
      endWrap.style.display = 'none';
      // åŒæ­¥æ™‚é–“èˆ‡æ™‚æ•¸
      const sVal = document.getElementById("start").value;
      if (sVal) document.getElementById("end").value = sVal;
      document.getElementById("hours").value = 0;
    } else if (cat === 'OUTING') {
      typeGroup.style.display = 'none';
      hoursGroup.style.display = 'block';
      endWrap.style.display = 'block';
      calcDiff();
    } else if (cat === 'OT') {
      // åŠ ç­å›ºå®šç‚ºè£œä¼‘ä¾†æº
      typeGroup.style.display = 'none';
      document.getElementById("type").value = 'comp';
      hoursGroup.style.display = 'block';
      endWrap.style.display = 'block';
      calcDiff();
    } else {
      typeGroup.style.display = 'block';
      hoursGroup.style.display = 'block';
      endWrap.style.display = 'block';
      calcDiff();
    }
  }

  // â˜… è£œä¸ Bï¼šcalcDiff è£œå¡åˆ¤å®š
  function calcDiff() {
    const cat = document.getElementById("cat").value;
    if (cat === 'CORRECTION') return;

    const sVal = document.getElementById("start").value;
    const eVal = document.getElementById("end").value;
    if (!sVal || !eVal) return;

    const s = new Date(sVal);
    const e = new Date(eVal);

    if (e <= s) {
      document.getElementById("hours").value = 0;
      return;
    }

    const diffHrs = (e - s) / (1000 * 60 * 60);
    document.getElementById("hours").value = diffHrs.toFixed(1);
  }

  function api(act, d={}) {
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random() * 100000);
      const s = document.createElement("script");
      const payload = encodeURIComponent(JSON.stringify({...d, userId:uid}));
      s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${act}&payload=${payload}&callback=${cbName}&_=${Date.now()}`;
      window[cbName] = (res) => { try { resolve(res); } finally { delete window[cbName]; s.remove(); } };
      s.onerror = () => { delete window[cbName]; s.remove(); reject(new Error("Network Error")); };
      document.body.appendChild(s);
    });
  }

  // â˜… è£œä¸ Cï¼šçµ„è£è³‡æ–™é‚è¼¯å¼·åŒ–
  async function submit() {
    const btn = document.getElementById("submitBtn");
    const cat = document.getElementById("cat").value;
    
    btn.disabled = true;
    btn.innerText = "é€å‡ºä¸­...";

    const data = {
      category: cat,
      leaveType: (cat === 'LEAVE') ? document.getElementById("type").value
              : (cat === 'OT') ? 'comp'
              : '', 
      start: document.getElementById("start").value,
      end: (cat === 'CORRECTION') ? document.getElementById("start").value : document.getElementById("end").value,
      hours: (cat === 'CORRECTION') ? 0 : document.getElementById("hours").value,
      reason: document.getElementById("reason").value
    };

    if (cat !== 'CORRECTION' && Number(data.hours) <= 0) {
      alert("éŒ¯èª¤ï¼šçµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“");
      btn.disabled = false;
      btn.innerText = "é€å‡ºç”³è«‹";
      return;
    }

    try {
      const res = await api("submit_request", data);
      if(res.ok) {
        alert("ç”³è«‹æˆåŠŸï¼");
        location.href = "history.html";
      } else {
        alert("å¤±æ•—: " + res.message);
        btn.disabled = false;
        btn.innerText = "é€å‡ºç”³è«‹";
      }
    } catch(e) {
      alert("ç¶²è·¯éŒ¯èª¤ï¼Œè«‹é‡è©¦");
      btn.disabled = false;
      btn.innerText = "é€å‡ºç”³è«‹";
    }
  }
  
  toggleType(); // åˆå§‹ UI èª¿æ ¡
</script>
</body>
</html>
