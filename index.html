<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HOLDON å‡ºå‹¤ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:Arial,sans-serif;padding:16px;color:#111;}
    h2{margin:0 0 8px;}
    .muted{color:#666;font-size:12px;margin:6px 0 14px;}
    .tabs{display:flex;gap:8px;margin:12px 0;}
    .tab{padding:8px 12px;border:1px solid #ddd;border-radius:999px;background:#fff;cursor:pointer;font-size:13px;}
    .tab.active{border-color:#111;}
    .card{border:1px solid #eee;border-radius:14px;padding:14px;margin:12px 0;box-shadow:0 8px 24px rgba(0,0,0,.05);}
    .row{display:flex;gap:10px;flex-wrap:wrap;}
    .btn{padding:10px 12px;border-radius:999px;border:1px solid #ddd;background:#fff;cursor:pointer;}
    .btn.primary{border-color:#111;}
    .btn:disabled{opacity:.45;cursor:not-allowed;}
    label{font-size:12px;color:#444;display:block;margin:10px 0 4px;}
    input,select,textarea{width:100%;box-sizing:border-box;padding:10px 12px;border:1px solid #ddd;border-radius:10px;font-size:14px;}
    textarea{min-height:70px;resize:vertical;}
    .status{font-size:13px;margin-top:10px;}
    .ok{color:#0a7a2f;}
    .err{color:#b00020;}
    .hidden{display:none;}
    .item{border-top:1px solid #eee;padding-top:10px;margin-top:10px;}
    .pill{display:inline-block;font-size:12px;padding:3px 8px;border:1px solid #ddd;border-radius:999px;color:#444;margin-left:6px;}
    .hint{font-size:12px;color:#666;margin-top:6px;}
  </style>
</head>
<body>
  <h2>HOLDON å‡ºå‹¤ç³»çµ±</h2>
  <div class="muted">ä¸Š/ä¸‹ç­ç«‹å³ç”Ÿæ•ˆï¼›æ‰“å¡éœ€åœ¨å…¬å¸ 100 å…¬å°ºå…§ï¼›åŠ ç­èˆ‡è«‹å‡éœ€ä¸»ç®¡æ ¸å‡†ã€‚</div>

  <div class="card">
    <div id="user">è¼‰å…¥ä¸­...</div>
    <div id="gpsHint" class="hint">å®šä½ï¼šæœªå–å¾—</div>
    <div id="status" class="status muted"></div>

    <div class="row" style="margin-top:10px;">
      <button id="btnIn"  class="btn primary" disabled>ğŸŸ¢ ä¸Šç­æ‰“å¡</button>
      <button id="btnOut" class="btn primary" disabled>ğŸ”´ ä¸‹ç­æ‰“å¡</button>
      <button id="btnGPS" class="btn" disabled>ğŸ“ é‡æ–°å®šä½</button>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabApply">ç”³è«‹</button>
      <button class="tab" id="tabMine">æˆ‘çš„ç”³è«‹</button>
      <button class="tab hidden" id="tabMgr">ä¸»ç®¡æ ¸å‡†</button>
    </div>
  </div>

  <div id="panelApply" class="card">
    <h3 style="margin:0 0 8px;">ğŸ•’ åŠ ç­ç”³è«‹ï¼ˆéœ€æ ¸å‡†ï¼‰</h3>
    <label>åŠ ç­æ—¥æœŸ</label><input id="otDate" type="date"/>
    <label>åŠ ç­æ™‚æ•¸ï¼ˆå°æ™‚ï¼‰</label><input id="otHours" type="number" min="0.5" step="0.5" placeholder="ä¾‹å¦‚ï¼š2"/>
    <label>åŸå› èªªæ˜</label><textarea id="otReason" placeholder="ç°¡è¿°åŠ ç­åŸå› "></textarea>
    <div class="row" style="margin-top:10px;">
      <button id="btnOTApply" class="btn" disabled>é€å‡ºåŠ ç­ç”³è«‹</button>
    </div>

    <hr style="border:none;border-top:1px solid #eee;margin:14px 0;"/>

    <h3 style="margin:0 0 8px;">ğŸ“ è«‹å‡ç”³è«‹ï¼ˆéœ€æ ¸å‡†ï¼‰</h3>
    <label>å‡åˆ¥</label>
    <select id="leaveType">
      <option value="äº‹å‡">äº‹å‡</option>
      <option value="ç—…å‡">ç—…å‡</option>
      <option value="ç‰¹ä¼‘">ç‰¹ä¼‘</option>
      <option value="ç”Ÿæ—¥å‡">ç”Ÿæ—¥å‡</option>
    </select>
    <label>è«‹å‡æ—¥æœŸ</label><input id="leaveDate" type="date"/>
    <label>è«‹å‡æ™‚æ•¸ï¼ˆå°æ™‚ï¼‰</label><input id="leaveHours" type="number" min="0.5" step="0.5" placeholder="ä¾‹å¦‚ï¼š4"/>
    <label>åŸå› èªªæ˜</label><textarea id="leaveReason" placeholder="ç°¡è¿°è«‹å‡åŸå› "></textarea>
    <div class="row" style="margin-top:10px;">
      <button id="btnLeaveApply" class="btn" disabled>é€å‡ºè«‹å‡ç”³è«‹</button>
    </div>
  </div>

  <div id="panelMine" class="card hidden">
    <h3 style="margin:0 0 8px;">ğŸ“„ æˆ‘çš„ç”³è«‹</h3>
    <div class="row">
      <button class="btn" id="btnReloadMine" disabled>é‡æ–°æ•´ç†</button>
    </div>
    <div id="mineList" class="muted" style="margin-top:10px;">å°šç„¡è³‡æ–™</div>
  </div>

  <div id="panelMgr" class="card hidden">
    <h3 style="margin:0 0 8px;">ğŸ“¥ å¾…æ ¸å‡†æ¸…å–®</h3>
    <div class="row">
      <button class="btn" id="btnReloadPending" disabled>é‡æ–°æ•´ç†</button>
    </div>
    <div id="pendingList" class="muted" style="margin-top:10px;">å°šç„¡è³‡æ–™</div>
  </div>

<script>
/* ===== è¨­å®š ===== */
const LIFF_ID = "2009036245-XmZMSuuS";
const GAS_URL = "https://script.google.com/macros/s/AKfycbz0YAlbpIYDqN6UC99TmaksEfzylud1QzuwTaupCp9zGdpUlReuRxaG8cvryxziHli_/exec";

// å…¬å¸åº§æ¨™ï¼ˆâš ï¸ ä½ è¦æ”¹æˆä½ å€‘å…¬å¸ï¼‰
const COMPANY_LAT = 25.033964;
const COMPANY_LNG = 121.564468;
const ALLOW_DISTANCE = 100;

let userId="", displayName="", ready=false, isManager=false;
let lastGPS = null; // {lat,lng,distance}

/* ===== å·¥å…· ===== */
const $ = id => document.getElementById(id);
function setStatus(msg,type="muted"){
  $("status").className="status "+(type==="ok"?"ok":type==="err"?"err":"muted");
  $("status").innerText=msg||"";
}
function enableAll(on){
  ["btnIn","btnOut","btnGPS","btnOTApply","btnLeaveApply","btnReloadMine","btnReloadPending"].forEach(id=>{
    if($(id)) $(id).disabled=!on;
  });
}
function escapeHtml_(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function traceId_(){ return "liff-"+Date.now()+"-"+Math.random().toString(16).slice(2); }

/* ===== è·é›¢è¨ˆç®—ï¼ˆå…¬å°ºï¼‰ ===== */
function calcDistance(lat1,lng1,lat2,lng2){
  const R = 6371000;
  const toRad = d=>d*Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLng = toRad(lng2-lng1);
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
    Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* ===== JSONPï¼ˆè®€/å¯«å…±ç”¨ï¼‰ ===== */
function jsonp_(paramsObj){
  return new Promise((resolve,reject)=>{
    const cb = "cb_" + Date.now() + "_" + Math.random().toString(16).slice(2);
    paramsObj.callback = cb;

    const url = GAS_URL + "?" + new URLSearchParams(paramsObj).toString();
    const script = document.createElement("script");

    window[cb] = (data)=>{
      try{ resolve(data); }
      finally{
        try{ delete window[cb]; }catch(_){}
        script.remove();
      }
    };

    script.src = url;
    script.onerror = ()=>{ try{ delete window[cb]; }catch(_){} script.remove(); reject(new Error("jsonp_failed")); };
    document.body.appendChild(script);

    setTimeout(()=>{
      if(window[cb]){
        try{ delete window[cb]; }catch(_){}
        script.remove();
        reject(new Error("jsonp_timeout"));
      }
    }, 12000);
  });
}

async function jsonpWrite_(paramsObj, okMsg){
  try{
    setStatus("é€å‡ºä¸­...");
    const data = await jsonp_(paramsObj);
    if(data?.ok){
      setStatus(okMsg,"ok");
      return true;
    }
    setStatus(data?.message || "é€å‡ºå¤±æ•—","err");
    return false;
  }catch(e){
    console.error(e);
    setStatus("é€å‡ºå¤±æ•—ï¼ˆé€£ç·š/é€¾æ™‚ï¼‰","err");
    return false;
  }
}

/* ===== GPS ===== */
async function getGPS_(){
  $("gpsHint").innerText = "å®šä½ï¼šå–å¾—ä¸­â€¦";
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation) return reject(new Error("æ­¤è£ç½®ä¸æ”¯æ´å®šä½"));
    navigator.geolocation.getCurrentPosition(
      pos=>{
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const d = calcDistance(lat,lng,COMPANY_LAT,COMPANY_LNG);
        lastGPS = {lat,lng,distance:d};
        $("gpsHint").innerText = `å®šä½ï¼šè·é›¢å…¬å¸ ${Math.round(d)} å…¬å°º`;
        if(d > ALLOW_DISTANCE) return reject(new Error(`ä¸åœ¨æ‰“å¡ç¯„åœå…§ï¼ˆ${Math.round(d)}mï¼‰`));
        resolve(lastGPS);
      },
      err=>reject(new Error("GPS å–å¾—å¤±æ•—ï¼Œè«‹é–‹å•Ÿå®šä½æ¬Šé™")),
      {enableHighAccuracy:true, timeout:12000, maximumAge:0}
    );
  });
}

/* ===== UI ===== */
function showTab(which){
  ["tabApply","tabMine","tabMgr"].forEach(id=>$(id).classList.remove("active"));
  $("tab"+which).classList.add("active");
  $("panelApply").classList.toggle("hidden", which!=="Apply");
  $("panelMine").classList.toggle("hidden", which!=="Mine");
  $("panelMgr").classList.toggle("hidden", which!=="Mgr");
}

/* ===== æ ¸å¿ƒç¶å®š ===== */
function bindCoreButtons(){
  $("tabApply").onclick = ()=>showTab("Apply");
  $("tabMine").onclick  = ()=>{ showTab("Mine"); loadMine(); };
  $("tabMgr").onclick   = ()=>{ showTab("Mgr");  loadPending(); };

  $("btnGPS").onclick = async ()=>{
    try{
      await getGPS_();
      setStatus("å®šä½å®Œæˆ âœ…","ok");
    }catch(e){
      setStatus(e.message,"err");
    }
  };

  $("btnIn").onclick  = ()=> punch_("IN");
  $("btnOut").onclick = ()=> punch_("OUT");

  $("btnOTApply").onclick    = ()=> submitOT();
  $("btnLeaveApply").onclick = ()=> submitLeave();

  $("btnReloadMine").onclick    = ()=> loadMine();
  $("btnReloadPending").onclick = ()=> loadPending();

  const refreshButtons = ()=>{
    $("btnOTApply").disabled    = !($("otDate").value && $("otHours").value);
    $("btnLeaveApply").disabled = !($("leaveDate").value && $("leaveHours").value);
  };
  ["change","keyup","input"].forEach(ev=>{
    ["otDate","otHours","otReason","leaveType","leaveDate","leaveHours","leaveReason"].forEach(id=>{
      $(id).addEventListener(ev, refreshButtons);
    });
  });
  refreshButtons();
}

/* ===== æ‰“å¡ï¼ˆGPS 100mï¼‰ ===== */
async function punch_(type){
  if(!ready) return;

  $("btnIn").disabled = $("btnOut").disabled = true;

  try{
    // å¼·åˆ¶æ¯æ¬¡æ‰“å¡é‡æ–°å–å®šä½ï¼ˆé˜²ä½œå¼Šï¼‰
    const gps = await getGPS_();

    const ok = await jsonpWrite_({
      action:"punch",
      type,
      userId,
      displayName,
      lat:gps.lat,
      lng:gps.lng,
      ts:Date.now(),
      traceId:traceId_(),
