<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HOLDON å‡ºå‹¤ç³»çµ±</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f7fa; margin: 0; padding: 0; }
    .header { background: #fff; padding: 15px; text-align: center; border-bottom: 1px solid #eee; position: relative; }
    .header h1 { font-size: 18px; margin: 0; }
    .logout { position: absolute; right: 15px; top: 15px; color: #ff3b30; font-size: 14px; text-decoration: none; }
    .progress-bar { background: #0ca5ac; color: white; padding: 10px; text-align: center; font-size: 14px; margin: 10px; border-radius: 8px; }
    .balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; }
    .bal-box { background: #fff; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .bal-label { font-size: 13px; color: #666; }
    .bal-num { font-size: 24px; font-weight: bold; color: #000; }
    .clock-section { padding: 10px; text-align: center; }
    .clock-title { font-size: 16px; color: #666; margin-bottom: 10px; }
    .clock-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btn-clock { padding: 15px; font-size: 18px; border: none; border-radius: 12px; color: white; cursor: pointer; font-weight: bold; }
    .btn-in { background: #007aff; }
    .btn-out { background: #ff9500; }
    .request-section { background: #fff; padding: 15px; margin: 10px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .request-title { font-size: 16px; margin-bottom: 10px; }
    .form-group { margin-bottom: 10px; }
    .form-label { font-size: 14px; color: #333; margin-bottom: 5px; display: block; }
    .form-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
    .btn-submit { width: 100%; background: #34c759; color: white; padding: 15px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 10px; }
  </style>
</head>
<body>

<div class="header">
  <h1>HOLDON å‡ºå‹¤ç³»çµ±</h1>
  <a href="logout.html" class="logout">ç™»å‡º</a>
</div>

<div class="progress-bar">
  <span>ğŸ“… 2025/10/17 é€²å…¥æ’ç­è¡¨</span>
</div>

<div class="balance-grid">
  <div class="bal-box">
    <div class="bal-label">ç‰¹ä¼‘å‰©é¤˜</div>
    <div class="bal-num" id="annBal">28.0 å¤©</div>
  </div>
  <div class="bal-box">
    <div class="bal-label">è£œä¼‘å‰©é¤˜</div>
    <div class="bal-num" id="compBal">0.0 æ™‚</div>
  </div>
</div>

<div class="clock-section">
  <div class="clock-title">ğŸ“ ä¸Šä¸‹ç­æ‰“å¡</div>
  <div class="clock-grid">
    <button class="btn-clock btn-in" onclick="clock('clock_in')">ä¸Šç­</button>
    <button class="btn-clock btn-out" onclick="clock('clock_out')">ä¸‹ç­</button>
  </div>
</div>

<div class="request-section">
  <div class="request-title">ğŸ–‹ æå‡ºç”³è«‹</div>
  <div class="form-group">
    <label class="form-label">é¡å‹</label>
    <select class="form-input" id="reqCategory">
      <option>è«‹å‡</option>
    </select>
  </div>
  <div class="form-group">
    <label class="form-label">å‡åˆ¥</label>
    <select class="form-input" id="leaveType">
      <option>ç‰¹ä¼‘</option>
    </select>
  </div>
  <div class="form-group">
    <label class="form-label">é–‹å§‹æ™‚é–“</label>
    <input type="datetime-local" class="form-input" id="startTime">
  </div>
  <div class="form-group">
    <label class="form-label">çµæŸæ™‚é–“</label>
    <input type="datetime-local" class="form-input" id="endTime">
  </div>
  <button class="btn-submit" onclick="submitRequest()">é€å‡ºç”³è«‹</button>
</div>

<script src="config.js"></script>
<script>
  const uid = localStorage.getItem("employeeId");
  if(!uid) location.href = 'index.html';

  let lat = '', lng = '';
  navigator.geolocation.getCurrentPosition(
    p => { lat = p.coords.latitude; lng = p.coords.longitude; },
    e => { alert('å®šä½å¤±æ•—'); }
  );

  async function init() {
    const res = await api("get_me");
    if(res.ok) {
      document.querySelector('.header h1').innerText = res.emp.name + ' (' + res.emp.id + ')';
      document.getElementById("annBal").innerText = res.balances.annual.left + ' å¤©';
      document.getElementById("compBal").innerText = res.balances.comp.left + ' æ™‚';
    }
  }

  function api(act, data = {}) {
    return new Promise(resolve => {
      const cbName = `cb_${Date.now()}_${Math.floor(Math.random()*100000)}`;
      const s = document.createElement("script");
      const payloadStr = JSON.stringify({ ...data, userId: uid });
      window[cbName] = res => { resolve(res); delete window[cbName]; s.remove(); };
      s.onerror = () => { resolve({ ok: false, message: "JSONP å¤±æ•—" }); delete window[cbName]; s.remove(); };
      s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${act}&payload=${encodeURIComponent(payloadStr)}&callback=${cbName}`;
      document.body.appendChild(s);
    });
  }

  async function clock(type) {
    if (!lat) return alert("è«‹ç­‰å¾…å®šä½");
    const res = await api(type, { lat, lng });
    alert(res.message);
  }

  async function submitRequest() {
    const category = document.getElementById("reqCategory").value;
    const leaveType = document.getElementById("leaveType").value;
    const start = document.getElementById("startTime").value;
    const end = document.getElementById("endTime").value;
    if (!start || !end) return alert("è«‹å¡«æ™‚é–“");
    const res = await api("submit_request", { category, leaveType, start, end });
    alert(res.message);
  }

  init();
</script>
</body>
</html>
