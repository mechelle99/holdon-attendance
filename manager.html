<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ä¸»ç®¡å¯©æ ¸å¾Œå°</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6f8;margin:0;padding:20px;color:#333;}
    .container{max-width:800px;margin:0 auto;}
    .btn-back{display:inline-block;padding:8px 16px;background:#333;color:#fff;text-decoration:none;border-radius:6px;margin-bottom:20px;}
    .card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);margin-bottom:20px;}
    h3{margin-top:0;border-bottom:1px solid #eee;padding-bottom:10px;}
    
    .req-item{border-bottom:1px solid #eee;padding:12px 0;display:flex;justify-content:space-between;align-items:center;}
    .req-info{font-size:14px; line-height: 1.5;}
    .req-actions button{margin-left:8px;padding:6px 12px;border:none;border-radius:4px;cursor:pointer;font-weight:bold;}
    .btn-approve{background:#28a745;color:#fff;}
    .btn-reject{background:#dc3545;color:#fff;}
    
    .tag { font-size:12px; padding:2px 6px; border-radius:4px; margin-left:5px; }
    .tag-blue { background:#e3f2fd; color:#007aff; }
    .tag-orange { background:#fff3e0; color:#ff9800; }
    .tag-purple { background:#f3e5f5; color:#7b1fa2; }

    table{width:100%;border-collapse:collapse;font-size:14px;}
    th,td{padding:10px;text-align:left;border-bottom:1px solid #eee;}
    th{background:#fafafa;}
    
    #loading{text-align:center;padding:20px;color:#666;}
  </style>
</head>
<body>

<div class="container">
  <a href="app.html" class="btn-back">â† å›åˆ°æ‰“å¡é¦–é </a>

  <div class="card">
    <h3>âš¡ å¾…å¯©æ ¸ç”³è«‹ (Pending)</h3>
    <div id="pendingList">
      <div id="loading">è¼‰å…¥ä¸­...</div>
    </div>
  </div>

  <div class="card">
    <h3>ğŸ“Š å“¡å·¥å‡å‹¤é¤˜é¡ç¸½è¦½</h3>
    <div style="overflow-x:auto;">
      <table id="statsTable">
        <thead>
          <tr>
            <th>å“¡å·¥</th>
            <th>ç‰¹ä¼‘å‰©é¤˜</th>
            <th>è£œä¼‘å‰©é¤˜</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script src="config.js"></script>
<script>
  const ENDPOINT = window.CONFIG?.GAS_ENDPOINT || "";
  const userId = localStorage.getItem("employeeId");

  if(!userId) location.href="index.html";

  function api(act, data={}){
    return new Promise((resolve, reject)=>{
      const cb = "cb"+Date.now();
      // FIX: åŠ ä¸Š webhookKeyï¼Œå¦å‰‡æœƒè¢«å¾Œç«¯æ“‹ä¸‹
      const payload = JSON.stringify({ ...data, userId, webhookKey:window.CONFIG?.WEBHOOK_KEY });
      const s = document.createElement("script");
      s.src = `${ENDPOINT}?action=${act}&payload=${encodeURIComponent(payload)}&callback=${cb}`;
      window[cb] = (res) => { resolve(res); try{delete window[cb];document.body.removeChild(s);}catch(e){} };
      s.onerror = () => reject("é€£ç·šå¤±æ•—");
      document.body.appendChild(s);
    });
  }

  async function loadData(){
    try {
      // 1. è¼‰å…¥å¾…å¯©æ ¸
      const pRes = await api("get_pending");
      const pDiv = document.getElementById("pendingList");
      pDiv.innerHTML = "";
      
      if(pRes.ok && pRes.list && pRes.list.length > 0) {
        pRes.list.forEach(r => {
          const div = document.createElement("div");
          div.className = "req-item";
          
          const name = r.empName || "æœªçŸ¥";
          const reqId = r.reqId;
          const typeMap = { 'annual':'ç‰¹ä¼‘', 'comp':'è£œä¼‘', 'sick':'ç—…å‡', 'personal':'äº‹å‡', 'menstrual':'ç”Ÿç†å‡', 'family':'å®¶åº­ç…§é¡§å‡', 'wedding':'å©šå‡', 'funeral':'å–ªå‡', 'maternity':'ç”¢å‡', 'birthday':'ç”Ÿæ—¥å‡' };
          
          let typeStr = typeMap[r.leaveType] || r.leaveType || "";
          let catStr = "";
          let tagClass = "tag-blue";

          if(r.category === 'OT') {
             catStr = "åŠ ç­/è£œä¼‘ç”³è«‹";
             tagClass = "tag-purple";
             typeStr = ""; // åŠ ç­é€šå¸¸ä¸é¡¯ç¤ºå‡åˆ¥ï¼Œæˆ–é¡¯ç¤ºç‚ºè£œä¼‘ç´¯è¨ˆ
          } else if(r.category === 'OUTING') {
             catStr = "å¤–å‡º";
          } else if(r.category === 'CORRECTION') {
             catStr = "è£œå¡";
             tagClass = "tag-orange";
             typeStr = (r.leaveType === 'IN' ? 'ä¸Šç­å¡' : 'ä¸‹ç­å¡');
          } else {
             catStr = "è«‹å‡";
          }

          const start = r.start ? r.start.substring(5,16).replace('T',' ') : '';
          const end = r.end ? r.end.substring(5,16).replace('T',' ') : '';

          div.innerHTML = `
            <div class="req-info">
              <strong>${name}</strong> <span class="tag ${tagClass}">${catStr}</span> ${typeStr ? '<span class="tag tag-orange">'+typeStr+'</span>' : ''}<br>
              <span style="color:#666;font-size:12px">
                ${start} ~ ${end}<br>
                æ™‚æ•¸: ${r.hours}h / äº‹ç”±: ${r.reason || 'ç„¡'}
              </span>
            </div>
            <div class="req-actions">
              <button class="btn-approve" onclick="decide('${reqId}', 'APPROVED')">å‡†</button>
              <button class="btn-reject" onclick="decide('${reqId}', 'REJECTED')">é§</button>
            </div>
          `;
          pDiv.appendChild(div);
        });
      } else {
        pDiv.innerHTML = '<div style="padding:10px;color:#999">ç›®å‰æ²’æœ‰å¾…å¯©æ ¸é …ç›®</div>';
      }

      // 2. è¼‰å…¥å“¡å·¥é¤˜é¡
      const sRes = await api("get_team_stats");
      const tbody = document.querySelector("#statsTable tbody");
      tbody.innerHTML = "";
      
      if(sRes.ok && sRes.list) {
        sRes.list.forEach(e => {
          const tr = document.createElement("tr");
          // ç¢ºä¿æ•¸å€¼å­˜åœ¨ï¼Œè‹¥ç„¡å‰‡é¡¯ç¤º 0
          const ann = (e.annual && e.annual.left) ? e.annual.left : "0";
          const comp = (e.comp && e.comp.left) ? e.comp.left : "0";
          
          tr.innerHTML = `<td>${e.name} (${e.id})</td><td>${ann} å¤©</td><td>${comp} æ™‚</td>`;
          tbody.appendChild(tr);
        });
      }
    } catch(e) { 
        alert("è¼‰å…¥å¤±æ•—: " + e); 
        document.getElementById("pendingList").innerHTML = "è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯æˆ–é‡æ–°ç™»å…¥";
    }
  }

  async function decide(reqId, decision) {
    if(!reqId || reqId === 'undefined') { alert("éŒ¯èª¤ï¼šç”³è«‹å–®ç·¨è™Ÿç„¡æ•ˆ"); return; }
    if(!confirm(decision==='APPROVED'?"ç¢ºå®šæ ¸å‡†ï¼Ÿ":"ç¢ºå®šé§å›ï¼Ÿ")) return;
    try {
        const res = await api("review_request", { data: { reqId, decision } });
        if(res.ok) {
            alert("âœ… æ“ä½œæˆåŠŸ");
            loadData();
        } else {
            alert("âŒ å¤±æ•—: " + res.message);
        }
    } catch(e) { alert("é€£ç·šéŒ¯èª¤: " + e); }
  }

  loadData();
</script>
</body>
</html>
