<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>ç”³è«‹ä½œæ¥­</title>
  <style>
    /* æ²¿ç”¨ app.html çš„ root è®Šæ•¸ï¼Œä¿æŒä¸€è‡´æ€§ */
    :root { --primary: #2563eb; --bg: #f3f4f6; --surface: #ffffff; --text: #1f2937; --shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    body { font-family: -apple-system, sans-serif; background: var(--bg); padding: 20px 20px 100px 20px; color: var(--text); }
    
    .header { margin-bottom: 20px; display: flex; align-items: center; justify-content: space-between; }
    h2 { margin: 0; font-size: 24px; color: var(--text); }
    
    .card { background: var(--surface); border-radius: 20px; padding: 24px; box-shadow: var(--shadow); }
    
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #4b5563; }
    
    select, input, textarea {
      width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 12px;
      font-size: 16px; background: #f9fafb; transition: all 0.2s; outline: none;
      -webkit-appearance: none; /* ç§»é™¤ iOS é è¨­æ¨£å¼ */
    }
    select:focus, input:focus, textarea:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
    
    .btn-submit {
      width: 100%; background: var(--primary); color: white; padding: 16px; border: none; border-radius: 16px;
      font-size: 16px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 12px rgba(37,99,235,0.3);
      transition: transform 0.1s; margin-top: 10px;
    }
    .btn-submit:active { transform: scale(0.98); }

    /* åº•éƒ¨å°èˆª (è¤‡è£½è‡ª app.html) */
    .bottom-nav { position: fixed; bottom: 20px; left: 20px; right: 20px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 24px; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); z-index: 100; border: 1px solid rgba(255,255,255,0.5); }
    .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #9ca3af; text-decoration: none; font-size: 10px; font-weight: 600; }
    .nav-item.active { color: var(--primary); }
    .nav-icon { font-size: 20px; }
  </style>
</head>
<body>

<div class="header">
  <h2>ğŸ“ æå‡ºç”³è«‹</h2>
</div>

<div class="card">
  <div class="form-group">
    <label>ç”³è«‹é¡åˆ¥</label>
    <select id="cat" onchange="uiChange()">
      <option value="LEAVE">è«‹å‡</option>
      <option value="OT">åŠ ç­</option>
      <option value="CORRECTION">è£œå¡</option>
      <option value="OUTING">å¤–å‡º (è‡ªå‹•æ‰“å¡)</option>
    </select>
  </div>

  <div class="form-group" id="typeGrp">
    <label>å‡åˆ¥é¡å‹</label>
    <select id="type">
      <option value="annual">ç‰¹ä¼‘</option>
      <option value="comp">è£œä¼‘</option>
      <option value="sick">ç—…å‡</option>
      <option value="personal">äº‹å‡</option>
      <option value="official">å…¬å‡</option>
    </select>
  </div>

  <div class="form-group">
    <label id="startLbl">é–‹å§‹æ™‚é–“</label>
    <input type="datetime-local" id="start">
  </div>

  <div class="form-group" id="endGrp">
    <label>çµæŸæ™‚é–“</label>
    <input type="datetime-local" id="end" onchange="calcHours()">
  </div>
  
  <div class="form-group" id="hrsGrp">
    <label>æ™‚æ•¸ (è‡ªå‹•è¨ˆç®—)</label>
    <input type="number" id="hours" step="0.5" readonly style="background:#e5e7eb">
  </div>

  <div class="form-group">
    <label>äº‹ç”±èªªæ˜</label>
    <textarea id="reason" rows="3" placeholder="è«‹å¡«å¯«åŸå› ..."></textarea>
  </div>

  <button class="btn-submit" onclick="submit()">é€å‡ºç”³è«‹</button>
</div>

<nav class="bottom-nav">
  <a href="app.html" class="nav-item"><span class="nav-icon">ğŸ </span><span>é¦–é </span></a>
  <a href="request.html" class="nav-item active"><span class="nav-icon">ğŸ“</span><span>ç”³è«‹</span></a>
  <a href="history.html" class="nav-item"><span class="nav-icon">ğŸ“‹</span><span>ç´€éŒ„</span></a>
  <a href="schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span><span>æ’ç­</span></a>
  <a href="manager.html" class="nav-item" id="mgrBtn" style="display:none"><span class="nav-icon">ğŸ‘‘</span><span>ä¸»ç®¡</span></a>
</nav>

<script src="config.js"></script>
<script>
  const uid = localStorage.getItem("employeeId");
  const isMgr = localStorage.getItem("isManager") === "true";
  if(isMgr) document.getElementById("mgrBtn").style.display = 'flex';

  function uiChange() {
      const c = document.getElementById("cat").value;
      const type = document.getElementById("type");
      const end = document.getElementById("endGrp");
      const hrs = document.getElementById("hrsGrp");
      const lbl = document.getElementById("startLbl");
      
      document.getElementById("typeGrp").style.display = 'block';
      end.style.display = 'block';
      hrs.style.display = 'block';
      lbl.innerText = 'é–‹å§‹æ™‚é–“';

      if(c === 'CORRECTION') {
          end.style.display = 'none'; 
          hrs.style.display = 'none';
          lbl.innerText = 'è£œå¡æ™‚é–“ (è«‹é¸æ­£ç¢ºæ™‚é–“)';
          document.getElementById("typeGrp").style.display = 'none'; // è£œå¡ä¸éœ€é¸å‡åˆ¥
      } else if(c === 'OUTING') {
          document.getElementById("typeGrp").style.display = 'none';
          end.style.display = 'none';
          hrs.style.display = 'none';
          lbl.innerText = 'å¤–å‡ºæ™‚é–“ (é è¨­ç¾åœ¨)';
      } else if(c === 'OT') {
          document.getElementById("typeGrp").style.display = 'none';
      } else {
          // Leave
          type.innerHTML = '<option value="annual">ç‰¹ä¼‘</option><option value="comp">è£œä¼‘</option><option value="sick">ç—…å‡</option><option value="personal">äº‹å‡</option><option value="official">å…¬å‡</option>';
      }
  }

  function calcHours() {
      const s = new Date(document.getElementById("start").value);
      const e = new Date(document.getElementById("end").value);
      if(s && e && e > s) {
          document.getElementById("hours").value = ((e - s) / 36e5).toFixed(1);
      }
  }

  function api(act, d={}) {
    return new Promise(r => {
      const s = document.createElement("script");
      s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${act}&payload=${encodeURIComponent(JSON.stringify({...d, userId:uid}))}&callback=cb${Date.now()}`;
      window[`cb${Date.now()}`] = (res) => { r(res); s.remove(); };
      document.body.appendChild(s);
    });
  }

  async function submit() {
      const cat = document.getElementById("cat").value;
      const start = document.getElementById("start").value;
      if(cat !== 'OUTING' && !start) { alert("è«‹å¡«å¯«æ™‚é–“"); return; }

      const btn = document.querySelector(".btn-submit");
      btn.innerText = "é€å‡ºä¸­..."; btn.disabled = true;

      const res = await api("submit_request", {
          category: cat,
          leaveType: document.getElementById("type").value,
          start: start,
          end: document.getElementById("end").value || start,
          hours: document.getElementById("hours").value || 0,
          reason: document.getElementById("reason").value
      });
      alert(res.message);
      location.href='history.html'; // é€å‡ºå¾Œå»ç´€éŒ„é 
  }
  
  uiChange();
</script>
</body>
</html>
