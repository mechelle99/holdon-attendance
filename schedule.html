<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no"/>
  <title>團隊排班</title>

  <!-- 主管模式（你原本就有） -->
  <script>
    if (localStorage.getItem("isManager") === "true") {
      document.documentElement.classList.add("is-mgr");
    }
  </script>

  <style>
    :root{
      --primary:#4F46E5;
      --primary2:#7C3AED;
      --bg:#F3F4F6;
      --card:#FFFFFF;
      --text:#111827;
      --muted:#6B7280;
      --bd:rgba(17,24,39,.10);
      --shadow: 0 10px 26px rgba(17,24,39,.10);
      --shadow2: 0 6px 16px rgba(17,24,39,.06);
      --ok:#10B981;
      --warn:#F59E0B;
      --danger:#EF4444;
      --radius:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;
      background:var(--bg);
      color:var(--text);
      padding: 16px 16px 90px;
    }
    .wrap{ max-width:1100px; margin:0 auto; }
    .topbar{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:12px;
    }
    h1{
      margin:0;
      font-size:20px;
      letter-spacing:.2px;
    }
    .sub{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
    }
    .card{
      background:var(--card);
      border:1px solid var(--bd);
      border-radius:var(--radius);
      box-shadow:var(--shadow2);
    }
    .controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      padding:12px;
    }
    .btn{
      appearance:none;
      border:1px solid rgba(17,24,39,.14);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 2px 10px rgba(17,24,39,.06);
    }
    .btn.primary{
      border:1px solid rgba(79,70,229,.25);
      background: linear-gradient(135deg, rgba(79,70,229,.14), rgba(124,58,237,.12));
    }
    .btn.danger{
      border:1px solid rgba(239,68,68,.28);
      background: rgba(239,68,68,.08);
    }
    .btn:disabled{
      opacity:.55; cursor:not-allowed;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(17,24,39,.12);
      background: rgba(255,255,255,.75);
      font-weight:700;
    }
    .chip small{
      font-weight:600;
      color:var(--muted);
    }
    .select, .input{
      border:1px solid rgba(17,24,39,.14);
      background:#fff;
      border-radius:14px;
      padding:10px 12px;
      font-weight:700;
      outline:none;
      min-height:40px;
    }
    .grow{ flex:1; min-width: 180px; }
    .statusbar{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(17,24,39,.10);
      background: rgba(255,255,255,.75);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      color:var(--muted);
    }

    /* ✅ 本月可休天數 bar（你要的） */
    #restDaysBar{
      margin:10px 12px 0;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(79,70,229,.08);
      border:1px solid rgba(79,70,229,.18);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    #restDaysBar .left{
      font-weight:800;
    }
    #restDaysBar .right{
      font-size:12px;
      opacity:.85;
      white-space:nowrap;
    }

    /* 排班表 */
    .tableWrap{ padding:12px; overflow:auto; }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width: 720px;
      overflow:hidden;
      border-radius:16px;
      border:1px solid rgba(17,24,39,.10);
    }
    thead th{
      position:sticky;
      top:0;
      background: linear-gradient(180deg, #fff, rgba(255,255,255,.92));
      border-bottom:1px solid rgba(17,24,39,.10);
      font-size:12px;
      color:var(--muted);
      padding:10px 8px;
      text-align:center;
      z-index:2;
      backdrop-filter: blur(6px);
    }
    thead th:first-child{
      text-align:left;
      padding-left:12px;
      min-width:140px;
      z-index:3;
      left:0;
      position:sticky;
      background: linear-gradient(180deg, #fff, rgba(255,255,255,.94));
    }
    tbody td, tbody th{
      border-bottom:1px solid rgba(17,24,39,.08);
      padding:8px 8px;
      font-size:13px;
      text-align:center;
      background:#fff;
    }
    tbody th{
      position:sticky;
      left:0;
      text-align:left;
      padding-left:12px;
      font-size:13px;
      background: linear-gradient(180deg, #fff, rgba(255,255,255,.94));
      z-index:1;
      min-width:140px;
    }

    .cell{
      border-radius:12px;
      border:1px solid rgba(17,24,39,.10);
      padding:8px 6px;
      min-width:44px;
      font-weight:800;
      cursor:default;
      user-select:none;
      background: rgba(17,24,39,.02);
    }
    html.is-mgr .cell{
      cursor:pointer;
    }
    .cell.off{ background: rgba(16,185,129,.10); border-color: rgba(16,185,129,.22); }
    .cell.work{ background: rgba(79,70,229,.10); border-color: rgba(79,70,229,.22); }
    .cell.blank{ background: rgba(17,24,39,.02); border-color: rgba(17,24,39,.10); font-weight:700; color:rgba(17,24,39,.55); }

    .hintRow{
      margin-top:10px;
      padding:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .legend{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      font-size:12px; color:var(--muted);
    }
    .dot{
      width:10px; height:10px; border-radius:999px; display:inline-block; margin-right:6px;
      border:1px solid rgba(17,24,39,.14);
    }
    .dot.off{ background: rgba(16,185,129,.25); border-color: rgba(16,185,129,.35); }
    .dot.work{ background: rgba(79,70,229,.22); border-color: rgba(79,70,229,.32); }

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(17,24,39,.92);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      max-width:min(560px, calc(100vw - 24px));
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
      opacity:0; pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-6px);
    }

    @media (max-width:520px){
      body{ padding:14px 14px 88px; }
      thead th:first-child, tbody th{ min-width:120px; }
      #restDaysBar{ margin:10px 12px 0; flex-direction:column; align-items:flex-start; }
      #restDaysBar .right{ white-space:normal; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>團隊排班</h1>
        <div class="sub">
          主管可編輯；員工僅檢視。<span style="font-weight:800;">本月可休天數</span>會自動計算（週末＋國定假日）。
        </div>
      </div>
      <div class="chip">
        <span id="modeText">Employee</span>
        <small id="userHint">—</small>
      </div>
    </div>

    <div class="card">
      <div class="controls">
        <button class="btn" id="btnPrev">← 上個月</button>

        <div class="chip">
          <span id="monthLabel">—</span>
          <small>排班月</small>
        </div>

        <button class="btn" id="btnNext">下個月 →</button>

        <button class="btn primary" id="btnReload">重新載入</button>

        <div class="grow"></div>

        <select class="select" id="viewSelect" title="顯示方式">
          <option value="team">全員</option>
          <option value="me">只看我</option>
        </select>

        <button class="btn danger" id="btnLogout">登出</button>
      </div>

      <!-- ✅ 本月可休天數（你要的） -->
      <div id="restDaysBar">
        <div class="left">本月可休天數：<span id="restDaysValue">—</span> 天</div>
        <div class="right">週末 <span id="restWeekend">—</span> 天 / 國定假日額外 <span id="restHolidayExtra">—</span> 天</div>
      </div>

      <div class="statusbar">
        <div id="statusText">尚未載入</div>
        <div id="syncText">—</div>
      </div>

      <div class="tableWrap">
        <table id="rosterTable" aria-label="排班表">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>

        <div class="hintRow">
          <div class="legend">
            <span><i class="dot work"></i>上班</span>
            <span><i class="dot off"></i>休假</span>
          </div>
          <div style="font-size:12px;color:var(--muted);">
            主管：點格子切換（上班/休假/清空）。員工：只讀。
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* =========================
   ✅ 你只要改這裡
========================= */
const GAS_URL = "PASTE_YOUR_GAS_EXEC_URL_HERE"; // 例如：https://script.google.com/macros/s/xxxx/exec

/* =========================
   基礎工具
========================= */
const $ = (id)=>document.getElementById(id);

function pad2(n){ return String(n).padStart(2,'0'); }
function fmtYM(y,m){ return `${y}-${pad2(m)}`; }
function toast(msg){
  const el = $('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>el.classList.remove('show'), 1600);
}

function getAuth_(){
  // 你原系統可能用 token / empId / lineUserId
  // 我這邊用 localStorage 撈，沒有就照樣送，讓後端決定要不要擋
  return {
    empId: localStorage.getItem('empId') || "",
    token: localStorage.getItem('token') || "",
    lineUserId: localStorage.getItem('lineUserId') || ""
  };
}

async function api(action, payload={}){
  if(!GAS_URL || GAS_URL.includes("PASTE_YOUR")){
    throw new Error("GAS_URL 未設定");
  }
  const body = { action, ...payload, ...getAuth_() };

  const res = await fetch(GAS_URL, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify(body)
  });
  const data = await res.json().catch(()=> ({}));
  if(!data || data.ok !== true){
    const msg = (data && (data.message || data.error)) ? (data.message || data.error) : "API 失敗";
    throw new Error(msg);
  }
  return data;
}

/* =========================
   狀態與月份
========================= */
let state = {
  year: new Date().getFullYear(),
  month: new Date().getMonth() + 1,
  view: 'team', // team | me
  roster: null,
  isManager: (localStorage.getItem("isManager") === "true"),
};

function setHeaderInfo_(){
  $('modeText').textContent = state.isManager ? "Manager" : "Employee";
  $('userHint').textContent = localStorage.getItem('empName') || localStorage.getItem('empId') || "—";
  $('monthLabel').textContent = fmtYM(state.year, state.month);
  $('monthLabel').style.color = state.isManager ? "var(--primary)" : "var(--text)";
  $('monthLabel').style.fontWeight = "900";
  $('monthLabel').style.letterSpacing = ".2px";
  $('monthLabel').style.fontSize = "14px";
  $('monthLabel').style.padding = "0 2px";
  $('monthLabel').style.display = "inline-block";

  $('monthLabel').parentElement?.querySelector('small')?.setAttribute('aria-label', '排班月');
  document.title = `團隊排班 ${fmtYM(state.year, state.month)}`;
}

function daysInMonth(y,m){
  return new Date(y, m, 0).getDate();
}

/* =========================
   ✅ 本月可休天數 render（你要的）
========================= */
function renderRestDays_(res){
  const vEl = $('restDaysValue');
  const wEl = $('restWeekend');
  const hEl = $('restHolidayExtra');
  if(!vEl) return;

  // 先吃扁平欄位（最穩）
  let total = (res && typeof res.totalOffDays === 'number') ? res.totalOffDays : null;
  let weekend = (res && typeof res.weekendDays === 'number') ? res.weekendDays : null;
  let holidayExtra = (res && typeof res.holidayExtra === 'number') ? res.holidayExtra : null;

  // fallback：吃 res.restDays
  if(total === null && res && res.restDays && res.restDays.ok){
    total = Number(res.restDays.totalOffDays);
    weekend = Number(res.restDays.weekendDays);
    holidayExtra = Number(res.restDays.holidayExtra);
  }

  vEl.textContent = (typeof total === 'number' && isFinite(total)) ? String(total) : '—';
  wEl.textContent = (typeof weekend === 'number' && isFinite(weekend)) ? String(weekend) : '—';
  hEl.textContent = (typeof holidayExtra === 'number' && isFinite(holidayExtra)) ? String(holidayExtra) : '—';
}

/* =========================
   排班資料結構假設（可兼容）
   後端回傳建議格式：
   {
     ok:true,
     year, month,
     employees:[{empId, empName}],
     days:[1..n],
     schedule: { [empId]: { [day]: "W"|"O"|"" } }
     // plus: totalOffDays / weekendDays / holidayExtra 或 restDays.*
   }
========================= */
function normalizeRoster_(res){
  const y = Number(res.year || state.year);
  const m = Number(res.month || state.month);
  const dim = daysInMonth(y,m);

  const employees = Array.isArray(res.employees) ? res.employees : [];
  const schedule = (res.schedule && typeof res.schedule === 'object') ? res.schedule : {};

  // 若後端給的是 rows 格式，也試著轉
  // rows: [{ empId, empName, d1:"W", d2:"O", ... }]
  if(!employees.length && Array.isArray(res.rows)){
    const rows = res.rows;
    const emps = [];
    const sch = {};
    for(const r of rows){
      const empId = String(r.empId || r.id || "");
      const empName = String(r.empName || r.name || empId);
      if(!empId) continue;
      emps.push({ empId, empName });
      sch[empId] = {};
      for(let d=1; d<=dim; d++){
        const key = "d"+d;
        const v = (r[key] ?? r[d] ?? "");
        sch[empId][d] = String(v || "");
      }
    }
    return { year:y, month:m, dim, employees:emps, schedule:sch };
  }

  // 有 employees 但 schedule 缺日子，也補空
  for(const e of employees){
    const empId = String(e.empId || e.id || "");
    if(!empId) continue;
    if(!schedule[empId]) schedule[empId] = {};
    for(let d=1; d<=dim; d++){
      if(typeof schedule[empId][d] === 'undefined') schedule[empId][d] = "";
    }
  }

  return { year:y, month:m, dim, employees, schedule };
}

/* =========================
   畫表格
========================= */
function buildThead_(y,m,dim){
  const tr = document.createElement('tr');
  const th0 = document.createElement('th');
  th0.textContent = "員工";
  tr.appendChild(th0);

  for(let d=1; d<=dim; d++){
    const th = document.createElement('th');
    const wd = new Date(y, m-1, d).getDay(); // 0 Sun
    const label = `${d}`;
    th.textContent = label;

    // 週末淡提示
    if(wd === 0 || wd === 6){
      th.style.color = "rgba(79,70,229,.95)";
      th.style.fontWeight = "900";
    }
    tr.appendChild(th);
  }

  const thead = $('thead');
  thead.innerHTML = '';
  thead.appendChild(tr);
}

function cellClass_(v){
  const s = String(v || "").toUpperCase();
  if(s === "O" || s === "OFF" || s === "休") return "cell off";
  if(s === "W" || s === "WORK" || s === "班" || s === "上") return "cell work";
  if(!s) return "cell blank";
  return "cell";
}

function cellLabel_(v){
  const s = String(v || "").toUpperCase();
  if(s === "O" || s === "OFF" || s === "休") return "休";
  if(s === "W" || s === "WORK" || s === "班" || s === "上") return "班";
  if(!s) return "";
  return v;
}

function nextValue_(v){
  // 主管點格子切換：空 -> 班(W) -> 休(O) -> 空
  const s = String(v || "").toUpperCase();
  if(!s) return "W";
  if(s === "W" || s === "WORK" || s === "班" || s === "上") return "O";
  if(s === "O" || s === "OFF" || s === "休") return "";
  return "";
}

function renderTable_(roster){
  const {year:y, month:m, dim, employees, schedule} = roster;

  buildThead_(y,m,dim);

  const tbody = $('tbody');
  tbody.innerHTML = '';

  const view = state.view;
  const myEmpId = localStorage.getItem('empId') || "";

  const list = (view === 'me' && myEmpId)
    ? employees.filter(e => String(e.empId||"") === String(myEmpId))
    : employees;

  if(!list.length){
    const tr = document.createElement('tr');
    const td = document.createElement('td');
    td.colSpan = dim + 1;
    td.style.textAlign = "center";
    td.style.padding = "18px 12px";
    td.style.color = "var(--muted)";
    td.textContent = "沒有員工資料 / 後端回傳格式不符";
    tr.appendChild(td);
    tbody.appendChild(tr);
    return;
  }

  for(const e of list){
    const empId = String(e.empId || e.id || "");
    const empName = String(e.empName || e.name || empId);

    const tr = document.createElement('tr');

    const th = document.createElement('th');
    th.textContent = empName;
    tr.appendChild(th);

    for(let d=1; d<=dim; d++){
      const td = document.createElement('td');
      const v = schedule?.[empId]?.[d] ?? "";
      const div = document.createElement('div');
      div.className = cellClass_(v);
      div.textContent = cellLabel_(v);

      div.dataset.empId = empId;
      div.dataset.day = String(d);
      div.dataset.value = String(v || "");

      // 主管可點擊
      if(state.isManager){
        div.addEventListener('click', async ()=>{
          await onCellToggle_(div);
        });
      }

      td.appendChild(div);
      tr.appendChild(td);
    }

    tbody.appendChild(tr);
  }
}

/* =========================
   主管改排班（點一下切換）
   你後端 action 若不同，改這裡 action 名稱即可
========================= */
async function onCellToggle_(cellEl){
  const empId = cellEl.dataset.empId;
  const day = Number(cellEl.dataset.day);
  const oldV = cellEl.dataset.value || "";
  const newV = nextValue_(oldV);

  // optimistic UI
  cellEl.dataset.value = newV;
  cellEl.className = cellClass_(newV);
  cellEl.textContent = cellLabel_(newV);

  $('syncText').textContent = "同步中…";

  try{
    // ✅ 你後端若不是這個 action，改字串即可：
    // action: "update_schedule_cell"
    // payload: {year, month, empId, day, value}
    const res = await api("update_schedule_cell", {
      year: state.year,
      month: state.month,
      empId,
      day,
      value: newV
    });

    $('syncText').textContent = "已同步";
    toast("已更新");
  }catch(err){
    // rollback
    cellEl.dataset.value = oldV;
    cellEl.className = cellClass_(oldV);
    cellEl.textContent = cellLabel_(oldV);
    $('syncText').textContent = "同步失敗";
    toast("同步失敗：" + err.message);
  }
}

/* =========================
   讀取排班（你後端 action 若不同改這裡）
========================= */
async function loadRoster_(){
  setHeaderInfo_();
  $('statusText').textContent = "載入中…";
  $('syncText').textContent = "—";

  try{
    // ✅ 你後端若不是 get_roster_data，改字串即可
    const res = await api("get_roster_data", {
      year: state.year,
      month: state.month
    });

    // ✅ 顯示本月可休天數
    renderRestDays_(res);

    const roster = normalizeRoster_(res);
    state.roster = roster;

    renderTable_(roster);
    $('statusText').textContent = `已載入 ${fmtYM(roster.year, roster.month)}（${roster.employees.length} 人）`;
    $('syncText').textContent = "—";
  }catch(err){
    $('statusText').textContent = "載入失敗：" + err.message;
    $('syncText').textContent = "—";
    $('thead').innerHTML = '';
    $('tbody').innerHTML = `<tr><td colspan="32" style="text-align:center;padding:18px 12px;color:var(--muted);">
      載入失敗：${escapeHtml_(err.message)}
      <div style="margin-top:8px;font-size:12px;">請確認 GAS_URL、action 名稱、以及後端是否允許 POST JSON。</div>
    </td></tr>`;
    toast("載入失敗");
  }
}

function escapeHtml_(s){
  return String(s||"").replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

/* =========================
   UI 綁定
========================= */
function shiftMonth_(delta){
  let y = state.year, m = state.month + delta;
  if(m <= 0){ m = 12; y--; }
  if(m >= 13){ m = 1; y++; }
  state.year = y; state.month = m;
}

$('btnPrev').addEventListener('click', async ()=>{
  shiftMonth_(-1);
  await loadRoster_();
});
$('btnNext').addEventListener('click', async ()=>{
  shiftMonth_(+1);
  await loadRoster_();
});
$('btnReload').addEventListener('click', async ()=>{
  await loadRoster_();
});
$('viewSelect').addEventListener('change', ()=>{
  state.view = $('viewSelect').value;
  if(state.roster) renderTable_(state.roster);
});
$('btnLogout').addEventListener('click', ()=>{
  // 依你原本系統的登出規則：清 localStorage
  const keep = ['isManager']; // 你要保留主管標記就留，不要就清掉
  const saved = {};
  for(const k of keep){ saved[k] = localStorage.getItem(k); }
  localStorage.clear();
  for(const k of keep){ if(saved[k] != null) localStorage.setItem(k, saved[k]); }
  toast("已登出");
  setTimeout(()=>location.href="index.html", 400);
});

/* =========================
   初始化
========================= */
(function init(){
  // 如果你希望預設不要現在月份，而是讀後端 config 的預設月份，也可以在這裡改
  setHeaderInfo_();
  loadRoster_();
})();
</script>
</body>
</html>
