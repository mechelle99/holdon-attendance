<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>å“¡å·¥ç³»çµ±</title>
  <style>
    :root {
      --primary: #007aff;
      --bg: #f2f4f8;
      --card: #ffffff;
      --text-main: #1c1c1e;
      --text-sub: #8e8e93;
      --green-grad: linear-gradient(135deg, #34c759, #30d158);
      --orange-grad: linear-gradient(135deg, #ff9500, #ff9f0a);
      --blue-grad: linear-gradient(135deg, #007aff, #0a84ff);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      margin: 0;
      padding: 20px;
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
    }

    /* é ‚éƒ¨ Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 0 5px;
    }
    .user-info { font-size: 22px; font-weight: 800; color: var(--text-main); }
    .user-info span { color: var(--primary); }
    
    .btn-logout {
      font-size: 13px;
      color: var(--text-sub);
      background: rgba(0,0,0,0.05);
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-logout:active { background: rgba(0,0,0,0.1); }

    /* é¤˜é¡å„€è¡¨æ¿å¡ç‰‡ */
    .dashboard-card {
      background: var(--card);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.04);
      margin-bottom: 25px;
      display: flex;
      justify-content: space-around;
      align-items: center;
    }
    
    .balance-item {
      text-align: center;
      flex: 1;
      position: relative;
    }
    .balance-item:first-child::after {
      content: '';
      position: absolute;
      right: 0;
      top: 10%;
      height: 80%;
      width: 1px;
      background: #eee;
    }
    
    .bal-value {
      font-size: 28px;
      font-weight: 800;
      color: var(--text-main);
      line-height: 1.2;
    }
    .bal-label {
      font-size: 13px;
      color: var(--text-sub);
      margin-top: 4px;
      font-weight: 500;
    }

    /* GPS ç‹€æ…‹æ¢ */
    .gps-bar {
      text-align: center;
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 15px;
      background: rgba(255,255,255,0.6);
      padding: 6px;
      border-radius: 12px;
      display: inline-block;
      width: 100%;
      box-sizing: border-box;
    }

    /* æ‰“å¡æŒ‰éˆ•å€ */
    .clock-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .clock-btn {
      border: none;
      border-radius: 24px;
      padding: 25px 15px;
      color: white;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      transition: transform 0.1s, filter 0.2s;
      outline: none;
    }
    .clock-btn:active { transform: scale(0.96); filter: brightness(0.9); }
    
    .clock-in { background: var(--green-grad); box-shadow: 0 8px 20px rgba(52, 199, 89, 0.3); }
    .clock-out { background: var(--orange-grad); box-shadow: 0 8px 20px rgba(255, 149, 0, 0.3); }
    
    .clock-icon { font-size: 32px; }

    /* åŠŸèƒ½é¸å–®æ¨™é¡Œ */
    .section-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-sub);
      margin-bottom: 12px;
      padding-left: 5px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* åŠŸèƒ½é¸å–® Grid */
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr); /* ä¸€è¡Œä¸‰å€‹ */
      gap: 12px;
    }

    .menu-item {
      background: var(--card);
      border-radius: 16px;
      padding: 15px 10px;
      text-align: center;
      text-decoration: none;
      color: var(--text-main);
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
      transition: transform 0.1s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .menu-item:active { transform: scale(0.96); background: #fafafa; }

    .menu-icon {
      font-size: 24px;
      background: #f2f4f8;
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .menu-text { font-size: 13px; font-weight: 600; }

    /* ä¸»ç®¡æŒ‰éˆ•ç‰¹åˆ¥æ¨£å¼ */
    .menu-item.manager {
      background: #eef7ff;
      color: var(--primary);
    }
    .menu-item.manager .menu-icon {
      background: #fff;
      color: var(--primary);
    }

  </style>
</head>
<body>

  <div class="header">
    <div class="user-info">Hi, <span id="uName">...</span></div>
    <div class="btn-logout" onclick="logout()">ç™»å‡º</div>
  </div>

  <div class="dashboard-card">
    <div class="balance-item">
      <div class="bal-value" id="annBal">--</div>
      <div class="bal-label">ç‰¹ä¼‘é¤˜é¡</div>
    </div>
    <div class="balance-item">
      <div class="bal-value" id="compBal">--</div>
      <div class="bal-label">è£œä¼‘é¤˜é¡</div>
    </div>
  </div>

  <div class="gps-bar" id="gpsStatus">
    <span style="animation: blink 1.5s infinite;">ğŸ“¡</span> GPS å®šä½ä¸­...
  </div>

  <div class="clock-section">
    <button class="clock-btn clock-in" onclick="clock('clock_in')">
      <span class="clock-icon">â˜€ï¸</span>
      <span>ä¸Šç­æ‰“å¡</span>
    </button>
    <button class="clock-btn clock-out" onclick="clock('clock_out')">
      <span class="clock-icon">ğŸŒ™</span>
      <span>ä¸‹ç­æ‰“å¡</span>
    </button>
  </div>

  <div class="section-title">åŠŸèƒ½èˆ‡æœå‹™</div>
  <div class="menu-grid">
    <a href="request.html" class="menu-item">
      <div class="menu-icon">ğŸ“</div>
      <div class="menu-text">æå‡ºç”³è«‹</div>
    </a>
    <a href="history.html" class="menu-item">
      <div class="menu-icon">ğŸ“‹</div>
      <div class="menu-text">ç”³è«‹ç´€éŒ„</div>
    </a>
    <a href="attendance.html" class="menu-item">
      <div class="menu-icon">ğŸ“…</div>
      <div class="menu-text">å‡ºå‹¤ç´€éŒ„</div>
    </a>
    <a href="schedule.html" class="menu-item">
      <div class="menu-icon">ğŸ“Š</div>
      <div class="menu-text">æ’ç­è¡¨</div>
    </a>
    <a href="manager.html" class="menu-item manager" id="mgrBtn" style="display:none;">
      <div class="menu-icon">ğŸ‘¨â€ğŸ’¼</div>
      <div class="menu-text">ä¸»ç®¡å°ˆå€</div>
    </a>
  </div>

<script src="config.js"></script>
<script>
  const uid = localStorage.getItem("employeeId");
  if(!uid) location.href='index.html';

  let lat='', lng='';
  
  // GPS å®šä½
  navigator.geolocation.getCurrentPosition(
    p => { 
      lat=p.coords.latitude; 
      lng=p.coords.longitude; 
      document.getElementById('gpsStatus').innerHTML = 'âœ… GPS å·²é–å®š'; 
      document.getElementById('gpsStatus').style.color = '#34c759';
      document.getElementById('gpsStatus').style.fontWeight = 'bold';
    },
    e => { 
      document.getElementById('gpsStatus').innerText = 'âš ï¸ ç„¡æ³•å–å¾— GPS (è«‹å…è¨±æ¬Šé™)'; 
      document.getElementById('gpsStatus').style.color = '#ff3b30';
    },
    { enableHighAccuracy: true, timeout: 10000 }
  );

  function api(act, data={}) {
    return new Promise(r => {
      const s = document.createElement("script");
      s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${act}&payload=${encodeURIComponent(JSON.stringify({...data, userId:uid}))}&callback=cb${Date.now()}`;
      window[`cb${Date.now()}`] = (res) => { r(res); s.remove(); };
      document.body.appendChild(s);
    });
  }

  async function init() {
      // å‘¼å«å¾Œç«¯ get_me
      const res = await api("get_me");
      if(res.ok) {
          document.getElementById("uName").innerText = res.name;
          document.getElementById("annBal").innerText = res.balances.annual.left;
          document.getElementById("compBal").innerText = res.balances.comp.left;
          
          if(res.isManager) {
              const btn = document.getElementById("mgrBtn");
              btn.style.display = 'flex';
          }
      } else {
          document.getElementById("uName").innerText = "è¼‰å…¥å¤±æ•—";
      }
  }

  async function clock(type) {
      if(!lat) { alert("è«‹å…ˆç­‰å¾… GPS å®šä½å®Œæˆ"); return; }
      
      const btn = event.currentTarget; // æŠ“å–æŒ‰éˆ•å…ƒç´ 
      const originalHTML = btn.innerHTML;
      btn.innerHTML = '<span style="font-size:20px">â³</span><span>è™•ç†ä¸­...</span>';
      btn.style.opacity = '0.7';
      btn.disabled = true;

      const res = await api(type, {lat, lng});
      
      alert(res.message);
      
      // é‚„åŸæŒ‰éˆ•
      btn.innerHTML = originalHTML;
      btn.style.opacity = '1';
      btn.disabled = false;
  }

  function logout() {
      if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
          localStorage.clear();
          location.href = "index.html";
      }
  }

  // å•Ÿå‹•
  init();
</script>
</body>
</html>
