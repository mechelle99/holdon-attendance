<script>
  const LIFF_ID = "2009036245-XmZMSuuS";
  const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbz0YAlbpIYDqN6UC99TmaksEfzylud1QzuwTaupCp9zGdpUlReuRxaG8cvryxziHli_/exec";

  let userId = "";
  let displayName = "";
  let ready = false;

  const $ = (id) => document.getElementById(id);

  function log(msg){
    $("debug").innerText += "\n" + msg;
  }
  function setStatus(msg){ $("status").innerText = msg; }
  function setButtons(on){
    $("btnIn").disabled  = !on;
    $("btnOut").disabled = !on;
    $("btnOT").disabled  = !on;
  }

  async function init(){
    try{
      $("debug").innerText = "debug: start";
      setStatus("初始化中...");
      setButtons(false);

      await liff.init({ liffId: LIFF_ID });

      if(!liff.isLoggedIn()){
        liff.login();
        return;
      }

      const profile = await liff.getProfile();
      userId = profile.userId || "";
      displayName = profile.displayName || "";

      $("user").innerText = "你好，" + displayName;

      $("btnIn").onclick  = () => sendLog("上班");
      $("btnOut").onclick = () => sendLog("下班");
      $("btnOT").onclick  = () => sendLog("加班");

      ready = true;
      setButtons(true);
      setStatus("可以打卡了 ✅");
      log("ready=true");
    }catch(e){
      setStatus("初始化失敗");
      log("ERROR: " + (e?.message || e));
    }
  }

  async function sendLog(type){
    if(!ready){
      setStatus("尚未初始化完成");
      return;
    }

    setStatus("送出中...");
    log("sendLog=" + type);

    const body = new URLSearchParams({
      type,
      userId,
      displayName,
      ts: String(Date.now())
    }).toString();

    try{
      await fetch(GAS_WEBAPP_URL, {
        method: "POST",
        mode: "no-cors",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"
        },
        body
      });

      setStatus("已送出 ✅（請查看 Sheet）");
      log("sent");
    }catch(err){
      setStatus("送出失敗");
      log("ERR: " + (err?.message || err));
    }
  }

  init();
</script>
