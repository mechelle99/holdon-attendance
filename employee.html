<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>æˆ‘çš„å‡ºå‹¤çµ±è¨ˆ</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6f8;margin:0;padding:16px;color:#333;}
    .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
    .btn-back{padding:8px 16px;background:#333;color:#fff;text-decoration:none;border-radius:6px;font-size:14px;}
    .card{background:#fff;border-radius:12px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.05);margin-bottom:16px;}
    h3{margin-top:0;border-bottom:1px solid #eee;padding-bottom:10px;}
    
    /* ç¯©é¸å™¨æ¨£å¼ */
    .controls { display:flex; gap:10px; margin-bottom:15px; }
    select { padding:8px; border:1px solid #ddd; border-radius:6px; background:#fff; font-size:14px; }
    button.btn-search { background:#007aff; color:#fff; border:none; padding:8px 12px; border-radius:6px; font-weight:bold; cursor:pointer; }

    table{width:100%;border-collapse:collapse;font-size:14px;}
    th,td{padding:10px 5px;text-align:left;border-bottom:1px solid #eee;}
    th{background:#fafafa;color:#666;font-weight:600;}
    
    .badge{display:inline-block;padding:2px 6px;border-radius:4px;font-size:12px;color:#fff;}
    .bg-green{background:#2ecc71;} 
    .bg-red{background:#e74c3c;} 
    .bg-orange{background:#f39c12;} 
    .bg-gray{background:#95a5a6;} /* ç¼ºå¡ç”¨ç°è‰²æˆ–æ·±è‰² */
    .bg-black{background:#333;}   /* æ› è· */

    #loading{text-align:center;padding:20px;color:#666;}
  </style>
</head>
<body>

  <div class="header">
    <a href="app.html" class="btn-back">â† å›é¦–é </a>
    <div style="font-weight:bold;">å€‹äººå‡ºå‹¤ç´€éŒ„</div>
  </div>

  <div class="card">
    <h3>ğŸ“Š æœˆä»½çµ±è¨ˆ</h3>
    
    <div class="controls">
      <select id="selYear"></select>
      <select id="selMonth"></select>
      <button class="btn-search" onclick="loadMyData()">æŸ¥è©¢</button>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; text-align:center;">
      <div>
        <div style="font-size:12px;color:#888">é²åˆ°/ç•°å¸¸æ¬¡æ•¸</div>
        <div style="font-size:24px;font-weight:bold;color:#e74c3c;" id="statLate">-</div>
      </div>
      <div>
        <div style="font-size:12px;color:#888">è«‹å‡æ™‚æ•¸</div>
        <div style="font-size:24px;font-weight:bold;color:#f39c12;" id="statLeave">-</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>ğŸ“… è©³ç´°æ‰“å¡ç´€éŒ„</h3>
    <table>
      <thead>
        <tr><th>æ—¥æœŸ</th><th>ä¸Šç­</th><th>ä¸‹ç­</th><th>ç‹€æ…‹</th></tr>
      </thead>
      <tbody id="attendanceBody"></tbody>
    </table>
    <div id="loading">è¼‰å…¥ä¸­...</div>
  </div>

  <script src="config.js"></script>
  <script>
    const ENDPOINT = window.CONFIG?.GAS_ENDPOINT || "";
    const userId = localStorage.getItem("employeeId");

    if(!userId) { alert("è«‹å…ˆç™»å…¥"); location.href="index.html"; }

    // åˆå§‹åŒ–é¸å–®
    const now = new Date();
    const selY = document.getElementById("selYear");
    const selM = document.getElementById("selMonth");

    for(let y=now.getFullYear()-1; y<=now.getFullYear()+1; y++){
      selY.add(new Option(y+"å¹´", y, y===now.getFullYear(), y===now.getFullYear()));
    }
    for(let m=1; m<=12; m++){
      selM.add(new Option(m+"æœˆ", m, m===(now.getMonth()+1), m===(now.getMonth()+1)));
    }

    function api(act, data={}){
      document.getElementById("loading").style.display="block";
      return new Promise((resolve, reject)=>{
        const cb = "cb"+Date.now();
        const payload = JSON.stringify({ ...data, userId, webhookKey:window.CONFIG?.WEBHOOK_KEY });
        const s = document.createElement("script");
        s.src = `${ENDPOINT}?action=${act}&payload=${encodeURIComponent(payload)}&callback=${cb}`;
        window[cb] = (res) => { resolve(res); try{delete window[cb]; document.body.removeChild(s);}catch(e){} };
        s.onerror = () => reject("é€£ç·šå¤±æ•—");
        document.body.appendChild(s);
      });
    }

    async function loadMyData(){
      const y = selY.value;
      const m = selM.value;
      const tbody = document.getElementById("attendanceBody");
      
      tbody.innerHTML = "";
      document.getElementById("loading").style.display = "block";

      try {
        // å‚³é€å¹´ä»½æœˆä»½çµ¦å¾Œç«¯
        const res = await api("get_my_dashboard", { year: y, month: m }); 
        document.getElementById("loading").style.display = "none";

        if(res.ok) {
          document.getElementById("statLate").textContent = res.stats?.lateCount || 0;
          document.getElementById("statLeave").textContent = res.stats?.leaveHours || 0;

          if(res.attendance && res.attendance.length > 0){
            // 1. è³‡æ–™åˆä½µ (æµæ°´å¸³ -> æ—¥å ±è¡¨)
            const dailyMap = {};
            res.attendance.forEach(r => {
              const dateKey = r.date.substring(0, 10);
              if (!dailyMap[dateKey]) {
                dailyMap[dateKey] = { date: r.date, in: '-', out: '-', isLate: false };
              }
              if (r.in && r.in !== '') dailyMap[dateKey].in = r.in;
              if (r.out && r.out !== '') dailyMap[dateKey].out = r.out;
              if (r.isLate) dailyMap[dateKey].isLate = true;
            });

            // 2. æ’åº (æ–° -> èˆŠ)
            const list = Object.values(dailyMap).sort((a,b) => new Date(b.date) - new Date(a.date));

            // 3. æ¸²æŸ“
            list.forEach(r => {
              const isToday = new Date().toDateString() === new Date(r.date).toDateString();
              const hasIn = r.in !== '-';
              const hasOut = r.out !== '-';

              // [æ ¸å¿ƒä¿®æ”¹] ç‹€æ…‹åˆ¤æ–·é‚è¼¯
              let badgeHtml = '';

              if (r.isLate) {
                // å„ªå…ˆé¡¯ç¤ºé²åˆ° (å³ä½¿æœ‰æ‰“å¡ï¼Œé²åˆ°å°±æ˜¯é²åˆ°)
                badgeHtml = '<span class="badge bg-red">é²åˆ°</span>';
                // å¦‚æœé²åˆ°ä¸”ç¼ºä¸‹ç­å¡
                if (!isToday && !hasOut) badgeHtml += ' <span class="badge bg-gray">ç¼ºé€€</span>';
              } 
              else if (hasIn && hasOut) {
                // éƒ½æœ‰æ‰“å¡ä¸”æ²’é²åˆ° -> æ­£å¸¸
                badgeHtml = '<span class="badge bg-green">æ­£å¸¸</span>';
              }
              else if (isToday) {
                 // ä»Šå¤©
                 if(hasIn && !hasOut) badgeHtml = '<span class="badge bg-orange">å·¥ä½œä¸­</span>';
                 else if(!hasIn) badgeHtml = '<span class="badge bg-gray">æœªåˆ°ç­</span>';
              } 
              else {
                 // éå»çš„æ—¥æœŸ (ç•°å¸¸åˆ¤æ–·)
                 if(hasIn && !hasOut) badgeHtml = '<span class="badge bg-gray">ç¼ºä¸‹ç­å¡</span>';
                 else if(!hasIn && hasOut) badgeHtml = '<span class="badge bg-gray">ç¼ºä¸Šç­å¡</span>';
                 else badgeHtml = '<span class="badge bg-black">æ› è·/ç„¡ç´€éŒ„</span>'; 
              }

              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${r.date.substring(5,10)}</td>
                <td style="${!hasIn?'color:red':''}">${r.in}</td>
                <td style="${!hasOut?'color:red':''}">${r.out}</td>
                <td>${badgeHtml}</td>
              `;
              tbody.appendChild(tr);
            });
            
          } else {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:20px;">è©²æœˆä»½å°šç„¡æ‰“å¡è³‡æ–™</td></tr>';
          }
        } else {
          document.getElementById("loading").innerText = "è¼‰å…¥å¤±æ•—ï¼š" + (res.message || "æœªçŸ¥éŒ¯èª¤");
        }
      } catch(e) {
        document.getElementById("loading").innerText = "ç³»çµ±éŒ¯èª¤ï¼š" + e;
      }
    }

    loadMyData();
  </script>
</body>
</html>
