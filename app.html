<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
  <title>HR Portal</title>
  <style>
    :root {
      --primary: #4F46E5; --bg: #F3F4F6; --card: #FFFFFF; --text: #1F2937;
      --text-light: #6B7280; --success: #10B981; --warning: #F59E0B;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: var(--bg);
      margin: 0;
      padding: 20px 20px 100px 20px;
      color: var(--text);
    }

    .header-card {
      background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
      color: white;
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3);
      margin-bottom: 30px;
      position: relative;
    }
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      gap: 12px;
    }
    .user-name {
      font-size: 22px;
      font-weight: 700;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 70%;
    }
    .btn-logout {
      background: rgba(255,255,255,0.2);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
      backdrop-filter: blur(4px);
      white-space: nowrap;
    }

    /* GPS è¨Šè™Ÿç‡ˆ */
    .gps-indicator {
      position: absolute;
      top: 24px;
      right: 80px;
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #EF4444;
      box-shadow: 0 0 5px rgba(0,0,0,0.2);
      transition: background 0.3s, box-shadow 0.3s;
    }
    .gps-ready { background: #10B981; box-shadow: 0 0 8px #10B981; }

    .balance-row { display: flex; gap: 15px; }
    .bal-item {
      flex: 1;
      background: rgba(255,255,255,0.15);
      padding: 12px;
      border-radius: 16px;
      backdrop-filter: blur(4px);
      min-width: 0;
    }
    .bal-val { font-size: 20px; font-weight: 800; margin-bottom: 4px; white-space: nowrap; }
    .bal-label { font-size: 12px; opacity: 0.9; white-space: nowrap; }

    .clock-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .clock-btn {
      border: none; border-radius: 24px; padding: 24px 16px; cursor: pointer;
      display: flex; flex-direction: column; align-items: center; gap: 8px;
      background: var(--card); color: var(--text);
      box-shadow: var(--shadow);
      transition: transform 0.1s, opacity 0.2s;
      position: relative; overflow: hidden;
    }
    .clock-btn:active { transform: scale(0.96); }
    .clock-btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-icon { font-size: 32px; margin-bottom: 4px; }
    .btn-text { font-weight: 700; font-size: 16px; }
    .clock-in .btn-text { color: var(--success); }
    .clock-out .btn-text { color: var(--warning); }

    .loading-overlay {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.86);
      display: none; justify-content: center; align-items: center;
      font-weight: 800; color: var(--primary);
    }

    .nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--card);
      padding: 10px 0;
      padding-bottom: max(10px, env(safe-area-inset-bottom));
      box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
      border-top-left-radius: 24px;
      border-top-right-radius: 24px;
      z-index: 100;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      align-items: center;
    }
    .nav.is-manager { grid-template-columns: repeat(5, 1fr); }
    .nav-item {
      text-decoration: none;
      color: #9CA3AF;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 10px;
      gap: 4px;
      width: 100%;
    }
    .nav-item.active { color: var(--primary); }
    .nav-icon { font-size: 22px; }
    #mgrBtn { display: none; }
    .nav.is-manager #mgrBtn { display: flex; }
  </style>
</head>
<body>

  <div class="header-card">
    <div class="header-top">
      <div class="user-name">Hi, <span id="uName">...</span></div>
      <div class="gps-indicator" id="gpsDot" title="GPS"></div>
      <div class="btn-logout" onclick="logout()">ç™»å‡º</div>
    </div>
    <div class="balance-row">
      <div class="bal-item">
        <div class="bal-val" id="annBal">--</div>
        <div class="bal-label">ç‰¹ä¼‘é¤˜é¡</div>
      </div>
      <div class="bal-item">
        <div class="bal-val" id="compBal">--</div>
        <div class="bal-label">è£œä¼‘é¤˜é¡</div>
      </div>
    </div>
  </div>

  <div class="clock-grid">
    <button class="clock-btn clock-in" onclick="clock('clock_in')" id="btnIn">
      <span class="btn-icon">â˜€ï¸</span><span class="btn-text">ä¸Šç­æ‰“å¡</span>
      <div class="loading-overlay" id="loadIn">æ‰“å¡ä¸­...</div>
    </button>
    <button class="clock-btn clock-out" onclick="clock('clock_out')" id="btnOut">
      <span class="btn-icon">ğŸŒ™</span><span class="btn-text">ä¸‹ç­æ‰“å¡</span>
      <div class="loading-overlay" id="loadOut">æ‰“å¡ä¸­...</div>
    </button>
  </div>

  <nav class="nav" id="bottomNav">
    <a href="app.html" class="nav-item active"><span class="nav-icon">ğŸ </span><span>é¦–é </span></a>
    <a href="request.html" class="nav-item"><span class="nav-icon">ğŸ“</span><span>ç”³è«‹</span></a>
    <a href="history.html" class="nav-item"><span class="nav-icon">ğŸ“‹</span><span>ç´€éŒ„</span></a>
    <a href="schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span><span>æ’ç­</span></a>
    <a href="manager.html" class="nav-item" id="mgrBtn"><span class="nav-icon">ğŸ‘‘</span><span>ä¸»ç®¡</span></a>
  </nav>

<script src="config.js"></script>
<script>
  // âœ… å…¼å®¹ï¼šempId / employeeIdï¼ˆä½ å…¶ä»–é ä¹Ÿæœ‰æ··ç”¨ï¼‰
  const uid = localStorage.getItem("empId") || localStorage.getItem("employeeId");
  if(!uid) location.href = 'index.html';

  // âœ… ç®¡ç†è€…å¿«å–ï¼šå…ˆè®“ UI ä¸æŠ–
  const cachedMgr = localStorage.getItem("isManager") === "true";
  if(cachedMgr) document.getElementById("bottomNav").classList.add('is-manager');

  // =========================
  // JSONP APIï¼ˆä¿®æ‰ä½ åŸæœ¬ callback åç¨±äº‚è·³çš„ bugï¼‰
  // =========================
  function api(action, data = {}) {
    return new Promise((resolve) => {
      const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random()*100000);
      const s = document.createElement("script");
      const payload = encodeURIComponent(JSON.stringify({ ...data, userId: uid }));
      const bust = Date.now();

      const timer = setTimeout(() => {
        cleanup();
        resolve({ ok:false, message:"API timeout" });
      }, 15000);

      function cleanup() {
        clearTimeout(timer);
        try { delete window[cbName]; } catch(e){}
        try { s.remove(); } catch(e){}
      }

      window[cbName] = (res) => { cleanup(); resolve(res); };
      s.onerror = () => { cleanup(); resolve({ ok:false, message:"API load error" }); };

      s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${encodeURIComponent(action)}&payload=${payload}&callback=${cbName}&_=${bust}`;
      document.body.appendChild(s);
    });
  }

  // =========================
  // GPSï¼ˆå³ä¸Šç´…é»è®Šç¶ æ‰å…è¨±æ‰“å¡ï¼‰
  // =========================
  let currentLat = null;
  let currentLng = null;
  let gpsReady = false;
  const gpsDot = document.getElementById('gpsDot');

  function setGpsReady(on){
    gpsReady = !!on;
    gpsDot.classList.toggle('gps-ready', gpsReady);
  }

  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(
      (p) => {
        currentLat = p.coords.latitude;
        currentLng = p.coords.longitude;
        // æœ‰äº›æ‰‹æ©Ÿæœƒçµ¦è¶…çˆ›ç²¾æº–åº¦ï¼Œé€™è£¡åªè¦æœ‰å€¼å…ˆæ”¾è¡Œï¼ˆå¯¦éš›è·é›¢å¾Œç«¯å†æ“‹ï¼‰
        setGpsReady(true);
      },
      (e) => {
        console.warn("GPS Error:", e && e.message);
        setGpsReady(false);
      },
      { enableHighAccuracy: true, maximumAge: 30000, timeout: 10000 }
    );
  } else {
    setGpsReady(false);
  }

  // =========================
  // åˆå§‹åŒ–ï¼šé¡¯ç¤ºå§“åï¼ˆempName å„ªå…ˆï¼‰
  // =========================
  async function init() {
    const res = await api("get_me");
    if(!res || !res.ok){
      // é€€è€Œæ±‚å…¶æ¬¡ï¼šå…ˆé¡¯ç¤º uidï¼Œè‡³å°‘ä¸ç©ºç™½
      document.getElementById("uName").innerText = uid;
      return;
    }

    // âœ… ä½ è¦ã€Œåå­—ã€ï¼šempNameï¼ˆEmployees è¡¨çš„å“¡å·¥å§“åï¼‰å„ªå…ˆ
    // å…¼å®¹èˆŠæ¬„ä½ï¼šname / displayName
    const display =
      res.empName ||
      (res.me && (res.me.empName || res.me.name)) ||
      res.name ||
      res.displayName ||
      uid;

    document.getElementById("uName").innerText = display;

    // é¤˜é¡ï¼šå…¼å®¹ balances å¯èƒ½ä¸åŒçµæ§‹
    const annLeft =
      (res.balances && res.balances.annual && res.balances.annual.left != null) ? res.balances.annual.left :
      (res.annualLeft != null ? res.annualLeft : "--");

    const compLeft =
      (res.balances && res.balances.comp && res.balances.comp.left != null) ? res.balances.comp.left :
      (res.compLeft != null ? res.compLeft : "--");

    document.getElementById("annBal").innerText = annLeft;
    document.getElementById("compBal").innerText = compLeft;

    // âœ… isManagerï¼šå¾Œç«¯å›å‚³ true/false æˆ– "true"/"false" éƒ½åƒ
    const mgr = (res.isManager === true || String(res.isManager).toLowerCase() === "true");
    localStorage.setItem("isManager", mgr ? "true" : "false");
    if(mgr) document.getElementById("bottomNav").classList.add('is-manager');
  }

  // =========================
  // æ‰“å¡ï¼šé€ GPS åˆ°å¾Œç«¯
  // =========================
  async function clock(type) {
    if(!gpsReady || currentLat == null || currentLng == null){
      alert("GPS å°šæœªé–å®šï¼Œè«‹ç­‰å¾…å³ä¸Šè§’ç´…é»è®Šç¶ ï¼ˆæˆ–åˆ°æ‰‹æ©Ÿè¨­å®šå…è¨±å®šä½ï¼‰");
      return;
    }

    const loader = (type === 'clock_in') ? document.getElementById('loadIn') : document.getElementById('loadOut');
    const btn = (type === 'clock_in') ? document.getElementById('btnIn') : document.getElementById('btnOut');

    loader.style.display = 'flex';
    btn.disabled = true;

    try{
      const res = await api(type, { lat: currentLat, lng: currentLng, ua: navigator.userAgent });
      alert((res && res.message) ? res.message : "å®Œæˆ");
    } finally {
      loader.style.display = 'none';
      btn.disabled = false;
    }
  }

  function logout() {
    if(confirm("ç™»å‡ºï¼Ÿ")){
      localStorage.clear();
      location.href = "index.html";
    }
  }

  init();
</script>
</body>
</html>
