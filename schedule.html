<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>é–€å¸‚æ’ç­ç®¡ç†</title>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
  <style>
    body { font-family: -apple-system, sans-serif; padding: 20px; background: #f4f6f8; }
    .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .btn-back { display: inline-block; padding: 8px 16px; background: #333; color: #fff; text-decoration: none; border-radius: 6px; margin-bottom: 20px; font-size: 14px; }
    
    /* å½ˆçª—æ¨£å¼ */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; justify-content: center; align-items: center; }
    .modal-content { background: #fff; padding: 24px; border-radius: 12px; width: 300px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    select, input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 5px; font-size: 16px; box-sizing: border-box; }
    label { display: block; margin-top: 15px; font-size: 14px; color: #666; }
    .btn-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
    button { flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; min-width: 80px; }
    .btn-save { background: #007aff; color: #fff; }
    .btn-approve { background: #28a745; color: #fff; display: none; }
    .btn-del { background: #dc3545; color: #fff; display: none; }
    .btn-close { background: #eee; color: #333; }
  </style>
</head>
<body>

  <div class="container">
    <a href="index.html" class="btn-back">â† å›é¦–é </a>
    
    <div style="background:#e3f2fd; color:#0d47a1; padding:15px; border-radius:8px; text-align:center; margin-bottom:20px;">
      <span id="currentMonthStr" style="font-weight:bold; font-size:18px;">...</span> 
      <br>
      æ‡‰ä¼‘å¤©æ•¸ï¼š<span id="monthlyQuota" style="font-size:24px; font-weight:bold; color:#c22;">-</span> å¤©
      <div id="quotaDetail" style="font-size:13px; color:#555; margin-top:5px;"></div>
    </div>

    <div style="text-align:center; font-size:12px; color:#666; margin-bottom:10px;">
      <span style="color:#28a745">â— å·²åˆ°/å·²æ ¸å‡†</span> &nbsp;
      <span style="color:#6c757d">â— å¾…æ ¸å‡†</span> &nbsp;
      <span style="color:#dc3545">â— æ› è·</span>
    </div>
    <div id='calendar'></div>
  </div>

  <div id="eventModal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle">æ’ç­è¨­å®š</h3>
      <input type="hidden" id="selectedDate">
      
      <label>é¸æ“‡å“¡å·¥</label>
      <select id="empSelect">
        <option value="">è¼‰å…¥ä¸­...</option>
      </select>

      <label>ç­åˆ¥</label>
      <select id="shiftSelect">
        <option value="æ—©ç­">â˜€ï¸ æ—©ç­ (10:00-18:00)</option>
        <option value="åˆç­">ğŸŒ™ åˆç­ (12:00-21:00)</option>
      </select>
      
      <div id="statusInfo" style="margin-top:10px; font-size:12px; color:#888;"></div>

      <div class="btn-group">
        <button class="btn-approve" id="btnApprove" onclick="approveEvent()">âœ… æ ¸å‡†</button>
        <button class="btn-del" id="btnDelete" onclick="deleteEvent()">ğŸ—‘ï¸ åˆªé™¤</button>
        <button class="btn-save" id="btnSave" onclick="saveEvent()">ğŸ’¾ å„²å­˜</button>
        <button class="btn-close" onclick="closeModal()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    const ENDPOINT = window.CONFIG?.GAS_ENDPOINT || window.GAS_ENDPOINT;
    const userId = localStorage.getItem("employeeId");
    // å‡è¨­ä¸»ç®¡åå–®å¯«æ­»åœ¨å‰ç«¯åˆ¤æ–·é¡¯ç¤ºæŒ‰éˆ• (å¾Œç«¯æœ‰é›™é‡é©—è­‰)
    const MANAGERS = ["M001", "M002"]; 
    const isManager = MANAGERS.includes(userId);

    let calendar;
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      if (!userId) { location.href = "login.html"; return; }
      
      // 1. å…ˆè¼‰å…¥å“¡å·¥åå–® (æé€Ÿ)
      await loadEmployees();

      // 2. åˆå§‹åŒ–æ—¥æ›†
      const calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'zh-tw',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,listWeek' },
        height: 'auto',
        events: fetchEvents,
        dateClick: function(info) { openModal(info.dateStr, null); },
        eventClick: function(info) { 
          if (info.event.extendedProps.type === 'auto') {
            alert("é€™æ˜¯å›ºå®šç­è¡¨ (è‡ªå‹•ç”¢ç”Ÿ)ï¼Œç„¡æ³•ç·¨è¼¯ã€‚");
            return;
          }
          openModal(info.event.startStr, info.event); 
        }
      });
      calendar.render();
    });

    // è¼‰å…¥å“¡å·¥ (ç¨ç«‹ API)
    async function loadEmployees() {
      try {
        const res = await fetch(ENDPOINT, {
          method: "POST",
          body: JSON.stringify({ action: "get_all_employees" })
        });
        const json = await res.json();
        const sel = document.getElementById("empSelect");
        sel.innerHTML = "";
        if (json.ok) {
          json.list.forEach(emp => {
            const opt = document.createElement("option");
            opt.value = emp.id;
            opt.textContent = `${emp.name}`;
            sel.appendChild(opt);
          });
        }
      } catch(e) {}
    }

    // æŠ“ç­è¡¨ + ç®—å‡
    async function fetchEvents(info, successCallback, failureCallback) {
      const currentViewDate = new Date( (new Date(info.startStr).getTime() + new Date(info.endStr).getTime()) / 2 );
      const year = currentViewDate.getFullYear();
      const month = currentViewDate.getMonth() + 1;
      
      document.getElementById("currentMonthStr").textContent = `${year}å¹´ ${month}æœˆ`;
      updateMonthlyQuota(year, month); // å‘¼å«ç®—å‡ API

      try {
        const res = await fetch(ENDPOINT, {
          method: "POST",
          body: JSON.stringify({ 
            action: "get_schedule", 
            userId: userId,
            start: info.startStr,
            end: info.endStr
          })
        });
        const json = await res.json();
        if (json.ok) successCallback(json.events);
        else failureCallback(json.message);
      } catch (e) { failureCallback(e); }
    }

    // ç®—æ‡‰ä¼‘å¤©æ•¸
    async function updateMonthlyQuota(year, month) {
      const elDays = document.getElementById("monthlyQuota");
      const elMsg = document.getElementById("quotaDetail");
      elDays.textContent = "...";
      try {
        const res = await fetch(ENDPOINT, {
          method: "POST",
          body: JSON.stringify({ action: "get_month_quota", year, month })
        });
        const json = await res.json();
        if (json.ok) {
          elDays.textContent = json.days;
          elMsg.textContent = json.msg;
        } else {
          elDays.textContent = "??"; // æ¬Šé™ä¸è¶³æˆ–å…¶ä»–éŒ¯èª¤
        }
      } catch(e) {}
    }

    // Modal æ§åˆ¶
    function openModal(dateStr, eventObj) {
      document.getElementById("eventModal").style.display = "flex";
      document.getElementById("selectedDate").value = dateStr;
      
      const title = document.getElementById("modalTitle");
      const btnSave = document.getElementById("btnSave");
      const btnDel = document.getElementById("btnDelete");
      const btnApprove = document.getElementById("btnApprove");
      const empSel = document.getElementById("empSelect");
      const info = document.getElementById("statusInfo");

      // é‡ç½®æŒ‰éˆ•
      btnSave.style.display = "block";
      btnDel.style.display = "none";
      btnApprove.style.display = "none";
      empSel.disabled = false;
      info.textContent = "";

      if (eventObj) {
        // --- ç·¨è¼¯æ¨¡å¼ ---
        title.textContent = `${dateStr} æ’ç­è©³æƒ…`;
        empSel.value = eventObj.extendedProps.empId;
        empSel.disabled = true; // ä¸èƒ½æ”¹äºº
        
        // è®€å–ç›®å‰çš„ç­åˆ¥ (å¦‚æœå‰ç«¯æœ‰å­˜çš„è©±ï¼Œé€™è£¡ç°¡åŒ–è™•ç†)
        // å¯¦éš›ä¸Šæ‡‰è©²æŠŠ shift å­˜åœ¨ extendedProps è£¡å‚³éä¾†
        // å‡è¨­é è¨­é¸ä¸­è©²å“¡å·¥åŸæœ¬çš„ç­åˆ¥ (éœ€å¾Œç«¯é…åˆå‚³å› shift)
        
        const status = eventObj.extendedProps.reqStatus; // PENDING or APPROVED
        info.textContent = `ç‹€æ…‹ï¼š${status}`;

        if (status === "APPROVED") {
          // å·²æ ¸å‡†ï¼šå“¡å·¥ä¸èƒ½å‹•ï¼Œä¸»ç®¡å¯ä»¥åˆªé™¤
          btnSave.style.display = "none";
          if (isManager) btnDel.style.display = "block";
        } else {
          // å¾…æ ¸å‡† (PENDING)
          btnDel.style.display = "block"; // å¤§å®¶éƒ½èƒ½åˆªé™¤è‰ç¨¿
          if (isManager) {
            btnApprove.style.display = "block"; // ä¸»ç®¡å¯ä»¥æ ¸å‡†
            btnSave.style.display = "none"; // ä¸»ç®¡ç›´æ¥æ ¸å‡†å°±å¥½ï¼Œä¸ç”¨å†å„²å­˜
          }
        }

      } else {
        // --- æ–°å¢æ¨¡å¼ ---
        title.textContent = `æ–°å¢æ’ç­ (${dateStr})`;
        // å¦‚æœæ˜¯å“¡å·¥ï¼Œé è¨­é¸è‡ªå·±
        if (!isManager) {
           empSel.value = userId;
           empSel.disabled = true; // å“¡å·¥åªèƒ½æ’è‡ªå·±
        }
      }
    }

    function closeModal() { document.getElementById("eventModal").style.display = "none"; }

    // API å‘¼å«åŒ…è£
    async function apiCall(payload) {
      try {
        const res = await fetch(ENDPOINT, {
          method: "POST",
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        alert(json.message);
        if(json.ok) {
          closeModal();
          calendar.refetchEvents();
        }
      } catch(e) { alert("é€£ç·šéŒ¯èª¤"); }
    }

    function saveEvent() {
      apiCall({
        action: "add_schedule",
        date: document.getElementById("selectedDate").value,
        empId: document.getElementById("empSelect").value,
        empName: document.getElementById("empSelect").options[document.getElementById("empSelect").selectedIndex].text,
        shift: document.getElementById("shiftSelect").value,
        userId: userId
      });
    }

    function deleteEvent() {
      if(!confirm("ç¢ºå®šè¦åˆªé™¤/å–æ¶ˆæ­¤æ’ç­å—ï¼Ÿ")) return;
      apiCall({
        action: "del_schedule",
        date: document.getElementById("selectedDate").value,
        empId: document.getElementById("empSelect").value,
        userId: userId
      });
    }

    function approveEvent() {
      apiCall({
        action: "approve_schedule",
        date: document.getElementById("selectedDate").value,
        empId: document.getElementById("empSelect").value,
        userId: userId
      });
    }
  </script>
</body>
</html>
