<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>排班管理表</title>
  <style>
    :root {
      --primary: #1a73e8;
      --early-bg: #e8f0fe; --early-text: #1967d2;
      --late-bg: #fff3e0; --late-text: #ea8600;
      --off-bg: #f1f3f4; --off-text: #5f6368;
      --leave-bg: #fce8e6; --leave-text: #c5221f;
      --border: #dadce0;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; background: #fff; height: 100vh; display: flex; flex-direction: column; }
    
    /* Header */
    .header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; z-index: 20; }
    .title { font-size: 18px; font-weight: bold; display: flex; align-items: center; gap: 10px; }
    .controls { display: flex; gap: 8px; }
    select, button { padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; background: #fff; cursor: pointer; }
    .btn-save { background: var(--primary); color: #fff; border: none; font-weight: 500; }
    .btn-back { text-decoration: none; color: #333; font-size: 14px; padding: 8px 12px; background: #f1f3f4; border-radius: 6px; }

    /* Roster Grid */
    .roster-wrap { flex: 1; overflow: auto; position: relative; }
    table { border-collapse: separate; border-spacing: 0; width: 100%; }
    
    th, td { border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); padding: 0; text-align: center; height: 48px; min-width: 60px; box-sizing: border-box; }
    
    /* Sticky Headers */
    thead { position: sticky; top: 0; z-index: 10; background: #fff; }
    th { background: #f8f9fa; font-size: 13px; color: #555; font-weight: 600; padding: 4px; }
    
    /* Sticky Employee Column */
    .col-emp { position: sticky; left: 0; z-index: 11; background: #fff; min-width: 100px; border-right: 2px solid var(--border); font-weight: bold; font-size: 14px; display: flex; align-items: center; justify-content: center; height: 100%; width: 100%; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
    /* Fix sticky intersection */
    thead th:first-child { z-index: 12; border-right: 2px solid var(--border); }

    /* Cell Styles */
    .shift-cell { position: relative; height: 100%; width: 100%; }
    .shift-select { 
      width: 100%; height: 100%; border: none; outline: none; 
      background: transparent; font-size: 13px; font-weight: 600;
      text-align: center; text-align-last: center; cursor: pointer;
      appearance: none; -webkit-appearance: none; 
    }
    
    /* Colors */
    .st-EARLY { background: var(--early-bg); color: var(--early-text); }
    .st-LATE  { background: var(--late-bg);  color: var(--late-text); }
    .st-OFF   { background: var(--off-bg);   color: var(--off-text); }
    .st-LEAVE { background: var(--leave-bg); color: var(--leave-text); pointer-events: none; display: flex; align-items: center; justify-content: center; font-size: 12px;}

    /* Weekend Highlight */
    .weekend { color: #d93025; background: #fce8e6; }

    #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 99; font-weight: bold; color: var(--primary); }
    .hidden { display: none; }
  </style>
</head>
<body>

<div id="loading">正在讀取班表資料...</div>

<div class="header">
  <div class="title">
    <a href="app.html" class="btn-back">← 返回</a>
    <span>排班管理表</span>
  </div>
  <div class="controls">
    <select id="selYear"></select>
    <select id="selMonth"></select>
    <button class="btn-save" onclick="loadRoster()">重新整理</button>
    <button id="btnApprove" class="btn-save hidden" style="background:#6f42c1;" onclick="approveAll()">主管核准全月</button>
  </div>
</div>

<div class="roster-wrap">
  <table id="rosterTable">
    <thead>
      <tr id="headRow">
        <th><div class="col-emp">員工</div></th>
      </tr>
    </thead>
    <tbody id="bodyRow"></tbody>
  </table>
</div>

<script src="config.js"></script>
<script>
  const ENDPOINT = window.CONFIG?.GAS_ENDPOINT || "";
  const userId = localStorage.getItem("employeeId");
  let isManager = false;

  if(!userId) location.href="index.html";

  const now = new Date();
  const ySel = document.getElementById("selYear");
  const mSel = document.getElementById("selMonth");

  // 初始化選單
  for(let y=now.getFullYear()-1; y<=now.getFullYear()+1; y++) {
    ySel.add(new Option(y+"年", y, y===now.getFullYear(), y===now.getFullYear()));
  }
  for(let m=1; m<=12; m++) {
    mSel.add(new Option(m+"月", m, m===(now.getMonth()+1), m===(now.getMonth()+1)));
  }

  function api(act, data={}) {
    document.getElementById("loading").style.display = "flex";
    return new Promise((resolve, reject) => {
      const cb = "cb" + Date.now();
      const payload = JSON.stringify({ ...data, userId, webhookKey: window.CONFIG?.WEBHOOK_KEY });
      const s = document.createElement("script");
      s.src = `${ENDPOINT}?action=${act}&payload=${encodeURIComponent(payload)}&callback=${cb}`;
      window[cb] = (res) => { resolve(res); try{delete window[cb];s.remove();}catch(e){} document.getElementById("loading").style.display="none"; };
      s.onerror = () => { alert("連線失敗"); document.getElementById("loading").style.display="none"; };
      document.body.appendChild(s);
    });
  }

  async function loadRoster() {
    const y = ySel.value;
    const m = mSel.value;
    const days = new Date(y, m, 0).getDate();
    const headRow = document.getElementById("headRow");
    
    // 1. 建立表頭日期
    let headHtml = '<th><div class="col-emp">員工</div></th>';
    for(let d=1; d<=days; d++) {
      const date = new Date(y, m-1, d);
      const day = date.getDay();
      const weekStr = ['日','一','二','三','四','五','六'][day];
      const isWeekend = (day===0 || day===6) ? 'weekend' : '';
      headHtml += `<th class="${isWeekend}">${d}<br><small>${weekStr}</small></th>`;
    }
    headRow.innerHTML = headHtml;

    try {
      const res = await api("get_roster_data", { year: y, month: m });
      if(!res.ok) return alert(res.message);

      isManager = res.isManager;
      if(isManager) document.getElementById("btnApprove").classList.remove("hidden");

      const tbody = document.getElementById("bodyRow");
      tbody.innerHTML = "";

      // 2. 建立員工列
      res.employees.forEach(emp => {
        const tr = document.createElement("tr");
        let html = `<td><div class="col-emp">${emp.name}</div></td>`;
        
        for(let d=1; d<=days; d++) {
          const cell = (res.roster[emp.id] && res.roster[emp.id][d]) ? res.roster[emp.id][d] : {};
          const fullDate = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
          
          if (cell.type === 'LEAVE') {
            // 請假鎖定
            html += `<td class="st-LEAVE">${cell.value}</td>`;
          } else {
            // 排班選單
            const val = cell.value || 'OFF';
            const schId = cell.scheduleId || '';
            const isApproved = cell.status === 'APPROVED';
            // 如果已核准且不是主管，則鎖定
            const disabled = (isApproved && !isManager) ? 'disabled' : '';
            
            // 根據數值決定顏色
            const bgClass = val === 'EARLY' ? 'st-EARLY' : (val === 'LATE' ? 'st-LATE' : 'st-OFF');
            
            html += `
              <td class="${bgClass}" id="td_${emp.id}_${d}">
                <select class="shift-select" ${disabled} onchange="saveShift(this, '${emp.id}', '${emp.name}', '${fullDate}', '${schId}', ${d})">
                  <option value="OFF" ${val==='OFF'?'selected':''}>休</option>
                  <option value="EARLY" ${val==='EARLY'?'selected':''}>早 10-18</option>
                  <option value="LATE" ${val==='LATE'?'selected':''}>午 12-21</option>
                </select>
              </td>`;
          }
        }
        tr.innerHTML = html;
        tbody.appendChild(tr);
      });

    } catch(e) { alert("錯誤: " + e); }
  }

  async function saveShift(el, empId, empName, date, oldId, dayIdx) {
    const shift = el.value;
    
    // 即時變色
    const td = document.getElementById(`td_${empId}_${dayIdx}`);
    td.className = shift === 'EARLY' ? 'st-EARLY' : (shift === 'LATE' ? 'st-LATE' : 'st-OFF');

    // 只有當原本不是空的，或者新值不是 OFF 時才送出 (減少空白請求)
    if (!oldId && shift === 'OFF') return;

    try {
      const act = oldId ? "update_schedule" : "add_schedule";
      await api(act, { scheduleId: oldId, empId, empName, date, shift });
      // 靜默儲存成功
    } catch(e) {
      alert("儲存失敗");
      loadRoster(); // 失敗則還原
    }
  }

  async function approveAll() {
    if(!confirm("確定核准本月所有班表？\n核准後員工將無法自行修改。")) return;
    await api("approve_month_all", { year: ySel.value, month: mSel.value });
    alert("已全部核准！");
    loadRoster();
  }

  // 初始載入
  loadRoster();
</script>
</body>
</html>
