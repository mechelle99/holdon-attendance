<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HOLDON å‡ºå‹¤ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:Arial,sans-serif;padding:16px;color:#111;}
    h2{margin:0 0 8px;}
    .muted{color:#666;font-size:12px;margin:6px 0 14px;}
    .tabs{display:flex;gap:8px;margin:12px 0;}
    .tab{padding:8px 12px;border:1px solid #ddd;border-radius:999px;background:#fff;cursor:pointer;font-size:13px;}
    .tab.active{border-color:#111;}
    .card{border:1px solid #eee;border-radius:14px;padding:14px;margin:12px 0;box-shadow:0 8px 24px rgba(0,0,0,.05);}
    .row{display:flex;gap:10px;flex-wrap:wrap;}
    .btn{padding:10px 12px;border-radius:999px;border:1px solid #ddd;background:#fff;cursor:pointer;}
    .btn.primary{border-color:#111;}
    .btn:disabled{opacity:.45;cursor:not-allowed;}
    label{font-size:12px;color:#444;display:block;margin:10px 0 4px;}
    input,select,textarea{width:100%;box-sizing:border-box;padding:10px 12px;border:1px solid #ddd;border-radius:10px;font-size:14px;}
    textarea{min-height:70px;resize:vertical;}
    .status{font-size:13px;margin-top:10px;}
    .ok{color:#0a7a2f;}
    .err{color:#b00020;}
    .hidden{display:none;}
    .item{border-top:1px solid #eee;padding-top:10px;margin-top:10px;}
    .pill{display:inline-block;font-size:12px;padding:3px 8px;border:1px solid #ddd;border-radius:999px;color:#444;margin-left:6px;}
  </style>
</head>
<body>
  <h2>HOLDON å‡ºå‹¤ç³»çµ±</h2>
  <div class="muted">ä¸Š/ä¸‹ç­ç«‹å³ç”Ÿæ•ˆï¼›åŠ ç­èˆ‡è«‹å‡éœ€ä¸»ç®¡æ ¸å‡†ã€‚</div>

  <div class="card">
    <div id="user">è¼‰å…¥ä¸­...</div>
    <div id="status" class="status muted"></div>

    <div class="row" style="margin-top:10px;">
      <button id="btnIn"  class="btn primary" disabled>ğŸŸ¢ ä¸Šç­æ‰“å¡</button>
      <button id="btnOut" class="btn primary" disabled>ğŸ”´ ä¸‹ç­æ‰“å¡</button>
    </div>

    <div class="tabs">
      <button class="tab active" id="tabApply">ç”³è«‹</button>
      <button class="tab" id="tabMine">æˆ‘çš„ç”³è«‹</button>
      <button class="tab hidden" id="tabMgr">ä¸»ç®¡æ ¸å‡†</button>
    </div>
  </div>

  <div id="panelApply" class="card">
    <h3 style="margin:0 0 8px;">ğŸ•’ åŠ ç­ç”³è«‹ï¼ˆéœ€æ ¸å‡†ï¼‰</h3>
    <label>åŠ ç­æ—¥æœŸ</label><input id="otDate" type="date"/>
    <label>åŠ ç­æ™‚æ•¸ï¼ˆå°æ™‚ï¼‰</label><input id="otHours" type="number" min="0.5" step="0.5" placeholder="ä¾‹å¦‚ï¼š2"/>
    <label>åŸå› èªªæ˜</label><textarea id="otReason" placeholder="ç°¡è¿°åŠ ç­åŸå› "></textarea>
    <div class="row" style="margin-top:10px;">
      <button id="btnOTApply" class="btn" disabled>é€å‡ºåŠ ç­ç”³è«‹</button>
    </div>

    <hr style="border:none;border-top:1px solid #eee;margin:14px 0;"/>

    <h3 style="margin:0 0 8px;">ğŸ“ è«‹å‡ç”³è«‹ï¼ˆéœ€æ ¸å‡†ï¼‰</h3>
    <label>å‡åˆ¥</label>
    <select id="leaveType">
      <option value="äº‹å‡">äº‹å‡</option>
      <option value="ç—…å‡">ç—…å‡</option>
      <option value="ç‰¹ä¼‘">ç‰¹ä¼‘</option>
      <option value="ç”Ÿæ—¥å‡">ç”Ÿæ—¥å‡</option>
    </select>
    <label>è«‹å‡æ—¥æœŸ</label><input id="leaveDate" type="date"/>
    <label>è«‹å‡æ™‚æ•¸ï¼ˆå°æ™‚ï¼‰</label><input id="leaveHours" type="number" min="0.5" step="0.5" placeholder="ä¾‹å¦‚ï¼š4"/>
    <label>åŸå› èªªæ˜</label><textarea id="leaveReason" placeholder="ç°¡è¿°è«‹å‡åŸå› "></textarea>
    <div class="row" style="margin-top:10px;">
      <button id="btnLeaveApply" class="btn" disabled>é€å‡ºè«‹å‡ç”³è«‹</button>
    </div>
  </div>

  <div id="panelMine" class="card hidden">
    <h3 style="margin:0 0 8px;">ğŸ“„ æˆ‘çš„ç”³è«‹</h3>
    <div class="row">
      <button class="btn" id="btnReloadMine" disabled>é‡æ–°æ•´ç†</button>
    </div>
    <div id="mineList" class="muted" style="margin-top:10px;">å°šç„¡è³‡æ–™</div>
  </div>

  <div id="panelMgr" class="card hidden">
    <h3 style="margin:0 0 8px;">ğŸ“¥ å¾…æ ¸å‡†æ¸…å–®</h3>
    <div class="row">
      <button class="btn" id="btnReloadPending" disabled>é‡æ–°æ•´ç†</button>
    </div>
    <div id="pendingList" class="muted" style="margin-top:10px;">å°šç„¡è³‡æ–™</div>
  </div>

<script>
  // ========= è¨­å®šå€ =========
  <script>
  const LIFF_ID = "2009036245-XmZMSuuS";
  const GAS_URL = "https://script.google.com/macros/s/AKfycbz0YAlbpIYDqN6UC99TmaksEfzylud1QzuwTaupCp9zGdpUlReuRxaG8cvryxziHli_/exec";

  let userId="", displayName="", ready=false, isManager=false;

  const $ = (id)=>document.getElementById(id);

  function setStatus(msg,type="muted"){
    $("status").className="status "+(type==="ok"?"ok":type==="err"?"err":"muted");
    $("status").innerText=msg||"";
  }

  function enableAll(on){
    ["btnIn","btnOut","btnOTApply","btnLeaveApply","btnReloadMine","btnReloadPending"].forEach(id=>{
      const el = $(id);
      if(el) el.disabled=!on;
    });
  }

  function traceId_(){ return "liff-"+Date.now()+"-"+Math.random().toString(16).slice(2); }

  // âœ… æœ€ç©©é€å‡ºï¼šGET pingï¼ˆç”¨ Image é¿å… CORSï¼‰
  function ping_(paramsObj, okMsg){
    const params = new URLSearchParams(paramsObj).toString();
    const url = GAS_URL + "?" + params;

    return new Promise((resolve,reject)=>{
      const img=new Image();
      img.onload=()=>resolve(true);
      img.onerror=()=>reject(new Error("ping_failed_or_blocked"));
      img.src=url;
    }).then(()=>setStatus(okMsg,"ok"))
      .catch((e)=>{
        console.error("ping_ error:", e);
        setStatus("é€å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦","err");
      });
  }

  // âœ… JSONP è®€å–ï¼šé¿å… CORS
  function jsonp_(paramsObj){
    return new Promise((resolve,reject)=>{
      const cb = "cb_" + Date.now() + "_" + Math.random().toString(16).slice(2);
      paramsObj.callback = cb;

      const url = GAS_URL + "?" + new URLSearchParams(paramsObj).toString();
      const script = document.createElement("script");

      window[cb] = (data)=>{
        try{ resolve(data); }
        finally{
          try{ delete window[cb]; }catch(_){}
          script.remove();
        }
      };

      script.src = url;
      script.onerror = ()=>{
        try{ delete window[cb]; }catch(_){}
        script.remove();
        reject(new Error("jsonp_failed"));
      };

      document.body.appendChild(script);

      setTimeout(()=>{
        if(window[cb]){
          try{ delete window[cb]; }catch(_){}
          script.remove();
          reject(new Error("jsonp_timeout"));
        }
      }, 9000);
    });
  }

  function showTab(which){
    ["tabApply","tabMine","tabMgr"].forEach(id=>$(id).classList.remove("active"));
    $("tab"+which).classList.add("active");

    $("panelApply").classList.toggle("hidden", which!=="Apply");
    $("panelMine").classList.toggle("hidden", which!=="Mine");
    $("panelMgr").classList.toggle("hidden", which!=="Mgr");
  }

  function escapeHtml_(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // âœ… ä½ ä¹‹å‰ç¼ºçš„ï¼šæ ¸å¿ƒæŒ‰éˆ•ç¶å®šï¼ˆæ‰“å¡/ç”³è«‹/åˆ‡æ›tabï¼‰
  function bindCoreButtons(){
    $("tabApply").onclick = ()=>showTab("Apply");
    $("tabMine").onclick  = ()=>{ showTab("Mine"); loadMine().catch(e=>{ console.error(e); setStatus("æ¸…å–®è¼‰å…¥å¤±æ•—ï¼ˆç¨å¾Œå†è©¦ï¼‰","err"); }); };
    $("tabMgr").onclick   = ()=>{ showTab("Mgr");  loadPending().catch(e=>{ console.error(e); setStatus("æ¸…å–®è¼‰å…¥å¤±æ•—ï¼ˆç¨å¾Œå†è©¦ï¼‰","err"); }); };

    $("btnIn").onclick = ()=> ping_({
      action:"punch",
      type:"IN",
      userId,
      displayName,
      ts:Date.now(),
      traceId:traceId_(),
      origin:location.origin
    }, "ä¸Šç­æ‰“å¡æˆåŠŸ âœ…");

    $("btnOut").onclick = ()=> ping_({
      action:"punch",
      type:"OUT",
      userId,
      displayName,
      ts:Date.now(),
      traceId:traceId_(),
      origin:location.origin
    }, "ä¸‹ç­æ‰“å¡æˆåŠŸ âœ…");

    $("btnOTApply").onclick    = ()=> submitOT();
    $("btnLeaveApply").onclick = ()=> submitLeave();

    $("btnReloadMine").onclick    = ()=> loadMine().catch(e=>{ console.error(e); setStatus("æ¸…å–®è¼‰å…¥å¤±æ•—ï¼ˆç¨å¾Œå†è©¦ï¼‰","err"); });
    $("btnReloadPending").onclick = ()=> loadPending().catch(e=>{ console.error(e); setStatus("æ¸…å–®è¼‰å…¥å¤±æ•—ï¼ˆç¨å¾Œå†è©¦ï¼‰","err"); });

    const refreshButtons = ()=>{
      $("btnOTApply").disabled    = !($("otDate").value && $("otHours").value);
      $("btnLeaveApply").disabled = !($("leaveDate").value && $("leaveHours").value);
    };

    ["change","keyup","input"].forEach(ev=>{
      ["otDate","otHours","otReason","leaveType","leaveDate","leaveHours","leaveReason"].forEach(id=>{
        $(id).addEventListener(ev, refreshButtons);
      });
    });

    refreshButtons();
  }

  function submitOT(){
    const date = $("otDate").value;
    const hours = $("otHours").value;
    const reason = $("otReason").value.trim();
    if(!date || !hours){ setStatus("è«‹å¡«å¯«åŠ ç­æ—¥æœŸèˆ‡æ™‚æ•¸","err"); return; }

    return ping_({
      action:"request",
      requestType:"Overtime",
      leaveType:"",
      date,
      hours:String(hours),
      reason,
      userId,
      displayName,
      ts:Date.now(),
      traceId:traceId_(),
      origin:location.origin
    }, "åŠ ç­ç”³è«‹å·²é€å‡ºï¼ˆå¾…æ ¸å‡†ï¼‰âœ…");
  }

  function submitLeave(){
    const leaveType = $("leaveType").value;
    const date = $("leaveDate").value;
    const hours = $("leaveHours").value;
    const reason = $("leaveReason").value.trim();
    if(!date || !hours){ setStatus("è«‹å¡«å¯«è«‹å‡æ—¥æœŸèˆ‡æ™‚æ•¸","err"); return; }

    return ping_({
      action:"request",
      requestType:"Leave",
      leaveType,
      date,
      hours:String(hours),
      reason,
      userId,
      displayName,
      ts:Date.now(),
      traceId:traceId_(),
      origin:location.origin
    }, "è«‹å‡ç”³è«‹å·²é€å‡ºï¼ˆå¾…æ ¸å‡†ï¼‰âœ…");
  }

  async function loadMine(){
    if(!ready) return;
    setStatus("è¼‰å…¥ä¸­...");
    const data = await jsonp_({action:"listRequests", userId, mode:"mine"});
    renderList_("mineList", data?.items || [], false);
    setStatus("å·²æ›´æ–°","ok");
  }

  async function loadPending(){
    if(!ready || !isManager) return;
    setStatus("è¼‰å…¥ä¸­...");
    const data = await jsonp_({action:"listRequests", userId, mode:"pendingAll"});
    renderList_("pendingList", data?.items || [], true);
    setStatus("å·²æ›´æ–°","ok");
  }

  function renderList_(targetId, items, withActions){
    const el = $(targetId);
    if(!items.length){ el.innerHTML = `<div class="muted">ç›®å‰æ²’æœ‰è³‡æ–™</div>`; return; }

    el.innerHTML = items.map(it=>{
      const title = it.requestType === "Overtime" ? "åŠ ç­" : `è«‹å‡ï¼ˆ${it.leaveType}ï¼‰`;
      const st = it.status || "Pending";
      const pill = `<span class="pill">${escapeHtml_(st)}</span>`;

      const actions = withActions && st==="Pending" ? `
        <div class="row" style="margin-top:8px;">
          <button class="btn" onclick="decideReq('${it.requestId}','Approved')">âœ… æ ¸å‡†</button>
          <button class="btn" onclick="decideReq('${it.requestId}','Rejected')">âŒ é§å›</button>
        </div>` : "";

      return `
        <div class="item">
          <div><b>${escapeHtml_(title)}</b>${pill}</div>
          <div class="muted">ç”³è«‹äººï¼š${escapeHtml_(it.applicantName||"")}ï½œæ—¥æœŸï¼š${escapeHtml_(it.date||"")}ï½œæ™‚æ•¸ï¼š${escapeHtml_(it.hours||"")}</div>
          <div style="margin-top:6px;">${escapeHtml_(it.reason || "")}</div>
          ${actions}
        </div>`;
    }).join("");
  }

  window.decideReq = async function(requestId, decision){
    try{
      setStatus("é€å‡ºä¸­...");
      const data = await jsonp_({action:"decide", userId, requestId, decision});
      if(data?.ok){
        setStatus(data.message || "å·²æ›´æ–°","ok");
        loadPending();
      }else{
        setStatus(data?.message || "æ›´æ–°å¤±æ•—","err");
      }
    }catch(e){
      console.error("decideReq error:", e);
      setStatus("æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦","err");
    }
  };

  function formatErr_(e){
    const msg = (e && (e.message || e.toString())) || "unknown";
    return msg.length > 140 ? msg.slice(0,140)+"..." : msg;
  }

  async function init(){
    enableAll(false);
    setStatus("åˆå§‹åŒ–ä¸­...");

    // âœ… æŠŠç’°å¢ƒè³‡è¨Šä¹Ÿåå‡ºä¾†ï¼Œé¿å…ä½ åœ¨çŒœï¼ˆä½†ä¸å¹²æ“¾æ“ä½œï¼‰
    console.log("env:", {
      href: location.href,
      origin: location.origin,
      ua: navigator.userAgent
    });

    try{
      await Promise.race([
        liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true }),
        new Promise((_,rej)=>setTimeout(()=>rej(new Error("liff.init timeout")), 9000))
      ]);
    }catch(e){
      console.error("LIFF init failed:", e);
      // é€™è£¡é€šå¸¸æ˜¯ï¼šendpoint URL ä¸ç¬¦åˆ / liffId éŒ¯ / ç¶²è·¯é˜»æ“‹
      setStatus("åˆå§‹åŒ–å¤±æ•—ï¼ˆLIFF initï¼‰ï¼š"+formatErr_(e), "err");
      return;
    }

    try{
      if(!liff.isLoggedIn()){
        setStatus("æœªç™»å…¥ LINEï¼Œè½‰ç™»å…¥ä¸­â€¦", "muted");
        liff.login();
        return;
      }
    }catch(e){
      console.error("LIFF login check failed:", e);
      setStatus("åˆå§‹åŒ–å¤±æ•—ï¼ˆç™»å…¥åˆ¤æ–·ï¼‰ï¼š"+formatErr_(e), "err");
      return;
    }

    try{
      const profile = await Promise.race([
        liff.getProfile(),
        new Promise((_,rej)=>setTimeout(()=>rej(new Error("getProfile timeout")), 9000))
      ]);

      userId = profile.userId || "";
      displayName = profile.displayName || "";
      $("user").innerText = `ä½ å¥½ï¼Œ${displayName || "åŒäº‹"}`;

      // âœ… æ ¸å¿ƒåŠŸèƒ½å…ˆé–‹
      bindCoreButtons();
      ready = true;
      enableAll(true);
      setStatus("å¯ä»¥æ“ä½œäº† âœ…", "ok");

    }catch(e){
      console.error("getProfile failed:", e);
      // é€™è£¡å¸¸è¦‹ï¼šLIFF scope æ²’å‹¾ profileã€æˆ– endpoint/è¨­å®šå•é¡Œ
      setStatus("åˆå§‹åŒ–å¤±æ•—ï¼ˆgetProfileï¼‰ï¼š"+formatErr_(e)+"ï¼ˆè«‹ç¢ºèª LIFF æœ‰é–‹ profile scope & endpoint URL æ­£ç¢ºï¼‰", "err");
      return;
    }

    // âœ… ç¬¬äºŒéšæ®µï¼šä¸»ç®¡åˆ¤æ–·ï¼ˆå¤±æ•—ä¸å½±éŸ¿æ‰“å¡ï¼‰
    try{
      const probe = await jsonp_({ action:"listRequests", userId, mode:"mine" });
      isManager = !!probe?.isManager;
      if(isManager) $("tabMgr").classList.remove("hidden");
    }catch(e){
      console.error("manager probe failed:", e);
      setStatus("å·²å¯æ‰“å¡ âœ…ï¼ˆæ¸…å–®è¼‰å…¥å¤±æ•—ï¼Œç¨å¾Œå†è©¦ï¼‰", "ok");
    }
  }

  init();
</script>
</body>
</html>
