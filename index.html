<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>HOLDON å‡ºå‹¤ç³»çµ±</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body{font-family:Arial;padding:16px;color:#111;}
    .card{border:1px solid #eee;border-radius:14px;padding:14px;margin:12px 0;}
    .row{display:flex;gap:10px;flex-wrap:wrap;}
    .btn{padding:10px 14px;border-radius:999px;border:1px solid #ddd;background:#fff;}
    .btn.primary{border-color:#111;}
    .btn:disabled{opacity:.4}
    .status{margin-top:8px;font-size:13px}
    .ok{color:#0a7a2f}
    .err{color:#b00020}
  </style>
</head>

<body>
<h2>HOLDON å‡ºå‹¤ç³»çµ±</h2>

<div class="card">
  <div id="user">è¼‰å…¥ä¸­â€¦</div>
  <div id="status" class="status"></div>

  <div class="row" style="margin-top:10px">
    <button id="btnIn"  class="btn primary" disabled>ğŸŸ¢ ä¸Šç­æ‰“å¡</button>
    <button id="btnOut" class="btn primary" disabled>ğŸ”´ ä¸‹ç­æ‰“å¡</button>
  </div>
</div>

<script>
/* ================== åŸºæœ¬è¨­å®š ================== */
const LIFF_ID = "2009036245-XmZMSuuS";
const GAS_URL = "https://script.google.com/macros/s/AKfycbz0YAlbpIYDqN6UC99TmaksEfzylud1QzuwTaupCp9zGdpUlReuRxaG8cvryxziHli_/exec";

/* å…¬å¸ GPSï¼ˆâš ï¸ ä½ è¦æ”¹ï¼‰ */
const COMPANY_LAT = 25.033964;   // â† å…¬å¸ç·¯åº¦
const COMPANY_LNG = 121.564468;  // â† å…¬å¸ç¶“åº¦
const ALLOW_DISTANCE = 100;      // å…¬å°º

let userId="", displayName="", ready=false;

/* ================== å·¥å…· ================== */
const $ = id => document.getElementById(id);
function setStatus(msg,type=""){
  $("status").className = "status "+type;
  $("status").innerText = msg;
}

/* Haversine è¨ˆç®—è·é›¢ï¼ˆå…¬å°ºï¼‰ */
function calcDistance(lat1,lng1,lat2,lng2){
  const R = 6371000;
  const toRad = d=>d*Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLng = toRad(lng2-lng1);
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
    Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* ================== GPS é˜²å‘† ================== */
function getGPS(){
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation){
      reject("è£ç½®ä¸æ”¯æ´ GPS");
      return;
    }
    navigator.geolocation.getCurrentPosition(
      pos=>{
        const {latitude, longitude} = pos.coords;
        const d = calcDistance(latitude, longitude, COMPANY_LAT, COMPANY_LNG);
        if(d > ALLOW_DISTANCE){
          reject(`ä¸åœ¨æ‰“å¡ç¯„åœå…§ï¼ˆè·é›¢ ${Math.round(d)} å…¬å°ºï¼‰`);
        }else{
          resolve({latitude, longitude, distance:d});
        }
      },
      err=>reject("GPS å–å¾—å¤±æ•—ï¼Œè«‹é–‹å•Ÿå®šä½"),
      {enableHighAccuracy:true, timeout:10000}
    );
  });
}

/* ================== JSONP å¯«å…¥ ================== */
function jsonpWrite(params, okMsg){
  return new Promise((resolve,reject)=>{
    const cb = "cb_"+Date.now();
    params.callback = cb;

    window[cb] = data=>{
      delete window[cb];
      script.remove();
      if(data && data.ok){
        setStatus(okMsg,"ok");
        resolve();
      }else{
        reject(data?.message || "é€å‡ºå¤±æ•—");
      }
    };

    const script = document.createElement("script");
    script.src = GAS_URL + "?" + new URLSearchParams(params).toString();
    script.onerror = ()=>reject("é€£ç·šå¤±æ•—");
    document.body.appendChild(script);
  }).catch(e=>{
    setStatus(e,"err");
  });
}

/* ================== æ‰“å¡ ================== */
async function punch(type){
  if(!ready) return;
  setStatus("å®šä½ä¸­â€¦");
  $("btnIn").disabled = $("btnOut").disabled = true;

  try{
    const gps = await getGPS();
    await jsonpWrite({
      action:"punch",
      type,
      userId,
      displayName,
      lat:gps.latitude,
      lng:gps.longitude,
      distance:Math.round(gps.distance),
      ts:Date.now()
    }, type==="IN"?"ä¸Šç­æ‰“å¡æˆåŠŸ âœ…":"ä¸‹ç­æ‰“å¡æˆåŠŸ âœ…");
  }finally{
    $("btnIn").disabled = $("btnOut").disabled = false;
  }
}

/* ================== åˆå§‹åŒ– ================== */
async function init(){
  setStatus("åˆå§‹åŒ–ä¸­â€¦");

  try{
    await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser:true });
    if(!liff.isLoggedIn()){ liff.login(); return; }

    const p = await liff.getProfile();
    userId = p.userId;
    displayName = p.displayName;
    $("user").innerText = `ä½ å¥½ï¼Œ${displayName}`;

    $("btnIn").onclick  = ()=>punch("IN");
    $("btnOut").onclick = ()=>punch("OUT");

    $("btnIn").disabled = $("btnOut").disabled = false;
    ready = true;
    setStatus("å¯ä»¥æ‰“å¡","ok");

  }catch(e){
    console.error(e);
    setStatus("åˆå§‹åŒ–å¤±æ•—ï¼š"+e,"err");
  }
}

init();
</script>
</body>
</html>
