<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>å¡«å¯«ç”³è«‹å–®</title>
  <style>
    :root { --primary:#4F46E5; --bg:#F3F4F6; --card:#FFFFFF; --text:#1F2937; }
    body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; background:var(--bg); margin:0; padding:20px 20px 80px; color:var(--text); }
    h2 { font-size:20px; margin:0 0 10px; font-weight:800; }
    .hint { font-size:12px; color:#6B7280; margin:0 0 14px; line-height:1.4; }

    .card { background:var(--card); border-radius:18px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.04); }
    .form-group { margin-bottom:16px; }
    label { display:block; font-size:14px; font-weight:700; margin-bottom:8px; color:#4B5563; }

    input, select, textarea {
      width:100%; padding:12px; border-radius:12px; border:1px solid #E5E7EB;
      background:#fff; font-size:16px; box-sizing:border-box; -webkit-appearance:none;
    }
    input:focus, select:focus, textarea:focus { outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(79,70,229,.12); }
    textarea { resize:vertical; min-height:86px; }

    .chiprow { display:flex; gap:10px; flex-wrap:wrap; }
    .chip {
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border:1px solid #E5E7EB; border-radius:12px; background:#fff;
      user-select:none;
    }
    .chip input { width:auto; }

    .noteBox{
      background:#F9FAFB; border:1px solid #E5E7EB; padding:12px; border-radius:12px;
      font-size:13px; color:#6B7280; line-height:1.45;
    }

    .btn-submit {
      width:100%; background:var(--primary); color:#fff;
      padding:14px; border:none; border-radius:14px;
      font-size:16px; font-weight:800; margin-top:10px; cursor:pointer;
      box-shadow:0 10px 22px rgba(79,70,229,.18);
    }
    .btn-submit:disabled { opacity:.55; cursor:not-allowed; box-shadow:none; }

    .nav {
      position:fixed; bottom:0; left:0; right:0; background:var(--card);
      padding:12px 20px; padding-bottom:max(12px, env(safe-area-inset-bottom));
      display:flex; justify-content:space-around;
      box-shadow:0 -4px 20px rgba(0,0,0,.06);
      border-top-left-radius:24px; border-top-right-radius:24px; z-index:100;
    }
    .nav-item { text-decoration:none; color:#9CA3AF; display:flex; flex-direction:column; align-items:center; font-size:10px; gap:4px; }
    .nav-item.active { color:var(--primary); }
    .nav-icon { font-size:22px; }
  </style>
</head>
<body>

  <h2>ğŸ“ å¡«å¯«ç”³è«‹å–®</h2>

  <div class="card">
    <div class="form-group">
      <label>ç”³è«‹é¡å‹</label>
      <select id="cat">
        <option value="LEAVE">è«‹å‡</option>
        <option value="OT">åŠ ç­</option>
        <option value="OUTING">å¤–å‡º</option>
        <option value="CORRECTION">è£œå¡</option>
      </select>
    </div>

    <div class="form-group" id="typeGroup">
      <label>å‡åˆ¥</label>
      <select id="type">
        <option value="annual">ç‰¹ä¼‘</option>
        <option value="comp">è£œä¼‘</option>
        <option value="personal">äº‹å‡</option>
        <option value="sick">ç—…å‡</option>
        <option value="official">å…¬å‡</option>
        <option value="marriage">å©šå‡</option>
        <option value="bereavement">å–ªå‡</option>
        <option value="menstrual">ç”Ÿç†å‡</option>
        <option value="maternity">ç”¢å‡</option>
        <option value="paternity">é™ªç”¢å‡</option>
        <option value="family">å®¶åº­ç…§é¡§å‡</option>
        <option value="birthday">ç”Ÿæ—¥å‡</option>
      </select>
    </div>

    <div class="form-group" id="correctionTypeGroup" style="display:none;">
      <label>è£œå¡é¡å‹</label>
      <select id="correctionType">
        <option value="IN">è£œä¸Šç­ï¼ˆè£œæ‰“å¡ï¼šä¸Šç­ï¼‰</option>
        <option value="OUT">è£œä¸‹ç­ï¼ˆè£œæ‰“å¡ï¼šä¸‹ç­ï¼‰</option>
      </select>
    </div>

    <div class="form-group">
      <label id="startLabel">é–‹å§‹æ™‚é–“</label>
      <input type="datetime-local" id="start">
    </div>

    <div class="form-group" id="endWrap">
      <label>çµæŸæ™‚é–“</label>
      <input type="datetime-local" id="end">
    </div>

    <div class="form-group" id="extraGroup" style="display:none;">
      <div class="chiprow">
        <label class="chip"><input type="checkbox" id="isTrip"/> å‡ºå·®ï¼ˆå¤–å‡ºå¯è¶…é 8 å°æ™‚ï¼‰</label>
        <label class="chip"><input type="checkbox" id="autoClock"/> å¤–å‡ºå–®åŒæ™‚è‡ªå‹•æ‰“å¡</label>
      </div>
    </div>

    <div class="form-group" id="hoursGroup">
      <label>æ™‚æ•¸ï¼ˆ0.5 å°æ™‚ç‚ºå–®ä½ï¼‰</label>
      <input type="number" id="hours" value="0.0" step="0.5" min="0">
    </div>

    <div class="form-group">
      <label>äº‹ç”±</label>
      <textarea id="reason" placeholder="è«‹å¡«å¯«èªªæ˜..."></textarea>
    </div>

    <div class="noteBox" id="noteBox"></div>

    <button class="btn-submit" id="submitBtn" type="button">é€å‡ºç”³è«‹</button>
  </div>

  <nav class="nav">
    <a href="app.html" class="nav-item"><span class="nav-icon">ğŸ </span>é¦–é </a>
    <a href="request.html" class="nav-item active"><span class="nav-icon">ğŸ“</span>ç”³è«‹</a>
    <a href="history.html" class="nav-item"><span class="nav-icon">ğŸ“‹</span>ç´€éŒ„</a>
    <a href="schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span>æ’ç­</a>
    <a href="manager.html" class="nav-item" id="mgrBtn" style="display:none;"><span class="nav-icon">ğŸ‘‘</span>ä¸»ç®¡</a>
  </nav>

  <script src="config.js"></script>
  <script>
    /* ==============================
     * 0) èº«ä»½
     * ============================== */
    const empId =
      localStorage.getItem("empId") ||
      localStorage.getItem("employeeId") ||
      "";

    const userId =
      localStorage.getItem("lineUserId") ||
      localStorage.getItem("LineUserId") ||
      localStorage.getItem("userId") ||
      "";

    const uid = empId || userId || "";

    const isMgr = (localStorage.getItem("isManager") === "true") || !!localStorage.getItem("managerId");
    if (isMgr) document.getElementById("mgrBtn").style.display = "flex";
    if (!uid) location.href = "index.html";

    /* ==============================
     * 1) API (å‡ç´šç‰ˆï¼šä½¿ç”¨ç¾ä»£ fetch API ç™¼é€ POST è«‹æ±‚)
     * ============================== */
    async function api(action, data = {}) {
      const ENDPOINT = window.CONFIG && (window.CONFIG.GAS_ENDPOINT || window.CONFIG.API_BASE || window.CONFIG.API_URL);
      if (!ENDPOINT) {
        alert("ç³»çµ±è¨­å®šéŒ¯èª¤ï¼šæ‰¾ä¸åˆ° CONFIG.GAS_ENDPOINT");
        throw new Error("Missing CONFIG.GAS_ENDPOINT");
      }

      // ä¿ç•™åŸæœ¬ request.html å°ˆå±¬çš„æ¬„ä½çµ„è£é‚è¼¯
      const payloadObj = Object.assign({}, data, {
        empId: empId || undefined,
        userId: userId || undefined
      });

      if (window.CONFIG && window.CONFIG.WEBHOOK_KEY && payloadObj.webhookKey == null) {
        payloadObj.webhookKey = window.CONFIG.WEBHOOK_KEY;
      }

      const payloadBody = {
        action: action,
        payload: payloadObj
      };

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000);

        const response = await fetch(ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain;charset=utf-8', 
          },
          body: JSON.stringify(payloadBody),
          redirect: 'follow',
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`HTTP éŒ¯èª¤ç‹€æ…‹ç¢¼: ${response.status}`);
        }

        const result = await response.json();
        return result;

      } catch (error) {
        console.error("API å‘¼å«å¤±æ•—:", error);
        if (error.name === 'AbortError') {
           throw new Error("ç¶²è·¯é€£ç·šé€¾æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦");
        }
        throw new Error("ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é˜²è­·å¤–æ›è¨­å®š");
      }
    }

    /* ==============================
     * 2) æ™‚é–“å·¥å…·ï¼ˆdatetime-local ä¸€å¾‹æ‰‹å‹•è§£æï¼‰
     * ============================== */
    function pad2(n) { return String(n).padStart(2, '0'); }

    function toLocalInputValue(d) {
      return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}T${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }

    function parseLocalInput(v){
      if(!v) return null;
      const m = String(v).match(/^(\d{4})-(\d{1,2})-(\d{1,2})T(\d{1,2}):(\d{2})$/);
      if(!m) return null;
      const y = Number(m[1]), mo = Number(m[2]), d = Number(m[3]), hh = Number(m[4]), mm = Number(m[5]);
      const dt = new Date(y, mo-1, d, hh, mm, 0, 0);
      return isNaN(dt.getTime()) ? null : dt;
    }

    function sameDay_(a, b) {
      return a.getFullYear() === b.getFullYear()
          && a.getMonth() === b.getMonth()
          && a.getDate() === b.getDate();
    }

    // Date -> "yyyy/MM/dd HH:mm" çµ¦å¾Œç«¯ï¼ˆä¸å«æ™‚å€ï¼‰
    function toServerDateTimeStr_(d){
      return `${d.getFullYear()}/${pad2(d.getMonth()+1)}/${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
    }

    // å‰ç«¯å‚™æ´ï¼š0.5 å°æ™‚å–®ä½
    function calcHoursLocalHalf_(s, e){
      const diffH = (e - s) / 36e5;
      if (!(diffH > 0)) return 0;
      return Math.round(diffH * 2) / 2;
    }

    /* ==============================
     * 3) å‰å°æç¤º
     * ============================== */
    const noteBox = document.getElementById("noteBox");
    function setNote(extraText){
      const cat = document.getElementById("cat").value;

      if(cat === "CORRECTION"){
        const ct = document.getElementById("correctionType").value;
        noteBox.textContent = (ct === "IN")
          ? "è£œå¡ï¼ˆä¸Šç­ï¼‰ï¼šåªéœ€é¸ä¸€å€‹æ™‚é–“é»ã€‚"
          : "è£œå¡ï¼ˆä¸‹ç­ï¼‰ï¼šåªéœ€é¸ä¸€å€‹æ™‚é–“é»ã€‚";
        return;
      }

      if(cat === "LEAVE"){
        noteBox.textContent = extraText || "è«‹å‡ï¼šä»¥ã€Œè«‹å‡âˆ©ç­åˆ¥ã€æ‰£é™¤ã€Œä¼‘æ¯é‡ç–Šã€è¨ˆç®—ï¼ˆåˆç­ 16:00â€“17:00 æœƒè‡ªå‹•æ‰£é™¤ï¼‰ã€‚";
        return;
      }

      if(cat === "OUTING"){
        noteBox.textContent = extraText || "å¤–å‡ºï¼šä¾å€é–“è¨ˆç®—ï¼ˆ0.5 å°æ™‚ï¼‰ï¼Œéå‡ºå·®æœ€å¤š 8 å°æ™‚ã€‚";
        return;
      }

      if(cat === "OT"){
        noteBox.textContent = extraText || "åŠ ç­ï¼šä¾å€é–“è¨ˆç®—ï¼ˆ0.5 å°æ™‚ï¼‰ã€‚";
        return;
      }

      noteBox.textContent = extraText || "";
    }

    /* ==============================
     * 4) UI åˆ‡æ›
     * ============================== */
    function toggleType() {
      const cat = document.getElementById("cat").value;

      const typeGroup = document.getElementById("typeGroup");
      const correctionTypeGroup = document.getElementById("correctionTypeGroup");
      const hoursGroup = document.getElementById("hoursGroup");
      const endWrap = document.getElementById("endWrap");
      const extraGroup = document.getElementById("extraGroup");
      const startLabel = document.getElementById("startLabel");

      if (cat === "CORRECTION") {
        typeGroup.style.display = "none";
        correctionTypeGroup.style.display = "block";
        hoursGroup.style.display = "none";
        endWrap.style.display = "none";
        extraGroup.style.display = "none";
        startLabel.textContent = "è£œå¡æ™‚é–“";
        document.getElementById("hours").value = "0.0";
        document.getElementById("end").value = "";
      } else if (cat === "OUTING") {
        typeGroup.style.display = "none";
        correctionTypeGroup.style.display = "none";
        hoursGroup.style.display = "block";
        endWrap.style.display = "block";
        extraGroup.style.display = "block";
        startLabel.textContent = "é–‹å§‹æ™‚é–“";
      } else if (cat === "OT") {
        typeGroup.style.display = "none";
        correctionTypeGroup.style.display = "none";
        hoursGroup.style.display = "block";
        endWrap.style.display = "block";
        extraGroup.style.display = "none";
        startLabel.textContent = "é–‹å§‹æ™‚é–“";
      } else {
        typeGroup.style.display = "block";
        correctionTypeGroup.style.display = "none";
        hoursGroup.style.display = "block";
        endWrap.style.display = "block";
        extraGroup.style.display = "none";
        startLabel.textContent = "é–‹å§‹æ™‚é–“";
      }

      setNote();
    }

    /* ==============================
     * 5) roster å‰ç«¯å¿«å– + ç­åˆ¥è¦å‰‡ï¼ˆEARLY/LATE/OFFï¼‰
     * ============================== */

    const __rosterCache = new Map(); 

    function ymKey_(y, m){ return `${y}-${pad2(m)}`; }

    // âœ… ä¿®æ”¹ï¼šé˜²å‘†æ™‚é–“æ¨æ–·ï¼ˆå¦‚æœæ²’æœ‰æ’ç­ï¼Œæœƒé€éé€™è£¡å›å‚³ nullï¼Œè®“å¾ŒçºŒè™•ç†ï¼‰
    function normalizeShiftValue(v){
      const s = String(v||'').trim().toLowerCase();
      if(!s) return null; // è®“ç³»çµ±çŸ¥é“æ‰¾ä¸åˆ°
      if (s.includes('ä¼‘') || s.includes('off')) return 'OFF';
      if (s.includes('åˆ') || s.includes('late')) return 'LATE';
      if (s.includes('æ—©') || s.includes('early')) return 'EARLY';
      return null;
    }

    // æ—©ç­ 10-18ï¼ˆç„¡ä¼‘ï¼‰ï¼›åˆç­ 12-21ï¼ˆä¼‘ 16-17ï¼‰ï¼›ä¼‘å‡ OFF
    function getShiftRuleByKey_(shiftKey){
      if(shiftKey === 'OFF') return { off:true, name:'ä¼‘' };
      if(shiftKey === 'LATE') return { inH:12, inM:0, outH:21, outM:0, breakStartH:16, breakStartM:0, breakEndH:17, breakEndM:0, name:'åˆ' };
      return { inH:10, inM:0, outH:18, outM:0, breakStartH:0, breakStartM:0, breakEndH:0, breakEndM:0, name:'æ—©' };
    }

    async function getRosterMonth_(y, m){
      const key = ymKey_(y, m);
      if(__rosterCache.has(key)) return __rosterCache.get(key);

      const res = await api("get_roster_data", { year:y, month:m });
      const roster = (res && res.ok && res.roster) ? res.roster : {};
      __rosterCache.set(key, roster);
      return roster;
    }

    function getMyShiftKeyForDay_(roster, day){
      const myId = empId || "";
      const cell = myId && roster[myId] ? roster[myId][day] : null;
      const val = (cell && typeof cell === 'object') ? (cell.value || cell.shift || cell.v) : cell;
      return normalizeShiftValue(val);
    }

    // åªè² è²¬ã€Œå¸¶å…¥è©²æ—¥ç­è¡¨æ™‚é–“ã€
    async function applyLeaveAutoTimeByRoster(){
      const cat = document.getElementById("cat").value;
      if(cat !== "LEAVE") return;

      const sVal = document.getElementById("start").value;
      const s = parseLocalInput(sVal);
      if(!s) return;

      const y = s.getFullYear();
      const m = s.getMonth()+1;
      const d = s.getDate();

      let shiftKey = null;
      try{
        const roster = await getRosterMonth_(y, m);
        shiftKey = getMyShiftKeyForDay_(roster, d);
      }catch(e){}

      // âœ… å‹•æ…‹æ¨æ–·ï¼šå¦‚æœæ‰¾ä¸åˆ°ç­åˆ¥ï¼Œä¾æ“šé–‹å§‹æ™‚é–“æ˜¯å¦é 12 é»æ±ºå®š
      if (!shiftKey) {
         shiftKey = (s.getHours() >= 12) ? 'LATE' : 'EARLY';
      }

      const rule = getShiftRuleByKey_(shiftKey);

      const startH = rule.off ? 10 : rule.inH;
      const startM = rule.off ? 0  : (rule.inM||0);
      const endH   = rule.off ? 18 : rule.outH;
      const endM   = rule.off ? 0  : (rule.outM||0);

      const ss = new Date(y, m-1, d, startH, startM, 0, 0);
      const ee = new Date(y, m-1, d, endH, endM, 0, 0);
      document.getElementById("start").value = toLocalInputValue(ss);
      document.getElementById("end").value   = toLocalInputValue(ee);

      await calcHoursSmart_();
    }

    /* ==============================
     * 6) OT/OUTINGï¼šèµ°å¾Œç«¯ calc_hours
     * ============================== */
    let __calcTimer = null;
    let __calcSeq = 0;

    async function calcHoursByServer_(){
      const mySeq = ++__calcSeq;

      const cat = document.getElementById("cat").value;
      if(cat === "CORRECTION"){
        document.getElementById("hours").value = "0.0";
        return;
      }

      const sVal = document.getElementById("start").value;
      const eVal = document.getElementById("end").value;
      if(!sVal || !eVal) return;

      const s = parseLocalInput(sVal);
      const e = parseLocalInput(eVal);

      if(!s || !e || e <= s){
        document.getElementById("hours").value = "0.0";
        return;
      }

      const leaveType = (cat === "LEAVE") ? (document.getElementById("type")?.value || "") :
                       (cat === "OT") ? "ot" :
                       (cat === "OUTING") ? "outing" : "";

      if(cat === "LEAVE" && leaveType === "birthday" && !sameDay_(s, e)) {
        document.getElementById("end").value = sVal;
        document.getElementById("hours").value = "0.0";
        return;
      }

      let fallbackH = calcHoursLocalHalf_(s, e);
      if(cat === "OUTING"){
        const isTrip = !!document.getElementById("isTrip").checked;
        if(!isTrip) fallbackH = Math.min(8, fallbackH);
      }

      try{
        const res = await api("calc_hours", {
          start: toServerDateTimeStr_(s),
          end: toServerDateTimeStr_(e),
          startServer: toServerDateTimeStr_(s),
          endServer: toServerDateTimeStr_(e),
          category: cat,
          leaveType: leaveType,
          startRaw: sVal,
          endRaw: eVal
        });

        if (mySeq !== __calcSeq) return;

        if(res && res.ok){
          let h = Number(res.hours || 0);

          if(cat === "OUTING"){
            const isTrip = !!document.getElementById("isTrip").checked;
            if(!isTrip) h = Math.min(8, h);
          }

          document.getElementById("hours").value = Number(h).toFixed(1);
          setNote();
        }else{
          document.getElementById("hours").value = Number(fallbackH).toFixed(1);
          setNote("ç³»çµ±æ™‚æ•¸è¨ˆç®—æš«æ™‚ä¸å¯ç”¨ï¼ˆå·²ç”¨æœ¬æ©Ÿå‚™æ´è¨ˆç®—ï¼‰ã€‚æœ€çµ‚ä»ä»¥ç³»çµ±å¯©æ ¸è¦å‰‡ç‚ºæº–ã€‚");
        }
      }catch(e){
        if (mySeq !== __calcSeq) return;
        document.getElementById("hours").value = Number(fallbackH).toFixed(1);
        setNote("ç³»çµ±æ™‚æ•¸è¨ˆç®—é€¾æ™‚ï¼ˆå·²ç”¨æœ¬æ©Ÿå‚™æ´è¨ˆç®—ï¼‰ã€‚æœ€çµ‚ä»ä»¥ç³»çµ±å¯©æ ¸è¦å‰‡ç‚ºæº–ã€‚");
      }
    }

    /* ==============================
     * 7) æ¨™æº– HR overlap è¨ˆç®—ï¼ˆLEAVE å°ˆç”¨ï¼‰
     * ============================== */
    function overlapMs_(aStart, aEnd, bStart, bEnd){
      const s = Math.max(aStart, bStart);
      const e = Math.min(aEnd, bEnd);
      return Math.max(0, e - s);
    }

    function dayStart_(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0); }

    function addDays_(d, n){
      const x = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0);
      x.setDate(x.getDate() + n);
      return x;
    }

    function calcLeaveHoursOneDay_(dateYMD, leaveStart, leaveEnd, rule){
      if(rule.off) return 0;

      const y = dateYMD.getFullYear();
      const m = dateYMD.getMonth();
      const d = dateYMD.getDate();

      const shiftStart = new Date(y, m, d, rule.inH,  rule.inM||0,  0, 0).getTime();
      const shiftEnd   = new Date(y, m, d, rule.outH, rule.outM||0, 0, 0).getTime();

      const reqStart = leaveStart.getTime();
      const reqEnd   = leaveEnd.getTime();

      const workMs = overlapMs_(reqStart, reqEnd, shiftStart, shiftEnd);
      if(workMs <= 0) return 0;

      let ms = workMs;

      if(rule.breakStartH || rule.breakEndH){
        const bStart = new Date(y, m, d, rule.breakStartH||0, rule.breakStartM||0, 0, 0).getTime();
        const bEnd   = new Date(y, m, d, rule.breakEndH||0,   rule.breakEndM||0,   0, 0).getTime();
        if(bEnd > bStart){
          const breakMs = overlapMs_(reqStart, reqEnd, bStart, bEnd);
          ms -= breakMs;
        }
      }

      const h = ms / 36e5;
      return Math.max(0, Math.round(h * 2) / 2);
    }

    async function calcLeaveHoursByRoster_(s, e){
      if(!s || !e || e <= s) return 0;

      let total = 0;

      const startDay = dayStart_(s);
      const endDay   = dayStart_(e);

      for(let cur = new Date(startDay); cur <= endDay; cur = addDays_(cur, 1)){
        const dayS = cur.getTime();
        const dayE = addDays_(cur, 1).getTime();

        const segStart = new Date(Math.max(s.getTime(), dayS));
        const segEnd   = new Date(Math.min(e.getTime(), dayE));
        if(segEnd <= segStart) continue;

        const y = cur.getFullYear();
        const m = cur.getMonth()+1;
        const d = cur.getDate();

        let shiftKey = null;
        try{
            const roster = await getRosterMonth_(y, m);
            shiftKey = getMyShiftKeyForDay_(roster, d);
        }catch(err){}

        // âœ… å‹•æ…‹åˆ¤æ–·ï¼šä¾æ“šæ­¤å€æ®µçš„é–‹å§‹æ™‚é–“ï¼Œæ±ºå®šæ˜¯ç”¨åˆç­é‚„æ˜¯æ—©ç­
        if (!shiftKey) {
            shiftKey = (segStart.getHours() >= 12) ? 'LATE' : 'EARLY';
        }

        const rule = getShiftRuleByKey_(shiftKey);
        total += calcLeaveHoursOneDay_(cur, segStart, segEnd, rule);
      }

      return Math.max(0, Math.round(total * 2) / 2);
    }

    /* ==============================
     * 8) Smart è¨ˆç®—ï¼šLEAVE èµ° overlapï¼›OT/OUTING èµ°å¾Œç«¯
     * ============================== */
    async function calcHoursSmart_(){
      const cat = document.getElementById("cat").value;

      if(cat === "CORRECTION"){
        document.getElementById("hours").value = "0.0";
        return;
      }

      const sVal = document.getElementById("start").value;
      const eVal = document.getElementById("end").value;
      if(!sVal || !eVal) return;

      const s = parseLocalInput(sVal);
      const e = parseLocalInput(eVal);
      if(!s || !e || e <= s){
        document.getElementById("hours").value = "0.0";
        return;
      }

      if(cat === "LEAVE"){
        const leaveType = document.getElementById("type")?.value || "";

        if(leaveType === "birthday" && !sameDay_(s, e)){
          document.getElementById("end").value = sVal;
          document.getElementById("hours").value = "0.0";
          return;
        }

        try{
          const h = await calcLeaveHoursByRoster_(s, e);
          document.getElementById("hours").value = Number(h).toFixed(1);
          setNote("è«‹å‡ï¼šä»¥ã€Œè«‹å‡âˆ©ç­åˆ¥ã€æ‰£é™¤ã€Œä¼‘æ¯é‡ç–Šã€è¨ˆç®—ï¼ˆåˆç­ 16:00â€“17:00 æœƒè‡ªå‹•æ‰£é™¤ï¼‰ã€‚");
        }catch(err){
          // fallback
          const rule = getShiftRuleByKey_(s.getHours() >= 12 ? 'LATE' : 'EARLY');
          let h = 0;

          for(let cur = dayStart_(s); cur <= dayStart_(e); cur = addDays_(cur,1)){
            const dayS = cur.getTime(), dayE = addDays_(cur,1).getTime();
            const segStart = new Date(Math.max(s.getTime(), dayS));
            const segEnd   = new Date(Math.min(e.getTime(), dayE));
            if(segEnd > segStart) h += calcLeaveHoursOneDay_(cur, segStart, segEnd, rule);
          }

          h = Math.round(h*2)/2;
          document.getElementById("hours").value = Number(h).toFixed(1);
          setNote("ç­è¡¨è®€å–å¤±æ•—ï¼šæš«ç”¨æ™‚é–“æ¨æ–·ä¼°ç®—ã€‚æœ€çµ‚ä»ä»¥å¯©æ ¸è¦å‰‡ç‚ºæº–ã€‚");
        }
        return;
      }

      await calcHoursByServer_();
    }

    function debounceCalc(){
      clearTimeout(__calcTimer);
      __calcTimer = setTimeout(()=>{ calcHoursSmart_(); }, 500);
    }

    /* ==============================
     * 9) é€å‡ºç”³è«‹
     * ============================== */
    async function submitReq() {
      const btn = document.getElementById("submitBtn");
      const cat = document.getElementById("cat").value;

      btn.disabled = true;
      btn.innerText = "é€å‡ºä¸­...";

      const start = document.getElementById("start").value;
      let end = document.getElementById("end").value;

      if (!start) {
        alert("è«‹å…ˆé¸æ“‡é–‹å§‹æ™‚é–“");
        btn.disabled = false;
        btn.innerText = "é€å‡ºç”³è«‹";
        return;
      }

      if (cat === "CORRECTION") {
        end = start;
      } else {
        if (!end) {
          alert("è«‹å…ˆé¸æ“‡çµæŸæ™‚é–“");
          btn.disabled = false;
          btn.innerText = "é€å‡ºç”³è«‹";
          return;
        }
      }

      const sObj = parseLocalInput(start);
      const eObj = parseLocalInput(end);
      if(!sObj || !eObj){
        alert("æ™‚é–“æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹é‡æ–°é¸æ“‡");
        btn.disabled = false;
        btn.innerText = "é€å‡ºç”³è«‹";
        return;
      }

      const hours = (cat === "CORRECTION") ? 0 : Number(document.getElementById("hours").value || 0);

      if (cat !== "CORRECTION" && hours <= 0) {
        alert("æ™‚æ•¸ä¸æ­£ç¢ºï¼šè«‹ç¢ºèªé–‹å§‹/çµæŸæ™‚é–“ï¼ˆè‹¥å‰›å¥½è½åœ¨ä¼‘æ¯æ™‚é–“ï¼Œæœƒç®— 0 ä¸¦ç¦æ­¢é€å‡ºï¼‰");
        btn.disabled = false;
        btn.innerText = "é€å‡ºç”³è«‹";
        return;
      }

      const leaveType =
        (cat === "LEAVE") ? document.getElementById("type").value :
        (cat === "OT") ? "ot" :
        (cat === "OUTING") ? "outing" : "correction";

      const data = {
        category: cat,
        leaveType,

        start: start,
        end: end,

        startServer: toServerDateTimeStr_(sObj),
        endServer: toServerDateTimeStr_(eObj),

        hours,
        reason: document.getElementById("reason").value || "",
        autoClock: (cat === "OUTING") ? !!document.getElementById("autoClock").checked : false,
        isTrip: (cat === "OUTING") ? !!document.getElementById("isTrip").checked : false
      };

      if (cat === "CORRECTION") {
        data.correctionType = document.getElementById("correctionType").value;
      }

      try {
        const res = await api("submit_request", data);
        if (res && res.ok) {
          alert("ç”³è«‹æˆåŠŸï¼");
          location.href = "history.html";
        } else {
          alert("å¤±æ•—ï¼š" + (res && res.message ? res.message : "unknown"));
          btn.disabled = false;
          btn.innerText = "é€å‡ºç”³è«‹";
        }
      } catch (e) {
        alert("ç¶²è·¯æˆ–ä¼ºæœå™¨é€¾æ™‚ï¼Œè«‹ç¨å¾Œé‡è©¦");
        btn.disabled = false;
        btn.innerText = "é€å‡ºç”³è«‹";
      }
    }

    /* ==============================
     * 10) ç¶å®šäº‹ä»¶
     * ============================== */
    (function bindAll() {
      const startEl = document.getElementById("start");
      const endEl = document.getElementById("end");
      const catEl = document.getElementById("cat");
      const typeEl = document.getElementById("type");
      const correctionTypeEl = document.getElementById("correctionType");
      const isTripEl = document.getElementById("isTrip");
      const autoClockEl = document.getElementById("autoClock");
      const hoursEl = document.getElementById("hours");
      const submitBtn = document.getElementById("submitBtn");

      const safeRecalc = () => { debounceCalc(); };

      [startEl, endEl].forEach(el => {
        if (!el) return;
        el.addEventListener("change", safeRecalc);
      });

      // ç›£è½æ‰‹å‹•ä¿®æ”¹æ™‚æ•¸
      if(hoursEl) {
          hoursEl.addEventListener("input", () => {
              // æ¨™è¨˜ç‚ºæ‰‹å‹•ä¿®æ”¹ï¼Œé˜²æ­¢è‡ªå‹•è¨ˆç®—è¦†è“‹ï¼ˆå¦‚æœéœ€è¦å¯ä»¥åšæ›´è¤‡é›œçš„æ¨™è¨˜ï¼‰
          });
      }

      catEl.addEventListener("change", async () => {
        toggleType();
        if (document.getElementById("cat").value === "LEAVE") {
          await applyLeaveAutoTimeByRoster(); 
        } else {
          debounceCalc();
        }
      });

      if(typeEl){
        typeEl.addEventListener("change", () => {
          debounceCalc();
        });
      }
      if(correctionTypeEl){
        correctionTypeEl.addEventListener("change", () => setNote());
      }
      if(isTripEl) isTripEl.addEventListener("change", debounceCalc);
      if(autoClockEl) autoClockEl.addEventListener("change", debounceCalc);

      submitBtn.addEventListener("click", submitReq);
    })();

    /* ==============================
     * 11) åˆå§‹åŒ–ï¼šé è¨­ä»Šå¤© 10:00-18:00
     * ============================== */
    (function initDefaultTime() {
      const now = new Date();
      const base = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 10, 0, 0, 0);
      const end = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 18, 0, 0, 0);
      document.getElementById("start").value = toLocalInputValue(base);
      document.getElementById("end").value = toLocalInputValue(end);
    })();

    toggleType();
    setNote();
    calcHoursSmart_();
  </script>
</body>
</html>
