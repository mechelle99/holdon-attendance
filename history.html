<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç”³è«‹ç´€éŒ„</title>
  <style>
    :root {
      --primary: #007aff;
      --bg: #f2f4f8;
      --card-bg: #ffffff;
      --text: #333;
      --gray: #8e8e93;
      --success: #34c759;
      --warning: #ff9500;
      --danger: #ff3b30;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background-color: var(--bg);
      margin: 0;
      padding: 20px;
      color: var(--text);
      padding-bottom: 80px; /* é ç•™åº•éƒ¨ç©ºé–“ */
    }

    /* é ‚éƒ¨å°èˆª */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .header h2 { margin: 0; font-size: 24px; }
    .btn-back {
      background: #e4e6eb;
      color: #333;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
    }

    /* ç¯©é¸å·¥å…·åˆ— */
    .filter-bar {
      background: var(--card-bg);
      padding: 15px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 20px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .filter-group label {
      display: block;
      font-size: 12px;
      color: var(--gray);
      margin-bottom: 4px;
      font-weight: 600;
    }
    .filter-select {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 15px;
      background: #f9f9f9;
      box-sizing: border-box;
      outline: none;
    }
    .filter-select:focus { border-color: var(--primary); background: #fff; }

    /* åˆ—è¡¨å€åŸŸ */
    .list-container {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    /* å¡ç‰‡æ¨£å¼ */
    .card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.03);
      position: relative;
      overflow: hidden;
      border-left: 5px solid transparent;
      transition: transform 0.2s;
    }
    .card:active { transform: scale(0.98); }

    /* ç‹€æ…‹é¡è‰²é‚Šæ¡† */
    .card[data-status="APPROVED"] { border-left-color: var(--success); }
    .card[data-status="PENDING"] { border-left-color: var(--warning); }
    .card[data-status="REJECTED"] { border-left-color: var(--danger); }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .card-type {
      font-size: 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .card-date {
      font-size: 13px;
      color: var(--gray);
      margin-top: 2px;
    }

    /* ç‹€æ…‹æ¨™ç±¤ */
    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .status-APPROVED { background: #e8f8ed; color: var(--success); }
    .status-PENDING { background: #fff8e6; color: var(--warning); }
    .status-REJECTED { background: #feecec; color: var(--danger); }

    .card-body {
      font-size: 14px;
      color: #555;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
      margin-top: 8px;
    }
    .card-footer {
      margin-top: 10px;
      font-size: 12px;
      color: var(--gray);
      text-align: right;
    }

    /* ç©ºç‹€æ…‹ */
    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--gray);
    }
    .empty-icon { font-size: 48px; margin-bottom: 10px; display: block; opacity: 0.5; }

  </style>
</head>
<body>

  <div class="header">
    <h2>ğŸ“‹ ç”³è«‹ç´€éŒ„</h2>
    <button class="btn-back" onclick="location.href='app.html'">â† è¿”å›</button>
  </div>

  <div class="filter-bar">
    <div class="filter-group">
      <label>ğŸ“… é¸æ“‡æœˆä»½</label>
      <input type="month" id="filterMonth" class="filter-select" onchange="renderList()">
    </div>
    <div class="filter-group">
      <label>âš¡ ç”³è«‹ç‹€æ…‹</label>
      <select id="filterStatus" class="filter-select" onchange="renderList()">
        <option value="ALL">å…¨éƒ¨é¡¯ç¤º</option>
        <option value="PENDING">â³ å¯©æ ¸ä¸­</option>
        <option value="APPROVED">âœ… å·²é€šé</option>
        <option value="REJECTED">âŒ å·²é§å›</option>
      </select>
    </div>
  </div>

  <div id="list" class="list-container">
    <div class="empty-state">
      <span class="empty-icon">ğŸ”„</span>
      <span>è³‡æ–™è¼‰å…¥ä¸­...</span>
    </div>
  </div>

<script src="config.js"></script>
<script>
  const uid = localStorage.getItem("employeeId");
  let allData = []; // æš«å­˜æ‰€æœ‰è³‡æ–™

  // åˆå§‹åŒ–æœˆä»½é¸æ“‡å™¨ç‚ºç•¶æœˆ
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth() + 1).padStart(2, '0');
  document.getElementById("filterMonth").value = `${yyyy}-${mm}`;

  function api(act) {
    return new Promise(r => {
      const s = document.createElement("script");
      s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${act}&payload=${encodeURIComponent(JSON.stringify({userId:uid}))}&callback=cb${Date.now()}`;
      window[`cb${Date.now()}`] = (res) => { r(res); s.remove(); };
      document.body.appendChild(s);
    });
  }

  // è¼‰å…¥è³‡æ–™
  async function load() {
      const res = await api("list_requests");
      const listDiv = document.getElementById("list");
      
      if(res.ok && res.list.length > 0) {
          allData = res.list; // å­˜å…¥å…¨åŸŸè®Šæ•¸
          renderList();       // åŸ·è¡Œæ¸²æŸ“
      } else {
          listDiv.innerHTML = `
            <div class="empty-state">
              <span class="empty-icon">ğŸ“­</span>
              <span>ç›®å‰æ²’æœ‰ä»»ä½•ç”³è«‹ç´€éŒ„</span>
            </div>`;
      }
  }

  // æ¸²æŸ“åˆ—è¡¨ (å«ç¯©é¸é‚è¼¯)
  function renderList() {
      const filterM = document.getElementById("filterMonth").value; // yyyy-MM
      const filterS = document.getElementById("filterStatus").value; // ALL/PENDING...
      const div = document.getElementById("list");

      // ç¯©é¸è³‡æ–™
      const filtered = allData.filter(item => {
          // 1. æ™‚é–“ç¯©é¸ (æ¯”å° yyyy-MM)
          const itemDate = item.start.substring(0, 7); // å– "2026-02"
          const matchDate = (itemDate === filterM);

          // 2. ç‹€æ…‹ç¯©é¸
          const matchStatus = (filterS === 'ALL') || (item.status === filterS);

          return matchDate && matchStatus;
      });

      // ç”¢ç”Ÿ HTML
      if (filtered.length === 0) {
          div.innerHTML = `
            <div class="empty-state">
              <span class="empty-icon">ğŸ”</span>
              <span>é€™å€‹æœˆæ²’æœ‰ç¬¦åˆçš„è³‡æ–™</span>
            </div>`;
          return;
      }

      let html = "";
      filtered.forEach(r => {
          // ä¸­æ–‡å°ç…§èˆ‡åœ–ç¤º
          let typeLabel = r.leaveType;
          let icon = "ğŸ“„";
          
          if(r.category === 'CORRECTION') { typeLabel = "è£œå¡ç”³è«‹"; icon = "â°"; }
          else if(r.category === 'OT') { typeLabel = "åŠ ç­ç”³è«‹"; icon = "ğŸ’ª"; }
          else if(r.category === 'OUTING') { typeLabel = "å¤–å‡ºå–®"; icon = "ğŸ›µ"; }
          else {
              // å‡åˆ¥ç¿»è­¯
              const map = {
                  'annual': 'ç‰¹ä¼‘', 'comp': 'è£œä¼‘', 'sick': 'ç—…å‡', 
                  'personal': 'äº‹å‡', 'official': 'å…¬å‡', 
                  'maternity': 'ç”¢å‡', 'bereavement': 'å–ªå‡'
              };
              if(map[typeLabel]) typeLabel = map[typeLabel];
              icon = "ğŸ–ï¸";
          }

          // ç‹€æ…‹ä¸­æ–‡
          let statusText = r.status;
          if(statusText === 'PENDING') statusText = 'å¯©æ ¸ä¸­';
          if(statusText === 'APPROVED') statusText = 'å·²é€šé';
          if(statusText === 'REJECTED') statusText = 'å·²é§å›';

          // æ™‚é–“é¡¯ç¤ºå„ªåŒ–
          const dateStr = r.start.replace('T', ' ').substring(0, 16); // å»æ‰ç§’
          const hoursStr = (r.hours > 0) ? ` â€¢ ${r.hours} å°æ™‚` : '';

          html += `
          <div class="card" data-status="${r.status}">
            <div class="card-header">
              <div class="card-type">
                <span>${icon}</span>
                <span>${typeLabel}</span>
              </div>
              <div class="status-badge status-${r.status}">${statusText}</div>
            </div>
            
            <div class="card-date">
              ğŸ“… ${dateStr} ${hoursStr}
            </div>

            <div class="card-body">
              ${r.reason || 'ç„¡å¡«å¯«äº‹ç”±'}
            </div>
            
            <div class="card-footer">
              å–®è™Ÿ: ${r.reqId}
            </div>
          </div>`;
      });

      div.innerHTML = html;
  }

  // å•Ÿå‹•
  load();
</script>
</body>
</html>
