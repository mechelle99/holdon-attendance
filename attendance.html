<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>出勤檢視</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#f4f6f8;padding:16px;margin:0;}
    .header{margin-bottom:15px;display:flex;gap:10px;align-items:center;}
    .card{background:#fff;padding:12px;border-radius:12px;margin-bottom:10px;box-shadow:0 2px 5px rgba(0,0,0,0.05);display:flex;align-items:center;}
    
    .date-box{width:60px;text-align:center;border-right:1px solid #eee;margin-right:10px;}
    .date-day{font-size:18px;font-weight:bold;color:#333;}
    .date-w{font-size:12px;color:#999;}
    
    .info{flex:1;}
    .time-row{font-size:14px;color:#444;line-height:1.6;}
    .time-row span{color:#999;font-size:12px;margin-right:5px;}
    
    .tag{font-size:13px;padding:4px 10px;border-radius:6px;color:#fff;font-weight:bold;min-width:60px;text-align:center;}
    
    /* 狀態顏色 */
    .ok{background:#34c759}       /* 正常 */
    .late{background:#ff9500}     /* 遲到/早退 */
    .miss{background:#ff3b30}     /* 缺卡/曠職 */
    .abn{background:#8e8e93}      /* 異常(超時) - 改為灰色或自訂 */
    .off{background:#e5e5ea;color:#999} /* 排休 */
    .leave{background:#007aff}    /* 請假 */

    select{padding:8px;border-radius:8px;border:1px solid #ddd;font-size:16px;}
    button{padding:8px 15px;background:#111;color:#fff;border:none;border-radius:8px;font-size:14px;}
  </style>
</head>
<body>
  <div class="header">
    <button onclick="location.href='app.html'">←</button>
    <select id="y"></select><select id="m"></select>
    <button onclick="load()">查詢</button>
  </div>
  <div id="list"></div>

  <script src="config.js"></script>
  <script>
    const uid=localStorage.getItem("employeeId");
    const yS=document.getElementById("y"), mS=document.getElementById("m");
    const now=new Date();
    // 預設選單
    for(let i=2024;i<=2026;i++) yS.add(new Option(i,i,i===now.getFullYear(),i===now.getFullYear()));
    for(let i=1;i<=12;i++) mS.add(new Option(i,i,i===(now.getMonth()+1),i===(now.getMonth()+1)));

    function api(a,d={}){
      return new Promise(r=>{
        const s=document.createElement("script");
        s.src=`${window.CONFIG.GAS_ENDPOINT}?action=${a}&payload=${encodeURIComponent(JSON.stringify({...d,userId:uid}))}&callback=cb${Date.now()}`;
        window[`cb${Date.now()}`]=(res)=>{r(res);s.remove()};
        document.body.appendChild(s);
      });
    }

    // 將 HH:mm:ss 轉為分鐘數 (例如 10:00 -> 600)
    function toMins(tStr) {
      if(!tStr) return -1;
      const p = tStr.split(':');
      return parseInt(p[0])*60 + parseInt(p[1]);
    }

    async function load(){
      document.getElementById("list").innerHTML = "<div style='text-align:center;margin-top:20px;color:#999'>載入中...</div>";
      const y=parseInt(yS.value), m=parseInt(mS.value);
      const r = await api("get_dashboard", {year:y, month:m});
      
      const d = document.getElementById("list");
      d.innerHTML = "";
      
      if(r.ok && r.schedule) {
        const daysInMonth = new Date(y, m, 0).getDate();
        const map = {};
        
        // 1. 初始化每一天 (預設早班)
        for(let i=1; i<=daysInMonth; i++) map[i] = { shift: r.schedule[i] || 'EARLY', in:null, out:null, leave:null };
        
        // 2. 填入打卡時間
        r.clocks.forEach(c => {
          // c.date 格式 YYYY-MM-DD
          const day = parseInt(c.date.split('-')[2]); 
          if(map[day]) {
            if(c.type.includes('上班')) map[day].in = c.time;
            if(c.type.includes('下班')) map[day].out = c.time;
          }
        });

        // 3. 填入請假
        if(r.leaves) {
          r.leaves.forEach(l => {
            const day = parseInt(l.date.split('-')[2]);
            if(map[day]) map[day].leave = l.type;
          });
        }

        // 4. 渲染 (倒序: 從月底到1號)
        // ★重點：今天以後的日期不顯示
        const today = new Date();
        today.setHours(23,59,59,999); // 包含今天

        for(let i=daysInMonth; i>=1; i--) {
          const currentLoopDate = new Date(y, m-1, i);
          if (currentLoopDate > today) continue; // 未來日期跳過

          const item = map[i];
          const weekDay = ['日','一','二','三','四','五','六'][currentLoopDate.getDay()];
          
          let stTag="正常", stCls="ok";
          
          // --- 狀態判斷邏輯開始 ---
          if (item.leave) {
             stTag = item.leave; stCls = "leave";
          } 
          else if (item.shift === 'OFF') {
             stTag = "休假"; stCls = "off"; // 排休
             if(item.in || item.out) { stTag="加班"; stCls="ok"; }
          } 
          else {
             // 工作日: 曠職/缺卡/遲到/早退/異常/正常
             if(!item.in && !item.out) { 
                 stTag="曠職"; stCls="miss"; 
             }
             else if(!item.in) { 
                 stTag="缺上班卡"; stCls="miss"; 
             }
             else if(!item.out) { 
                 stTag="缺下班卡"; stCls="miss"; 
             }
             else {
                // 有上班也有下班，進行時間計算
                const minsIn = toMins(item.in);
                const minsOut = toMins(item.out);
                
                // 設定標準時間 (分)
                // 早班: 10:00(600) ~ 18:00(1080)
                // 午班: 12:00(720) ~ 21:00(1260)
                let stdIn = 600, stdOut = 1080;
                if(item.shift === 'LATE') { stdIn = 720; stdOut = 1260; }

                let isLate = minsIn > stdIn;
                let isEarly = minsOut < stdOut; // ★這裡修正了早退判斷
                let isAbn = minsOut >= (stdOut + 60); // 超過1小時

                if (isAbn) {
                    stTag = "異常"; stCls = "abn";
                } else if (isLate && isEarly) {
                    stTag = "遲到/早退"; stCls = "late";
                } else if (isLate) {
                    stTag = "遲到"; stCls = "late";
                } else if (isEarly) {
                    stTag = "早退"; stCls = "late";
                } else {
                    stTag = "正常"; stCls = "ok";
                }
             }
          }
          // --- 狀態判斷邏輯結束 ---

          d.innerHTML += `
            <div class="card">
              <div class="date-box">
                <div class="date-day">${i}</div>
                <div class="date-w">${weekDay}</div>
              </div>
              <div class="info">
                <div class="time-row"><span>上班</span> ${item.in||'--:--'}</div>
                <div class="time-row"><span>下班</span> ${item.out||'--:--'}</div>
              </div>
              <div class="tag ${stCls}">${stTag}</div>
            </div>`;
        }
        
        if(d.innerHTML === "") d.innerHTML = "<div style='text-align:center;padding:20px;color:#999'>本月尚無已到期的紀錄</div>";

      } else { d.innerHTML = "<div style='text-align:center'>無資料</div>"; }
    }
    
    // 初始化載入
    load();
  </script>
</body>
</html>
