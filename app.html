<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å“¡å·¥ç³»çµ±</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f7fa; padding: 20px; }
    
    /* ä¸Šæ–¹è³‡è¨Šå¡ (é¤˜é¡) */
    .info-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .user-name { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; }
    .balance-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .bal-box { background: #f8f9fa; padding: 10px; border-radius: 8px; text-align: center; }
    .bal-label { font-size: 13px; color: #666; }
    .bal-num { font-size: 20px; font-weight: bold; color: #007aff; }

    /* æ‰“å¡æŒ‰éˆ• (åªç•™ä¸Šä¸‹ç­) */
    .clock-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
    .btn-clock { padding: 25px; font-size: 18px; border: none; border-radius: 12px; color: white; cursor: pointer; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .btn-in { background: linear-gradient(135deg, #34c759, #30b753); }
    .btn-out { background: linear-gradient(135deg, #ff9500, #e68600); }
    
    /* ä¸‹æ–¹é¸å–® */
    .menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .btn-menu { background: white; border: 1px solid #ddd; padding: 15px; border-radius: 8px; text-align: center; text-decoration: none; color: #333; font-weight: 500; font-size: 15px; }
    
    #gpsStatus { text-align: center; font-size: 12px; color: #999; margin-bottom: 10px; }

    /* æ–°å¢ CSS */
    .rec-time { font-size: 14px; text-align: right; flex: 1; margin-right: 10px; line-height: 1.4; color:#333; }
    .status-tag { font-size: 12px; padding: 3px 8px; border-radius: 4px; color: #fff; font-weight: bold; min-width: 50px; text-align: center; }
    .st-ok { background: #34c759; } /* æ­£å¸¸ */
    .st-late { background: #ffcc00; color: #333; } /* é²åˆ°/æ—©é€€ */
    .st-miss { background: #ff3b30; } /* ç¼ºå¡/æ› è· */
    .st-abn { background: #5856d6; } /* ç•°å¸¸(è¶…æ™‚) */
    .st-off { background: #ccc; color: #fff; } /* ä¼‘å‡ */
    .st-leave { background: #007aff; } /* è«‹å‡ */
    .hidden { display: none; }
    #loading{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);display:none;justify-content:center;align-items:center;z-index:999;}
    .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .btn { background: #007aff; color: white; padding: 10px; border: none; border-radius: 8px; cursor: pointer; }
    .search-bar select { padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
  </style>
</head>
<body>

<div class="info-card">
  <div class="user-name">Hi, <span id="uName">è¼‰å…¥ä¸­...</span></div>
  <div class="balance-grid">
    <div class="bal-box">
      <div class="bal-label">ç‰¹ä¼‘å‰©é¤˜</div>
      <div class="bal-num" id="annBal">0</div>
    </div>
    <div class="bal-box">
      <div class="bal-label">è£œä¼‘å‰©é¤˜</div>
      <div class="bal-num" id="compBal">0</div>
    </div>
  </div>
</div>

<div id="gpsStatus">âš ï¸ å®šä½ä¸­...</div>

<div class="clock-grid">
  <button class="btn-clock btn-in" onclick="clock('clock_in')">ä¸Šç­æ‰“å¡</button>
  <button class="btn-clock btn-out" onclick="clock('clock_out')">ä¸‹ç­æ‰“å¡</button>
</div>

<div class="menu-grid">
  <a href="request.html" class="btn-menu">ğŸ“ ç”³è«‹ä½œæ¥­</a>
  <a href="attendance.html" class="btn-menu">ğŸ“… å‡ºå‹¤ç´€éŒ„</a>
  <a href="roster.html" class="btn-menu">ğŸ“Š æ’ç­è¡¨</a>
  <a href="manager.html" class="btn-menu" id="mgrBtn" style="display:none; color:#007aff;">ğŸ‘¨â€ğŸ’¼ ä¸»ç®¡å°ˆå€</a>
</div>

<div class="card hidden" id="admBtns">
  <!-- ç®¡ç†æŒ‰éˆ•ï¼Œå¦‚æœæœ‰æ¬Šé™é¡¯ç¤º -->
</div>

<div class="card">
  <h3 style="margin:0">ğŸ“ ç”³è«‹</h3>
  <!-- ç”³è«‹æŒ‰éˆ• -->
</div>

<div class="card">
  <button class="btn" style="width:100%;background:#333;color:#fff;" onclick="location.href='attendance.html'">
    ğŸ“… æŸ¥çœ‹è©³ç´°å‡ºå‹¤ç´€éŒ„
  </button>
</div>

<div class="card">
  <h3 style="margin:0 0 10px">ğŸ“Š å‡ºå‹¤æª¢è¦–</h3>
  <div class="search-bar" style="display:flex;gap:5px;">
    <select id="y"></select><select id="m"></select>
    <button class="btn" style="width:auto;margin:0;padding:0 15px;" onclick="search()">æœ</button>
  </div>
  <div id="resList" style="margin-top:10px;"></div>
</div>

<div id="loading">è¼‰å…¥ä¸­...</div>

<script src="config.js"></script>
<script>
  const uid = localStorage.getItem("employeeId");
  if(!uid) location.href='index.html';

  let lat='', lng='';
  navigator.geolocation.getCurrentPosition(
    p => { lat=p.coords.latitude; lng=p.coords.longitude; document.getElementById('gpsStatus').innerText='âœ… GPS å·²å®šä½'; },
    e => { document.getElementById('gpsStatus').innerText='âš ï¸ å®šä½å¤±æ•—'; }
  );

  function api(act, data={}) {
    return new Promise(resolve => {
      const endpoint = window.CONFIG ? window.CONFIG.GAS_ENDPOINT : null;
      if (!endpoint) { alert("æ‰¾ä¸åˆ° CONFIG.GAS_ENDPOINT"); return; }

      const cbName = `cb_${Date.now()}_${Math.floor(Math.random()*100000)}`;
      const s = document.createElement("script");

      const payloadStr = JSON.stringify({ ...data, userId: uid });

      window[cbName] = (res) => {
        resolve(res);
        try { delete window[cbName]; } catch(e){}
        s.remove();
      };

      s.onerror = () => {
        resolve({ ok: false, message: "JSONP è¼‰å…¥å¤±æ•—" });
        try { delete window[cbName]; } catch(e){}
        s.remove();
      };

      s.src = `${endpoint}?action=${encodeURIComponent(act)}&payload=${encodeURIComponent(payloadStr)}&callback=${encodeURIComponent(cbName)}`;
      document.body.appendChild(s);
    });
  }

  async function init() {
    const res = await api("get_me");
    if(res.ok) {
      document.getElementById("uName").innerText = res.emp.name || localStorage.getItem("employeeName");
      document.getElementById("annBal").innerText = res.balances ? res.balances.annual.left : '0';
      document.getElementById("compBal").innerText = res.balances ? res.balances.comp.left : '0';
      // åš´æ ¼æ¬Šé™é¡¯ç¤º
      if(res.isManager) document.getElementById("mgrBtn").style.display = 'block';
      if(localStorage.getItem("isManager")==='Y') document.getElementById("admBtns").classList.remove("hidden");
      else if(localStorage.getItem("canSchedule")==='Y') document.getElementById("admBtns").classList.remove("hidden");
    } else {
      alert("èº«ä»½é©—è­‰å¤±æ•—: " + res.message);
    }
    // åˆå§‹åŒ–å¹´æœˆ
    const yS = document.getElementById("y");
    const mS = document.getElementById("m");
    const now = new Date();
    for(let i=2024; i<=2026; i++) yS.options.add(new Option(i, i));
    for(let i=1; i<=12; i++) mS.options.add(new Option(i, i));
    yS.value = now.getFullYear();
    mS.value = now.getMonth() + 1;
    search();  // è‡ªå‹•è¼‰å…¥
  }

  async function clock(type) {
    if(!lat) { alert("è«‹ç­‰å¾…å®šä½"); return; }
    const res = await api(type, {lat, lng});
    alert(res.message);
  }

  async function search() {
    const yS = document.getElementById("y");
    const mS = document.getElementById("m");
    const d = document.getElementById("resList");
    d.innerHTML = "è¼‰å…¥ä¸­...";
    const r = await api("get_dashboard", {year: yS.value, month: mS.value});
    if(r && r.ok) {
      const days = new Date(yS.value, mS.value, 0).getDate();
      const map = {};
      for(let i=1; i<=days; i++) map[i] = { shift: r.schedule[i] || 'EARLY', in:null, out:null, leave:null };
      // 2. å¡«å…¥æ‰“å¡
      r.clocks.forEach(c => {
        const parts = c.date.split('-');
        const day = parseInt(parts[2]);
        if(map[day]) {
          if(c.type.includes('ä¸Šç­')) map[day].in = c.time;
          if(c.type.includes('ä¸‹ç­')) map[day].out = c.time;
        }
      });
      // 3. å¡«å…¥è«‹å‡
      if(r.leaves) {
        r.leaves.forEach(l => {
          const parts = l.date.split('-');
          const day = parseInt(parts[2]);
          if(map[day]) map[day].leave = l.type; // å„ªå…ˆé¡¯ç¤ºå‡åˆ¥
        });
      }
      // 4. æ¸²æŸ“ (å€’åº)
      d.innerHTML = '';
      for(let i=days; i>=1; i--) {
        const item = map[i];
        let stTag = "æ­£å¸¸", stCls = "st-ok";
        if (item.leave) {
          stTag = item.leave; stCls = "st-leave";
        } else if (item.shift === 'OFF') {
          stTag = "ä¼‘å‡"; stCls = "st-off";
          if(item.in || item.out) { stTag="åŠ ç­"; stCls="st-ok"; }
        } else {
          // å·¥ä½œæ—¥åˆ¤æ–·
          if (!item.in && !item.out) { stTag="æ› è·"; stCls="st-miss"; }
          else if (!item.in) { stTag="ç¼ºä¸Šç­å¡"; stCls="st-miss"; }
          else if (!item.out) { stTag="ç¼ºä¸‹ç­å¡"; stCls="st-miss"; }
          else {
            // æ™‚é–“æ¨™æº–
            const startTarget = item.shift==='EARLY' ? '10:00:00' : '12:00:00';
            const endTarget = item.shift==='EARLY' ? '18:00:00' : '21:00:00';
           
            // 1. é²åˆ°
            if(item.in > startTarget) { stTag="é²åˆ°"; stCls="st-late"; }
           
            // 2. æ—©é€€ (ä¸‹ç­æ™‚é–“æ—©æ–¼è¡¨å®š)
            if(item.out < endTarget) {
                stTag = (stTag==="é²åˆ°") ? "é²åˆ°/æ—©é€€" : "æ—©é€€";
                stCls="st-late";
            }
            // 3. ç•°å¸¸ (è¶…é1å°æ™‚ä¸‹ç­)
            const outH = parseInt(item.out.split(':')[0]);
            const stdH = item.shift==='EARLY' ? 18 : 21;
            if(outH >= stdH + 1) { stTag="ç•°å¸¸"; stCls="st-abn"; }
          }
        }
        // æœªä¾†æ—¥æœŸä¸é¡¯ç¤º
        if(new Date(yS.value, mS.value-1, i) > new Date()) { stTag="--"; stCls="st-off"; }
        d.innerHTML += `
          <div style="display:flex;align-items:center;margin-bottom:10px;">
            <div style="width:50px;text-align:center;">${i}æ—¥</div>
            <div class="rec-time">ä¸Š: ${item.in || '--:--'}<br>ä¸‹: ${item.out || '--:--'}</div>
            <span class="status-tag ${stCls}">${stTag}</span>
          </div>`;
      }
    } else {
      d.innerHTML = "è®€å–å¤±æ•—: " + (r ? r.message : 'ç³»çµ±éŒ¯èª¤');
    }
  }

  init();
</script>
</body>
</html>
