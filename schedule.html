<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>é–€å¸‚æ’ç­ç®¡ç†</title>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; background: #f4f6f8; margin: 0; }
    .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .btn-back { display: inline-block; padding: 8px 16px; background: #333; color: #fff; text-decoration: none; border-radius: 6px; margin-bottom: 20px; font-size: 14px; }
    .quota-box { background:#e3f2fd; color:#0d47a1; padding:15px; border-radius:8px; text-align:center; margin-bottom:20px; }
    .btn-approve-all { background: #007aff; color: #fff; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 14px; display: none; }
    .btn-approve-all:disabled { opacity: 0.6; cursor: not-allowed; }

    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal-content { background: #fff; padding: 24px; border-radius: 12px; width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }

    select, input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 5px; font-size: 16px; box-sizing: border-box; }
    label { display: block; margin-top: 15px; font-size: 14px; color: #666; }

    .btn-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
    button { flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; min-width: 90px; }
    button:active { transform: scale(0.98); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-save { background: #007aff; color: #fff; }
    .btn-approve { background: #28a745; color: #fff; display: none; }
    .btn-del { background: #dc3545; color: #fff; display: none; }
    .btn-request { background: #ff9800; color: #fff; display: none; }
    .btn-close { background: #eee; color: #333; }

    #loadingOverlay {
      display: none; position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(255,255,255,0.8); z-index: 2000;
      justify-content: center; align-items: center; flex-direction: column;
    }
    .spinner {
      border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
      border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite; margin-bottom: 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div style="color:#555; font-weight:bold;">è³‡æ–™å‚³è¼¸ä¸­...</div>
  </div>

  <div class="container">
    <a href="manager.html" class="btn-back">â† å›ä¸»ç®¡é </a>

    <div class="quota-box">
      <span id="currentMonthStr" style="font-weight:bold; font-size:18px;">...</span>
      <br>
      æ‡‰ä¼‘å¤©æ•¸ï¼š<span id="monthlyQuota" style="font-size:24px; font-weight:bold; color:#c22;">-</span> å¤©
      <div id="quotaDetail" style="font-size:13px; color:#555; margin-top:5px;"></div>
      <button id="btnApproveAll" class="btn-approve-all" onclick="approveMonthAll()">âœ… ä¸€éµæ ¸å‡†æœ¬æœˆæ‰€æœ‰ç­è¡¨</button>
    </div>

    <div style="text-align:center; font-size:12px; color:#666; margin-bottom:10px;">
      <span style="color:#3788d8">â— æ—©ç­/å·²æ ¸å‡†</span> &nbsp;
      <span style="color:#dc3545">â— åˆç­/å·²æ ¸å‡†</span> &nbsp;
      <span style="color:#6c757d">â— å¾…æ ¸å‡†</span> &nbsp;
      <span style="color:#000000">â— æ› è·</span>
    </div>

    <div id="calendar"></div>
  </div>

  <div id="eventModal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle">æ’ç­è¨­å®š</h3>
      <input type="hidden" id="selectedDate">

      <label>å“¡å·¥</label>
      <select id="empSelect"><option value="">è¼‰å…¥ä¸­...</option></select>

      <label>ç­åˆ¥</label>
      <select id="shiftSelect">
        <option value="æ—©ç­">â˜€ï¸ æ—©ç­ (10:00-18:00)</option>
        <option value="åˆç­">ğŸŒ™ åˆç­ (12:00-21:00)</option>
      </select>

      <div id="statusInfo" style="margin-top:10px; font-size:12px; color:#888;"></div>

      <div class="btn-group">
        <button class="btn-approve" id="btnApprove" onclick="approveEvent()">âœ… æ ¸å‡†</button>
        <button class="btn-del" id="btnDelete" onclick="deleteEvent()">ğŸ—‘ï¸ åˆªé™¤</button>
        <button class="btn-request" id="btnRequest" onclick="requestChange()">ğŸ“£ ç”³è«‹æ”¹ç­</button>
        <button class="btn-save" id="btnSave" onclick="saveEvent()">ğŸ’¾ å„²å­˜</button>
        <button class="btn-close" onclick="closeModal()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    // ===== 1. åŸºç¤è¨­å®š =====
    const ENDPOINT = window.CONFIG?.GAS_ENDPOINT || "";
    const userId = localStorage.getItem("employeeId");
    const userName = localStorage.getItem("employeeName");
    let isManager = (localStorage.getItem("isManager") === "Y"); // å„ªå…ˆå¾ LocalStorage è®€å–

    let calendar;
    let currentYear, currentMonth;
    let currentEventObj = null;

    // æª¢æŸ¥ç™»å…¥
    if(!userId) { alert("è«‹å…ˆç™»å…¥"); location.href="index.html"; }

    // ===== 2. API å‘¼å«å·¥å…· (JSONP) =====
    function api(action, data={}){
      document.getElementById("loadingOverlay").style.display = "flex";
      return new Promise((resolve, reject)=>{
        const cb = "cb" + Date.now();
        const payload = JSON.stringify({ ...data, userId, webhookKey: window.CONFIG?.WEBHOOK_KEY });
        const script = document.createElement("script");
        script.src = `${ENDPOINT}?action=${action}&payload=${encodeURIComponent(payload)}&callback=${cb}`;
        
        window[cb] = (res) => {
          resolve(res);
          delete window[cb];
          script.remove();
          document.getElementById("loadingOverlay").style.display = "none";
        };
        script.onerror = () => {
          reject("é€£ç·šå¤±æ•—");
          document.getElementById("loadingOverlay").style.display = "none";
        };
        document.body.appendChild(script);
      });
    }

    // ===== 3. åˆå§‹åŒ–èˆ‡ FullCalendar =====
    document.addEventListener("DOMContentLoaded", async function() {
      await loadEmployees(); // å…ˆè¼‰å…¥å“¡å·¥æ¸…å–®

      const calendarEl = document.getElementById("calendar");
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        locale: "zh-tw",
        headerToolbar: { left: "prev,next today", center: "title", right: "dayGridMonth,listWeek" },
        height: "auto",
        events: fetchEvents, // åˆ‡æ›æœˆä»½æ™‚è‡ªå‹•è§¸ç™¼
        dateClick: function(info) { openModal(info.dateStr, null); },
        eventClick: function(info) { openModal(info.event.startStr, info.event); },
        datesSet: function(info) {
           // â˜… æ¯æ¬¡åˆ‡æ›æœˆä»½ï¼Œé‡æ–°è¨ˆç®—æ‡‰ä¼‘å¤©æ•¸
           const mid = new Date((info.start.getTime() + info.end.getTime()) / 2);
           updateMonthlyQuota(mid.getFullYear(), mid.getMonth() + 1);
        }
      });
      calendar.render();
    });

    // ===== 4. è¼‰å…¥å“¡å·¥ (ä¿®å¾©æ¬Šé™å•é¡Œ) =====
    async function loadEmployees() {
      const sel = document.getElementById("empSelect");
      sel.innerHTML = "";

      try {
        const res = await api("get_all_employees");
        
        // ç¢ºä¿ä¸»ç®¡æ¬Šé™æ­£ç¢º (å¾Œç«¯å›å‚³ + å‰ç«¯ç·©å­˜é›™é‡ç¢ºèª)
        if (res.isManager) {
           isManager = true;
           localStorage.setItem("isManager", "Y");
        }

        if (isManager) document.getElementById("btnApproveAll").style.display = "inline-block";

        const list = res.list || [];
        list.forEach(emp => {
          const opt = document.createElement("option");
          opt.value = emp.id;
          opt.textContent = `${emp.name} (${emp.id})`;
          sel.appendChild(opt);
        });

        // â˜… é—œéµä¿®æ­£ï¼šé è¨­é¸è‡ªå·±
        sel.value = userId;

        // â˜… é—œéµä¿®æ­£ï¼šåªæœ‰ã€Œéä¸»ç®¡ã€æ‰é–å®šé¸å–®
        sel.disabled = !isManager;

      } catch (e) {
        alert("è¼‰å…¥å“¡å·¥å¤±æ•—ï¼š" + e);
      }
    }

    // ===== 5. æŠ“å–ç­è¡¨ =====
    async function fetchEvents(info, successCallback, failureCallback) {
      try {
        const res = await api("get_schedule", { start: info.startStr, end: info.endStr });
        if(res.ok) successCallback(res.events || []);
        else failureCallback(res.message);
      } catch (e) {
        failureCallback(e);
      }
    }

    // ===== 6. æ›´æ–°æ‡‰ä¼‘å¤©æ•¸ =====
    async function updateMonthlyQuota(year, month) {
      document.getElementById("currentMonthStr").textContent = `${year}å¹´ ${month}æœˆ`;
      const elDays = document.getElementById("monthlyQuota");
      const elMsg = document.getElementById("quotaDetail");
      
      elDays.textContent = "...";
      
      try {
        // å‘¼å«å¾Œç«¯ get_month_quota
        const res = await api("get_month_quota", { ym: `${year}-${String(month).padStart(2,'0')}` });
        if(res.ok){
          elDays.textContent = res.totalOffDays;
          elMsg.textContent = `(é€±æœ« ${res.weekendDays} å¤© + åœ‹å®š ${res.holidayDays} å¤©)`;
        } else {
          elDays.textContent = "-";
        }
      } catch(e) {
        elDays.textContent = "Err";
      }
    }

    // ===== 7. Modal æ“ä½œ (æ–°å¢/ä¿®æ”¹/åˆªé™¤) =====
    function openModal(dateStr, eventObj) {
      document.getElementById("eventModal").style.display = "flex";
      document.getElementById("selectedDate").value = dateStr;
      currentEventObj = eventObj;

      const btnSave = document.getElementById("btnSave");
      const btnDel = document.getElementById("btnDelete");
      const btnApprove = document.getElementById("btnApprove");
      const btnRequest = document.getElementById("btnRequest");
      const shiftSel = document.getElementById("shiftSelect");
      const empSel = document.getElementById("empSelect");
      const info = document.getElementById("statusInfo");

      // é‡ç½®æŒ‰éˆ•ç‹€æ…‹
      [btnSave, btnDel, btnApprove, btnRequest].forEach(b => b.style.display = "none");
      info.textContent = "";

      // æ¨™é¡Œ
      document.getElementById("modalTitle").textContent = eventObj 
        ? `${eventObj.title} - ${dateStr}` 
        : `æ–°å¢æ’ç­ (${dateStr})`;

      if (eventObj) {
        // === ç·¨è¼¯æ¨¡å¼ ===
        const props = eventObj.extendedProps;
        empSel.value = props.empId;
        shiftSel.value = props.shift;
        
        // é–å®šå“¡å·¥é¸å–® (ç·¨è¼¯æ™‚ä¸å»ºè­°æ›äººï¼Œé¿å…é‚è¼¯æ··äº‚)
        empSel.disabled = true; 

        const status = props.reqStatus;
        info.textContent = `ç‹€æ…‹ï¼š${status}`;

        if (isManager) {
          // ä¸»ç®¡æ¬Šé™
          if (status === 'PENDING') {
             btnApprove.style.display = "block"; // å¯æ ¸å‡†
             btnSave.style.display = "block";    // å¯ä¿®æ”¹
             btnDel.style.display = "block";     // å¯åˆªé™¤
          } else {
             // å·²æ ¸å‡†ï¼šä¸»ç®¡ä»å¯åˆªé™¤æˆ–ä¿®æ”¹ (è¦–éœ€æ±‚)
             btnDel.style.display = "block";
             btnSave.style.display = "block"; 
          }
        } else {
          // å“¡å·¥æ¬Šé™
          if (String(props.empId) === userId) {
             if (status === 'PENDING') {
                btnDel.style.display = "block"; // è‡ªå·±å¯åˆªå¾…å¯©æ ¸
             } else {
                btnRequest.style.display = "block"; // å·²æ ¸å‡†åªèƒ½ç”³è«‹æ”¹ç­
             }
          }
        }

      } else {
        // === æ–°å¢æ¨¡å¼ ===
        empSel.disabled = !isManager; // ä¸»ç®¡å¯é¸äººï¼Œå“¡å·¥é–å®š
        if(!isManager) empSel.value = userId;
        
        shiftSel.value = "æ—©ç­";
        btnSave.style.display = "block";
      }
    }

    function closeModal() { document.getElementById("eventModal").style.display = "none"; }

    // ===== 8. æŒ‰éˆ•å‹•ä½œ =====
    
    // å„²å­˜ (æ–°å¢/ä¿®æ”¹)
    async function saveEvent() {
      const date = document.getElementById("selectedDate").value;
      const shift = document.getElementById("shiftSelect").value;
      const targetId = document.getElementById("empSelect").value; // ä¸»ç®¡é¸çš„äºº

      if(!targetId) return alert("è«‹é¸æ“‡å“¡å·¥");

      // åˆ¤æ–·æ˜¯æ–°å¢é‚„æ˜¯ä¿®æ”¹
      const action = currentEventObj ? "update_schedule" : "add_schedule";
      const payload = {
         date, shift, empId: targetId,
         scheduleId: currentEventObj ? currentEventObj.extendedProps.scheduleId : null
      };

      const res = await api(action, payload);
      alert(res.message);
      closeModal();
      calendar.refetchEvents();
    }

    // åˆªé™¤
    async function deleteEvent() {
      if(!currentEventObj || !confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
      const res = await api("del_schedule", { scheduleId: currentEventObj.extendedProps.scheduleId });
      alert(res.message);
      closeModal();
      calendar.refetchEvents();
    }

    // æ ¸å‡†
    async function approveEvent() {
      if(!currentEventObj) return;
      const res = await api("approve_schedule", { scheduleId: currentEventObj.extendedProps.scheduleId });
      alert(res.message);
      closeModal();
      calendar.refetchEvents();
    }

    // ç”³è«‹æ”¹ç­ (å“¡å·¥ç”¨)
    async function requestChange() {
      if(!currentEventObj) return;
      const toShift = (currentEventObj.extendedProps.shift === "æ—©ç­") ? "åˆç­" : "æ—©ç­";
      if(!confirm(`ç¢ºå®šç”³è«‹æ”¹ç‚º ${toShift} å—ï¼Ÿ`)) return;

      const res = await api("request_schedule_change", { 
         scheduleId: currentEventObj.extendedProps.scheduleId,
         toShift: toShift
      });
      alert(res.message);
      closeModal();
      calendar.refetchEvents();
    }

    // ä¸€éµæ ¸å‡†æœ¬æœˆ
    async function approveMonthAll() {
      if(!confirm("ç¢ºå®šæ ¸å‡†æœ¬é é¢æ‰€æœ‰å¾…å¯©æ ¸ç­è¡¨ï¼Ÿ")) return;
      const res = await api("approve_month_all", { 
         year: currentYear, 
         month: currentMonth 
      });
      alert(res.message);
      calendar.refetchEvents();
    }

  </script>
</body>
</html>
