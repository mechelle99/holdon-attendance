<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>é–€å¸‚æ’ç­ç®¡ç†</title>

  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; background: #f4f6f8; margin: 0; }
    .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .btn-back { display: inline-block; padding: 8px 16px; background: #333; color: #fff; text-decoration: none; border-radius: 6px; margin-bottom: 20px; font-size: 14px; }
    .quota-box { background:#e3f2fd; color:#0d47a1; padding:15px; border-radius:8px; text-align:center; margin-bottom:20px; }
    .btn-approve-all { background: #007aff; color: #fff; border: none; padding: 8px 16px; border-radius: 20px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 14px; display: none; }
    .btn-approve-all:disabled { opacity: 0.6; cursor: not-allowed; }

    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal-content { background: #fff; padding: 24px; border-radius: 12px; width: 320px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }

    select, input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; margin-top: 5px; font-size: 16px; box-sizing: border-box; }
    label { display: block; margin-top: 15px; font-size: 14px; color: #666; }

    .btn-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
    button { flex: 1; padding: 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; min-width: 90px; }
    button:active { transform: scale(0.98); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }

    .btn-save { background: #007aff; color: #fff; }
    .btn-approve { background: #28a745; color: #fff; display: none; }
    .btn-del { background: #dc3545; color: #fff; display: none; }
    .btn-request { background: #ff9800; color: #fff; display: none; }
    .btn-close { background: #eee; color: #333; }

    #loadingOverlay {
      display: none; position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(255,255,255,0.8); z-index: 2000;
      justify-content: center; align-items: center; flex-direction: column;
    }
    .spinner {
      border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
      border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite; margin-bottom: 10px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div style="color:#555; font-weight:bold;">è³‡æ–™å‚³è¼¸ä¸­...</div>
  </div>

  <div class="container">
    <a href="manager.html" class="btn-back">â† å›ä¸»ç®¡é </a>

    <div class="quota-box">
      <span id="currentMonthStr" style="font-weight:bold; font-size:18px;">...</span>
      <br>
      æ‡‰ä¼‘å¤©æ•¸ï¼š<span id="monthlyQuota" style="font-size:24px; font-weight:bold; color:#c22;">-</span> å¤©
      <div id="quotaDetail" style="font-size:13px; color:#555; margin-top:5px;"></div>
      <button id="btnApproveAll" class="btn-approve-all" onclick="approveMonthAll()">âœ… ä¸€éµæ ¸å‡†æœ¬æœˆæ‰€æœ‰ç­è¡¨</button>
    </div>

    <div style="text-align:center; font-size:12px; color:#666; margin-bottom:10px;">
      <span style="color:#3788d8">â— æ—©ç­/å·²æ ¸å‡†</span> &nbsp;
      <span style="color:#dc3545">â— åˆç­/å·²æ ¸å‡†</span> &nbsp;
      <span style="color:#6c757d">â— å¾…æ ¸å‡†</span> &nbsp;
      <span style="color:#000000">â— æ› è·</span>
    </div>

    <div id="calendar"></div>
  </div>

  <div id="eventModal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle">æ’ç­è¨­å®š</h3>
      <input type="hidden" id="selectedDate">

      <label>å“¡å·¥</label>
      <select id="empSelect"><option value="">è¼‰å…¥ä¸­...</option></select>

      <label>ç­åˆ¥</label>
      <select id="shiftSelect">
        <option value="æ—©ç­">â˜€ï¸ æ—©ç­ (10:00-18:00)</option>
        <option value="åˆç­">ğŸŒ™ åˆç­ (12:00-21:00)</option>
      </select>

      <div id="statusInfo" style="margin-top:10px; font-size:12px; color:#888;"></div>

      <div class="btn-group">
        <button class="btn-approve" id="btnApprove" onclick="approveEvent()">âœ… æ ¸å‡†</button>
        <button class="btn-del" id="btnDelete" onclick="deleteEvent()">ğŸ—‘ï¸ åˆªé™¤</button>
        <button class="btn-request" id="btnRequest" onclick="requestChange()">ğŸ“£ ç”³è«‹æ”¹ç­</button>
        <button class="btn-save" id="btnSave" onclick="saveEvent()">ğŸ’¾ å„²å­˜</button>
        <button class="btn-close" onclick="closeModal()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script src="config.js"></script>
  <script>
    // ===== åŸºæœ¬è¨­å®š =====
    const ENDPOINT = window.CONFIG?.GAS_ENDPOINT || window.GAS_ENDPOINT || "";
    const WEBHOOK_KEY = window.CONFIG?.WEBHOOK_KEY || ""; // å»ºè­°ä½ åœ¨ config.js åŠ ä¸Šï¼šwindow.CONFIG.WEBHOOK_KEY="HOLDON2026";

    const userId = localStorage.getItem("employeeId");
    const userName = localStorage.getItem("employeeName") || "Unknown";

    let isManager = false;
    let calendar;
    let currentYear, currentMonth;
    let currentEventObj = null;

    function showLoading() { document.getElementById("loadingOverlay").style.display = "flex"; }
    function hideLoading() { document.getElementById("loadingOverlay").style.display = "none"; }

    // ===== JSONP (å… CORS) =====
    function jsonpCall(action, dataObj = {}, timeoutMs = 12000) {
      return new Promise((resolve, reject) => {
        if (!ENDPOINT) return reject(new Error("å°šæœªè¨­å®š GAS ç¶²å€ (config.js)"));

        const cbName = "__cb_" + Math.random().toString(36).slice(2);
        const payload = {
          webhookKey: WEBHOOK_KEY,
          userId,
          displayName: userName,
          data: dataObj
        };

        const qs = new URLSearchParams();
        qs.set("action", action);
        qs.set("payload", JSON.stringify(payload));

        const url = ENDPOINT + "?" + qs.toString() + "&callback=" + cbName;

        const script = document.createElement("script");
        let done = false;

        const timer = setTimeout(() => {
          if (done) return;
          done = true;
          cleanup();
          reject(new Error("JSONP timeout"));
        }, timeoutMs);

        function cleanup() {
          clearTimeout(timer);
          try { delete window[cbName]; } catch(e) {}
          if (script && script.parentNode) script.parentNode.removeChild(script);
        }

        window[cbName] = (res) => {
          if (done) return;
          done = true;
          cleanup();
          resolve(res);
        };

        script.onerror = () => {
          if (done) return;
          done = true;
          cleanup();
          reject(new Error("JSONP network error"));
        };

        document.head.appendChild(script);
        script.src = url;
      });
    }

    async function api(action, dataObj = {}) {
      const res = await jsonpCall(action, dataObj);
      if (!res || res.ok !== true) {
        throw new Error(res?.message || res?.error || "API failed");
      }
      return res;
    }

    // ===== åˆå§‹åŒ– =====
    document.addEventListener("DOMContentLoaded", async function() {
      if (!userId) {
        alert("è«‹å…ˆç™»å…¥");
        location.href = "index.html";
        return;
      }

      showLoading();
      try {
        await loadEmployees();

        const calendarEl = document.getElementById("calendar");
        calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: "dayGridMonth",
          locale: "zh-tw",
          headerToolbar: { left: "prev,next today", center: "title", right: "dayGridMonth,listWeek" },
          height: "auto",
          events: fetchEvents,
          dateClick: function(info) { openModal(info.dateStr, null); },
          eventClick: function(info) {
            if (info.event.extendedProps.temp) {
              alert("âš ï¸ è³‡æ–™å¯«å…¥ä¸­ï¼Œè«‹ç¨å€™...");
              return;
            }
            openModal(info.event.startStr, info.event);
          }
        });
        calendar.render();
      } catch (e) {
        alert("åˆå§‹åŒ–å¤±æ•—ï¼š" + e.message);
      } finally {
        hideLoading();
      }
    });

    // ===== è¼‰å…¥å“¡å·¥èˆ‡æ¬Šé™ =====
    async function loadEmployees() {
      const sel = document.getElementById("empSelect");
      sel.innerHTML = "";

      const res = await api("get_all_employees", {});
      isManager = !!res.isManager;

      // ä¸»ç®¡æ‰é¡¯ç¤ºä¸€éµæ ¸å‡†
      if (isManager) document.getElementById("btnApproveAll").style.display = "inline-block";

      const list = res.list || [];
      list.forEach(emp => {
        const opt = document.createElement("option");
        opt.value = emp.id;
        opt.textContent = emp.name;
        sel.appendChild(opt);
      });

      // ğŸ”’ æ ¸å¿ƒè¦å‰‡ï¼šä¸»ç®¡ä¹Ÿä¸èƒ½å¹«åˆ¥äººæ’ç­ => æ°¸é åªèƒ½é¸è‡ªå·±
      sel.value = userId;
      sel.disabled = true;
    }

    // ===== å–ç­è¡¨ =====
    async function fetchEvents(info, successCallback, failureCallback) {
      showLoading();
      try {
        const start = info.start;
        const end = info.end;
        const mid = new Date((start.getTime() + end.getTime()) / 2);
        currentYear = mid.getFullYear();
        currentMonth = mid.getMonth() + 1;

        document.getElementById("currentMonthStr").textContent = `${currentYear}å¹´ ${currentMonth}æœˆ`;

        await updateMonthlyQuota(currentYear, currentMonth);

        const res = await api("get_schedule", { start: info.startStr, end: info.endStr });
        successCallback(res.events || []);
      } catch (e) {
        failureCallback(e.message || "è¼‰å…¥å¤±æ•—");
      } finally {
        hideLoading();
      }
    }

    // ===== æœˆæ‡‰ä¼‘å¤©æ•¸ï¼ˆé€±å…­æ—¥ + Holidays è¡¨ï¼‰=====
    async function updateMonthlyQuota(year, month) {
      const elDays = document.getElementById("monthlyQuota");
      const elMsg = document.getElementById("quotaDetail");
      elDays.textContent = "...";
      elMsg.textContent = "";

      const ym = `${year}-${String(month).padStart(2,'0')}`;
      const res = await api("get_month_quota", { ym });

      elDays.textContent = res.totalOffDays;
      elMsg.textContent = `é€±æœ« ${res.weekendDays} å¤© + åœ‹å®š/è£œå‡ ${res.holidayDays} å¤©`;
    }

    // ===== Modal UI =====
    function openModal(dateStr, eventObj) {
      document.getElementById("eventModal").style.display = "flex";
      document.getElementById("selectedDate").value = dateStr;
      currentEventObj = eventObj;

      const btnSave = document.getElementById("btnSave");
      const btnDel = document.getElementById("btnDelete");
      const btnApprove = document.getElementById("btnApprove");
      const btnRequest = document.getElementById("btnRequest");
      const shiftSel = document.getElementById("shiftSelect");
      const info = document.getElementById("statusInfo");

      btnSave.style.display = "block";
      btnDel.style.display = "none";
      btnApprove.style.display = "none";
      btnRequest.style.display = "none";
      info.textContent = "";
      info.style.color = "#888";

      btnSave.disabled = false; btnSave.textContent = "ğŸ’¾ å„²å­˜";
      btnDel.disabled = false; btnDel.textContent = "ğŸ—‘ï¸ åˆªé™¤";
      btnApprove.disabled = false; btnApprove.textContent = "âœ… æ ¸å‡†";
      btnRequest.disabled = false; btnRequest.textContent = "ğŸ“£ ç”³è«‹æ”¹ç­";

      if (eventObj) {
        document.getElementById("modalTitle").textContent = `${dateStr} æ’ç­è©³æƒ…`;
        shiftSel.value = eventObj.extendedProps.shift || "æ—©ç­";

        const status = eventObj.extendedProps.reqStatus || "PENDING";
        const ownerId = eventObj.extendedProps.empId;
        const isOwner = String(ownerId) === String(userId);

        info.textContent = `ç‹€æ…‹ï¼š${status}`;

        if (status === "APPROVED") {
          btnSave.style.display = "none";
          if (isManager) {
            btnDel.style.display = "block";
          } else {
            // å“¡å·¥ï¼šå·²æ ¸å‡†åªèƒ½ç”³è«‹æ”¹ç­ï¼ˆè‡ªå·±ï¼‰
            if (isOwner) {
              btnRequest.style.display = "block";
              info.textContent = "ç‹€æ…‹ï¼šå·²æ ¸å‡†ï¼ˆå¦‚éœ€èª¿ç­ï¼Œè«‹é»æ“Šç”³è«‹æ”¹ç­ï¼‰";
              info.style.color = "#d9534f";
            }
          }
        } else {
          // PENDING
          if (isOwner || isManager) btnDel.style.display = "block";
          if (isManager) btnApprove.style.display = "block";
        }
      } else {
        document.getElementById("modalTitle").textContent = `æ–°å¢æ’ç­ (${dateStr})`;
        shiftSel.value = "æ—©ç­";
        // empSelect æ°¸é å›ºå®šè‡ªå·±ï¼ˆä¸Šé¢å·² disabledï¼‰
      }
    }

    function closeModal() { document.getElementById("eventModal").style.display = "none"; }

    // ===== æ–°å¢æ’ç­ï¼ˆæ°¸é åªèƒ½å¹«è‡ªå·±æ’ï¼‰=====
    async function saveEvent() {
      const dateVal = document.getElementById("selectedDate").value;
      const shiftVal = document.getElementById("shiftSelect").value;

      const btn = document.getElementById("btnSave");
      btn.disabled = true;
      btn.textContent = "å„²å­˜ä¸­...";

      // æ¨‚è§€ UI
      const fakeEvent = {
        title: `${userName} (${shiftVal})`,
        start: dateVal,
        color: "#6c757d",
        extendedProps: {
          empId: userId,
          reqStatus: "PENDING",
          shift: shiftVal,
          temp: true
        }
      };
      const addedEvent = calendar.addEvent(fakeEvent);
      closeModal();

      try {
        const res = await api("add_schedule", {
          date: dateVal,
          empId: userId,
          empName: userName,
          shift: shiftVal
        });

        // æˆåŠŸï¼šåˆ·æ–°
        addedEvent.remove();
        calendar.refetchEvents();
        alert(res.message || "å·²é€å‡º");
      } catch (e) {
        addedEvent.remove();
        alert("âŒ å„²å­˜å¤±æ•—ï¼š" + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = "ğŸ’¾ å„²å­˜";
      }
    }

    // ===== åˆªé™¤ =====
    async function deleteEvent() {
      if (!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return;
      if (!currentEventObj) return;

      const btn = document.getElementById("btnDelete");
      btn.disabled = true;
      btn.textContent = "åˆªé™¤ä¸­...";

      const targetDate = document.getElementById("selectedDate").value;
      const scheduleId = currentEventObj.extendedProps.scheduleId;

      currentEventObj.remove();
      closeModal();

      try {
        const res = await api("del_schedule", { scheduleId, date: targetDate });
        alert(res.message || "å®Œæˆ");
        calendar.refetchEvents();
      } catch (e) {
        alert("âŒ åˆªé™¤å¤±æ•—ï¼š" + e.message);
        calendar.refetchEvents();
      } finally {
        btn.disabled = false;
        btn.textContent = "ğŸ—‘ï¸ åˆªé™¤";
      }
    }

    // ===== æ ¸å‡†ï¼ˆåªæœ‰ä¸»ç®¡å¯æ ¸å‡†ï¼‰=====
    async function approveEvent() {
      if (!currentEventObj) return;

      const btn = document.getElementById("btnApprove");
      btn.disabled = true;
      btn.textContent = "æ ¸å‡†ä¸­...";

      const scheduleId = currentEventObj.extendedProps.scheduleId;

      try {
        const res = await api("approve_schedule", { scheduleId });
        alert(res.message || "å®Œæˆ");
        closeModal();
        calendar.refetchEvents();
      } catch (e) {
        alert("âŒ æ ¸å‡†å¤±æ•—ï¼š" + e.message);
        btn.disabled = false;
        btn.textContent = "âœ… æ ¸å‡†";
      }
    }

    // ===== ä¸€éµæ ¸å‡†æœ¬æœˆ =====
    async function approveMonthAll() {
      if (!confirm(`ç¢ºå®šæ ¸å‡† ${currentYear}å¹´${currentMonth}æœˆ æ‰€æœ‰ç­è¡¨ï¼Ÿ`)) return;

      const btn = document.getElementById("btnApproveAll");
      btn.disabled = true;
      btn.textContent = "è™•ç†ä¸­...";

      try {
        const res = await api("approve_month_all", { year: currentYear, month: currentMonth });
        alert(res.message || "å®Œæˆ");
        calendar.refetchEvents();
      } catch (e) {
        alert("âŒ å¤±æ•—ï¼š" + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = "âœ… ä¸€éµæ ¸å‡†æœ¬æœˆæ‰€æœ‰ç­è¡¨";
      }
    }

    // ===== ç”³è«‹æ”¹ç­ =====
    async function requestChange() {
      if (!currentEventObj) return;

      const ownerId = currentEventObj.extendedProps.empId;
      if (String(ownerId) !== String(userId)) {
        alert("åªèƒ½å°è‡ªå·±çš„ç­è¡¨ç”³è«‹æ”¹ç­");
        return;
      }

      const currentShift = currentEventObj.extendedProps.shift;
      const targetShift = currentShift === "æ—©ç­" ? "åˆç­" : "æ—©ç­";

      const reason = prompt(
        `ä½ ç›®å‰æ˜¯ ${currentShift}ï¼Œæƒ³ç”³è«‹æ”¹æˆ ${targetShift} å—ï¼Ÿ\nè«‹è¼¸å…¥åŸå› ï¼š`,
        "è‡¨æ™‚æœ‰äº‹"
      );
      if (!reason) return;

      const btn = document.getElementById("btnRequest");
      btn.disabled = true;
      btn.textContent = "ç”³è«‹ä¸­...";

      const scheduleId = currentEventObj.extendedProps.scheduleId;

      try {
        const res = await api("request_schedule_change", {
          scheduleId,
          fromShift: currentShift,
          toShift: targetShift,
          reason
        });
        alert(res.message || "å·²é€å‡º");
        closeModal();
        calendar.refetchEvents();
      } catch (e) {
        alert("âŒ ç”³è«‹å¤±æ•—ï¼š" + e.message);
      } finally {
        btn.disabled = false;
        btn.textContent = "ğŸ“£ ç”³è«‹æ”¹ç­";
      }
    }
  </script>
</body>
</html>
