<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HOLDON ç³»çµ±</title>
  <style>
    :root{ --blue:#007aff; --bg:#f4f6f8; }
    body{font-family:-apple-system,sans-serif;background:var(--bg);margin:0;padding:16px;color:#333;padding-bottom:80px;}
    .card{background:#fff;border-radius:16px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05);margin-bottom:16px;}
    .btn{width:100%;padding:14px;border:none;border-radius:12px;font-size:16px;font-weight:bold;color:#fff;cursor:pointer;margin-top:8px;}
    .btn-in{background:var(--blue);}
    .btn-out{background:#ff9500;}
    .btn-gray{background:#555;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    input, select, textarea{width:100%;padding:12px;margin-top:6px;border:1px solid #ddd;border-radius:8px;box-sizing:border-box;font-size:16px;}
    label{font-size:13px;color:#666;font-weight:bold;margin-top:10px;display:block;}
    .recent-item{display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding:10px 0;}
    .hidden{display:none;}
    #loading{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);display:none;justify-content:center;align-items:center;z-index:99;}
  </style>
</head>
<body>

  <div id="loading">è™•ç†ä¸­...</div>

  <div class="card">
    <div style="display:flex;justify-content:space-between;">
      <h3 style="margin:0" id="userName">...</h3>
      <a href="index.html" style="color:#c00;text-decoration:none;">ç™»å‡º</a>
    </div>
    
    <div id="mgrBtn" class="hidden">
      <button class="btn" style="background:#6f42c1;" onclick="location.href='manager.html'">ğŸ‘‘ ä¸»ç®¡å¾Œå°</button>
    </div>
    <div id="schBtn" class="hidden">
      <button class="btn" style="background:#17a2b8;" onclick="location.href='schedule.html'">ğŸ“… æ’ç­è¡¨</button>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">ğŸ“ ä¸Šä¸‹ç­æ‰“å¡</h3>
    <div class="grid">
      <button class="btn btn-in" onclick="clock('clock_in')">ä¸Šç­</button>
      <button class="btn btn-out" onclick="clock('clock_out')">ä¸‹ç­</button>
    </div>
    <div id="clockMsg" style="text-align:center;margin-top:8px;font-size:13px;color:var(--blue);"></div>
  </div>

  <div class="card">
    <h3 style="margin:0">ğŸ“ ç·šä¸Šç”³è«‹</h3>
    <label>é¡å‹</label>
    <select id="cat" onchange="uiChange()">
      <option value="LEAVE">è«‹å‡</option>
      <option value="OT">åŠ ç­ (è½‰è£œä¼‘)</option>
      <option value="OUTING">å¤–å‡ºå…¬å‹™</option>
      <option value="CORRECTION">è£œå¡ (æ¯æœˆé™5æ¬¡)</option>
    </select>

    <div id="areaLeave">
      <label>å‡åˆ¥</label>
      <select id="lType">
        <option value="annual">ç‰¹ä¼‘</option>
        <option value="sick">ç—…å‡</option>
        <option value="personal">äº‹å‡</option>
        <option value="menstrual">ç”Ÿç†å‡</option>
        <option value="family">å®¶åº­ç…§é¡§å‡</option>
        <option value="wedding">å©šå‡</option>
        <option value="funeral">å–ªå‡</option>
        <option value="maternity">ç”¢å‡</option>
        <option value="birthday">ç”Ÿæ—¥å‡ (é™ç•¶æœˆ/å–®æ—¥)</option>
        <option value="comp">è£œä¼‘</option>
      </select>
    </div>

    <div id="areaAuto" class="hidden">
      <label>è‡ªå‹•æ‰“å¡è¨­å®š (æ ¸å‡†å¾Œç”Ÿæ•ˆ)</label>
      <select id="autoClock">
        <option value="">æ‰‹å‹•æ‰“å¡</option>
        <option value="OUT">è‡ªå‹•æ‰“å¤–å‡º(ä¸Šç­)å¡</option>
        <option value="BOTH">è‡ªå‹•æ‰“å¾€è¿”å¡</option>
      </select>
    </div>

    <div class="grid">
      <div><label>é–‹å§‹</label><input type="datetime-local" id="start" onchange="calc()"></div>
      <div><label>çµæŸ</label><input type="datetime-local" id="end" onchange="calc()"></div>
    </div>
    
    <label>æ™‚æ•¸ (ç³»çµ±è‡ªå‹•è¨ˆç®—)</label>
    <input id="hours" readonly style="background:#f5f5f5;">

    <label>äº‹ç”±</label>
    <textarea id="reason" rows="2"></textarea>

    <button class="btn btn-gray" onclick="submit()">é€å‡ºç”³è«‹</button>
    <button class="btn" style="background:#fff;color:#333;border:1px solid #ccc;margin-top:10px;" onclick="location.href='history.html'">ğŸ“œ æŸ¥è©¢æ­·å²ç´€éŒ„</button>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">ğŸ“Š æœ€è¿‘æ‰“å¡ (5ç­†)</h3>
    <div id="recentList">è¼‰å…¥ä¸­...</div>
  </div>

  <script src="config.js"></script>
  <script>
    const userId = localStorage.getItem("employeeId");
    if(!userId) location.href="index.html";
    document.getElementById("userName").textContent = localStorage.getItem("employeeName");

    if(localStorage.getItem("isManager")==="Y") document.getElementById("mgrBtn").classList.remove("hidden");
    if(localStorage.getItem("canSchedule")==="Y" || localStorage.getItem("isManager")==="Y") document.getElementById("schBtn").classList.remove("hidden");

    function api(act, data={}) {
      document.getElementById("loading").style.display="flex";
      return new Promise((resolve, reject)=>{
        const cb = "cb"+Date.now();
        const payload = JSON.stringify({...data, userId, webhookKey:window.CONFIG.WEBHOOK_KEY});
        const s = document.createElement("script");
        s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${act}&payload=${encodeURIComponent(payload)}&callback=${cb}`;
        window[cb] = (res)=>{ resolve(res); document.body.removeChild(s); document.getElementById("loading").style.display="none"; };
        document.body.appendChild(s);
      });
    }

    async function init() {
      const res = await api("get_dashboard");
      if(res.ok && res.recent) {
        document.getElementById("recentList").innerHTML = res.recent.map(r => `
          <div class="recent-item">
            <span>${r.date} ${r.type}</span>
            <span>${r.time}</span>
          </div>
        `).join("");
      }
    }
    init();

    function uiChange() {
      const v = document.getElementById("cat").value;
      document.getElementById("areaLeave").style.display = (v==='LEAVE')?'block':'none';
      document.getElementById("areaAuto").style.display = (v==='OUTING')?'block':'none';
    }

    function calc() {
      const s = document.getElementById("start").value;
      const e = document.getElementById("end").value;
      if(s && e) {
        const diff = (new Date(e) - new Date(s)) / 36e5;
        document.getElementById("hours").value = diff > 0 ? diff.toFixed(1) : 0;
      }
    }

    async function clock(type) {
      if(!navigator.geolocation) return alert("ç„¡å®šä½æ¬Šé™");
      navigator.geolocation.getCurrentPosition(async (pos) => {
        const res = await api(type, { lat: pos.coords.latitude, lng: pos.coords.longitude });
        alert(res.message);
        if(res.ok) {
          document.getElementById("clockMsg").textContent = `æœ€å¾Œ: ${res.time}`;
          init();
        }
      });
    }

    async function submit() {
      const cat = document.getElementById("cat").value;
      const data = {
        category: cat,
        leaveType: (cat==='LEAVE') ? document.getElementById("lType").value : '',
        autoClock: (cat==='OUTING') ? document.getElementById("autoClock").value : '',
        start_ts: document.getElementById("start").value,
        end_ts: document.getElementById("end").value,
        hours: document.getElementById("hours").value,
        reason: document.getElementById("reason").value
      };
      
      if(!data.start_ts || !data.end_ts) return alert("è«‹å¡«å¯«æ™‚é–“");
      
      const res = await api("submit_request", data);
      alert(res.message);
      if(res.ok) { document.getElementById("reason").value=""; init(); }
    }
  </script>
</body>
</html>
