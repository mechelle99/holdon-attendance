<script>
if (!window.CONFIG.GAS_ENDPOINT) window.CONFIG.GAS_ENDPOINT = ""; // 安全賦值，不用 let window.xxx
const WEBHOOK_KEY = window.CONFIG?.WEBHOOK_KEY || "";

function jsonp(action, data){
  return new Promise((resolve, reject)=>{
    const cb = "cb" + Date.now() + Math.random().toString(16).slice(2);
    const payload = encodeURIComponent(JSON.stringify({...data, webhookKey: WEBHOOK_KEY}));
    const s = document.createElement("script");
    const url = `${window.CONFIG.GAS_ENDPOINT}?action=${encodeURIComponent(action)}&payload=${payload}&callback=${cb}`;
    window[cb] = (res)=>{ try{ resolve(res); } finally{ delete window[cb]; s.remove(); } };
    s.onerror = ()=>{ delete window[cb]; s.remove(); reject("Network error"); };
    s.src = url;
    document.body.appendChild(s);
  });
}

function mustLogin(){
  const empId = localStorage.getItem("employeeId");
  if(!empId){ location.href="index.html"; return null; }
  return empId;
}

async function boot(){
  const empId = mustLogin();
  if(!empId) return;

  const me = await jsonp("get_me", { userId: empId });
  if(!me.ok){ alert(me.message||"未登入"); logout(); return; }

  document.getElementById("who").textContent = `${me.emp.name} (${me.emp.id})`;
  const isMgr = (localStorage.getItem("isManager")==="Y") || !!me.isManager;
  const canSch = (localStorage.getItem("canSchedule")==="Y") || !!me.emp.canSchedule;

  document.getElementById("btnSchedule").style.display = (isMgr || canSch) ? "block" : "none";

  await refreshBalances();
  await refreshAttendance();
  onCatChange();
}

async function refreshBalances(){
  const empId = mustLogin(); if(!empId) return;
  const r = await jsonp("get_balances", { userId: empId });
  if(r.ok){
    document.getElementById("annualLeft").textContent = (r.annual?.left ?? "--");
    document.getElementById("compLeft").textContent = (r.comp?.left ?? "--");
  }else{
    document.getElementById("annualLeft").textContent = "--";
    document.getElementById("compLeft").textContent = "--";
  }
}

async function refreshAttendance(){
  const empId = mustLogin(); if(!empId) return;
  const r = await jsonp("get_my_dashboard", { userId: empId });
  if(!r.ok){ document.getElementById("attBox").textContent = r.message||"載入失敗"; return; }

  const rows = (r.attendance||[]);
  if(!rows.length){ document.getElementById("attBox").textContent = "目前沒有紀錄"; return; }

  const html = `
    <table class="table">
      <thead><tr><th>日期</th><th>上班</th><th>下班</th><th>狀態</th></tr></thead>
      <tbody>
      ${rows.map(x=>{
        const d = new Date(x.date);
        const day = d.toLocaleDateString("zh-TW");
        const late = x.isLate ? `<span class="tagLate">遲到</span>` : "";
        return `<tr>
          <td>${day}</td>
          <td>${x.in||""}</td>
          <td>${x.out||""}</td>
          <td>${late}</td>
        </tr>`;
      }).join("")}
      </tbody>
    </table>
  `;
  document.getElementById("attBox").innerHTML = html;
}

function onCatChange(){
  const cat = document.getElementById("reqCat").value;
  document.getElementById("leaveBox").style.display = (cat==="LEAVE") ? "block" : "none";
  document.getElementById("outingAuto").style.display = (cat==="OUTING") ? "block" : "none";
}

async function clock(type){
  const empId = mustLogin(); if(!empId) return;
  if(!navigator.geolocation) return alert("此裝置不支援定位");

  navigator.geolocation.getCurrentPosition(async (pos)=>{
    try{
      const r = await jsonp(type==="IN" ? "clock_in" : "clock_out", {
        userId: empId,
        lat: pos.coords.latitude,
        lng: pos.coords.longitude,
        accuracy: pos.coords.accuracy
      });
      alert(r.message || "完成");
      await refreshAttendance();
    }catch(e){
      alert("打卡失敗: "+e);
    }
  }, (err)=>{ alert("定位失敗: " + err.message); }, { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
}

async function outing(type){
  const empId = mustLogin(); if(!empId) return;
  if(!navigator.geolocation) return alert("此裝置不支援定位");

  navigator.geolocation.getCurrentPosition(async (pos)=>{
    try{
      const r = await jsonp(type==="IN" ? "outing_clock_in" : "outing_clock_out", {
        userId: empId,
        lat: pos.coords.latitude,
        lng: pos.coords.longitude,
        accuracy: pos.coords.accuracy
      });
      alert(r.message || "完成");
      await refreshAttendance();
    }catch(e){
      alert("外出打卡失敗: "+e);
    }
  }, (err)=>{ alert("定位失敗: " + err.message); }, { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
}

async function submitReq(){
  const empId = mustLogin(); if(!empId) return;
  const cat = document.getElementById("reqCat").value;
  const leaveType = document.getElementById("leaveType").value;
  const start = document.getElementById("startAt").value;
  const end = document.getElementById("endAt").value;
  const hours = document.getElementById("hours").value;
  const reason = document.getElementById("reason").value;
  const autoClock = document.getElementById("autoClock").value;

  const payload = {
    userId: empId,
    category: cat,
    leaveType: (cat==="LEAVE") ? leaveType : (cat==="OT" ? "comp" : leaveType),
    start_ts: start ? new Date(start).toISOString() : "",
    end_ts: end ? new Date(end).toISOString() : "",
    hours: hours ? Number(hours) : "",
    reason: reason || ""
  };

  if(cat==="OUTING" && autoClock){
    payload.autoClock = autoClock;
  }

  const r = await jsonp("submit_request", payload);
  alert(r.message || (r.ok ? "已送出" : "失敗"));
}

function goSchedule(){ location.href = "schedule.html"; }
function logout(){
  localStorage.removeItem("employeeId");
  localStorage.removeItem("employeeName");
  localStorage.removeItem("isManager");
  localStorage.removeItem("canSchedule");
  location.href = "index.html";
}

boot().catch(e=>alert("初始化失敗: "+e));
</script>
