<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no"/>
  <title>團隊排班</title>

  <style>
    :root{
      --primary:#4F46E5;
      --bg:#F3F4F6;
      --card:#FFFFFF;
      --text:#111827;
      --muted:#6B7280;
      --shadow: 0 10px 26px rgba(17,24,39,.10);
      --shadow2: 0 6px 16px rgba(17,24,39,.06);
      --radius:18px;
      --ok:#10B981;
      --warn:#F59E0B;
      --danger:#EF4444;
      --chip:#EEF2FF;
      --chipText:#3730A3;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI","Noto Sans TC",sans-serif;
      background:var(--bg);
      color:var(--text);
      padding:16px 16px 90px;
    }
    .topbar{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      margin-bottom:12px;
    }
    .title{
      font-weight:800; font-size:18px;
      letter-spacing:.2px;
    }
    .controls{
      display:flex; gap:8px; align-items:center;
    }
    select,button{
      border:1px solid rgba(17,24,39,.12);
      background:#fff;
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      box-shadow: var(--shadow2);
      outline:none;
    }
    button{
      background:linear-gradient(135deg,#4F46E5,#7C3AED);
      color:#fff;
      border:none;
      cursor:pointer;
      font-weight:700;
    }
    button:active{ transform: translateY(1px); }
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      margin-bottom:12px;
    }
    .hint{
      font-size:12px; color:var(--muted);
      line-height:1.4;
    }
    .restbox{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .restbox .big{
      font-weight:900;
      font-size:18px;
      line-height:1.2;
    }
    .chips{
      display:flex; flex-wrap:wrap; gap:8px;
      margin-top:10px;
    }
    .chip{
      background:var(--chip);
      color:var(--chipText);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:700;
    }

    .tableWrap{
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      border-radius:16px;
      border:1px solid rgba(17,24,39,.08);
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width: 720px;
      background:#fff;
    }
    th,td{
      padding:10px 10px;
      border-bottom:1px solid rgba(17,24,39,.06);
      text-align:center;
      font-size:13px;
      white-space:nowrap;
    }
    th{
      position:sticky; top:0;
      background:#FBFBFE;
      z-index:2;
      font-weight:800;
    }
    td.name{
      text-align:left;
      font-weight:800;
      position:sticky; left:0;
      background:#fff;
      z-index:1;
      border-right:1px solid rgba(17,24,39,.06);
    }
    .cell{
      border-radius:10px;
      padding:7px 8px;
      font-weight:800;
      display:inline-block;
      min-width:38px;
    }
    .shift-early{ background:#ECFDF5; color:#065F46; }
    .shift-late{ background:#EFF6FF; color:#1D4ED8; }
    .shift-off{ background:#F3F4F6; color:#374151; }
    .shift-leave{ background:#FFF7ED; color:#9A3412; }

    .footer{
      position:fixed; left:0; right:0; bottom:0;
      padding:12px 16px calc(12px + env(safe-area-inset-bottom));
      background:rgba(243,244,246,.92);
      backdrop-filter: blur(10px);
      border-top:1px solid rgba(17,24,39,.06);
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .status{
      font-size:12px; color:var(--muted);
      max-width:70%;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .pill{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(17,24,39,.10);
      font-weight:800;
      color:#111827;
      box-shadow: var(--shadow2);
    }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="title">團隊排班</div>
    <div class="controls">
      <select id="yearSel"></select>
      <select id="monthSel"></select>
      <button id="reloadBtn">重新載入</button>
    </div>
  </div>

  <div class="card">
    <div class="restbox">
      <div>
        <div class="big" id="restTitle">本月可休：-- 天</div>
        <div class="hint" id="restHint">（週末 -- + 國定假日 --）</div>
      </div>
      <div class="pill" id="lockHint">排班截止：--</div>
    </div>
    <div class="chips" id="restChips" style="display:none;"></div>
  </div>

  <div class="card">
    <div class="hint" style="margin-bottom:10px;">
      說明：休假統計以「週六/週日」+「Holidays 表的日期」合併計算，國定假日若落在週末不重複計算。
    </div>
    <div class="tableWrap">
      <table id="rosterTable"></table>
    </div>
  </div>

  <div class="footer">
    <div class="status" id="status">準備中…</div>
    <div class="pill" id="mePill">—</div>
  </div>

<script>
  // ✅ 最小修正：支援用網址參數設定 WEBAPP_URL（避免 iOS/LINE 沒 console 時卡死）
  // 用法：.../index.html?webapp=https://script.google.com/macros/s/XXXX/exec
  function getWebAppUrl(){
    try{
      const qs = new URLSearchParams(location.search);
      const fromQS = (qs.get('webapp') || '').trim();
      if (fromQS){
        localStorage.setItem('WEBAPP_URL', fromQS);
        return fromQS;
      }
    }catch(e){}
    return (localStorage.getItem('WEBAPP_URL') || '').trim();
  }

  const EMP_ID = localStorage.getItem('empId') || localStorage.getItem('userId') || '';
  const WEBHOOK_KEY = localStorage.getItem('WEBHOOK_KEY') || ''; // 若你有開啟 WEBHOOK_KEY

  const $ = (id)=>document.getElementById(id);

  function setStatus(msg){ $('status').textContent = msg; }

  function yyyymmNow(){
    const now = new Date();
    return { y: now.getFullYear(), m: now.getMonth()+1 };
  }

  function fillYM(){
    const now = yyyymmNow();
    const ySel = $('yearSel');
    const mSel = $('monthSel');

    ySel.innerHTML = '';
    const y0 = now.y - 1, y1 = now.y + 1;
    for(let y=y0; y<=y1; y++){
      const op = document.createElement('option');
      op.value = y; op.textContent = y;
      if (y===now.y) op.selected = true;
      ySel.appendChild(op);
    }

    mSel.innerHTML = '';
    for(let m=1; m<=12; m++){
      const op = document.createElement('option');
      op.value = m; op.textContent = String(m).padStart(2,'0');
      if (m===now.m) op.selected = true;
      mSel.appendChild(op);
    }
  }

  function jsonp(url){
    return new Promise((resolve, reject)=>{
      const cb = 'cb_' + Math.random().toString(36).slice(2);
      const s = document.createElement('script');
      const sep = url.includes('?') ? '&' : '?';
      s.src = url + sep + 'callback=' + cb;
      s.onerror = ()=>{ cleanup(); reject(new Error('JSONP error')); };

      window[cb] = (data)=>{
        cleanup();
        resolve(data);
      };
      function cleanup(){
        try{ delete window[cb]; }catch(e){ window[cb]=undefined; }
        if (s && s.parentNode) s.parentNode.removeChild(s);
      }
      document.body.appendChild(s);
    });
  }

  function buildCell(v){
    const s = String(v||'').trim();
    if (!s) return '';
    const span = document.createElement('span');
    span.className = 'cell';

    if (s.includes('早')) span.classList.add('shift-early');
    else if (s.includes('午')) span.classList.add('shift-late');
    else if (s.includes('休')) span.classList.add('shift-off');
    else span.classList.add('shift-leave');

    span.textContent = s;
    return span;
  }

  function renderRestDays(restDays){
    if (!restDays || !restDays.ok){
      $('restTitle').textContent = '本月可休：-- 天';
      $('restHint').textContent = '（週末 -- + 國定假日 --）';
      $('restChips').style.display = 'none';
      return;
    }

    $('restTitle').textContent = `本月可休：${restDays.totalOffDays} 天`;
    $('restHint').textContent = `（週末 ${restDays.weekendDays} + 國定假日 ${restDays.holidayExtra}）`;

    const chips = [];
    chips.push(`週末：${restDays.weekendDays} 天`);
    chips.push(`國定假日：${restDays.holidayTotal} 天`);
    if (restDays.holidayOnWeekend){
      chips.push(`其中落週末：${restDays.holidayOnWeekend} 天`);
    }
    chips.push(`合計（去重）：${restDays.totalOffDays} 天`);

    const wrap = $('restChips');
    wrap.innerHTML = '';
    chips.forEach(t=>{
      const c = document.createElement('div');
      c.className = 'chip';
      c.textContent = t;
      wrap.appendChild(c);
    });
    wrap.style.display = 'flex';
  }

  function renderTable(data){
    const tbl = $('rosterTable');
    tbl.innerHTML = '';

    const employees = data.employees || [];
    const roster = data.roster || {};
    const y = Number($('yearSel').value);
    const m = Number($('monthSel').value);
    const daysInMonth = new Date(y, m, 0).getDate();

    const thead = document.createElement('thead');
    const trH = document.createElement('tr');
    const th0 = document.createElement('th');
    th0.textContent = '員工';
    th0.style.left = '0';
    th0.style.position = 'sticky';
    trH.appendChild(th0);

    for(let d=1; d<=daysInMonth; d++){
      const th = document.createElement('th');
      th.textContent = d;
      trH.appendChild(th);
    }
    thead.appendChild(trH);
    tbl.appendChild(thead);

    const tbody = document.createElement('tbody');

    employees.forEach(emp=>{
      const tr = document.createElement('tr');

      const tdName = document.createElement('td');
      tdName.className = 'name';
      tdName.textContent = emp.empName || emp.empId;
      tr.appendChild(tdName);

      for(let d=1; d<=daysInMonth; d++){
        const td = document.createElement('td');
        const cellObj = (roster[emp.empId] && roster[emp.empId][d]) ? roster[emp.empId][d] : null;

        if (cellObj && cellObj.value){
          const node = buildCell(cellObj.value);
          if (node) td.appendChild(node);
        }else{
          td.textContent = '';
        }
        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    });

    tbl.appendChild(tbody);
  }

  async function loadRoster(){
    const y = Number($('yearSel').value);
    const m = Number($('monthSel').value);

    const WEBAPP_URL = getWebAppUrl(); // ✅ 即時取值（支援 ?webapp=）

    if (!WEBAPP_URL){
      setStatus('請先設定 WEBAPP_URL（localStorage.WEBAPP_URL 或 ?webapp=）');
      alert('請用網址參數帶入：?webapp=你的GAS/exec\n例如：.../index.html?webapp=https://script.google.com/macros/s/XXXX/exec\n（系統會自動記住）');
      return;
    }
    if (!EMP_ID){
      setStatus('找不到 empId（localStorage.empId）');
      alert('請先登入讓 localStorage 有 empId');
      return;
    }

    setStatus('載入排班中…');

    const payload = encodeURIComponent(JSON.stringify({
      empId: EMP_ID,
      year: y,
      month: m,
      webhookKey: WEBHOOK_KEY
    }));

    const url = `${WEBAPP_URL}?action=get_roster_data&payload=${payload}`;
    const res = await jsonp(url);

    if (!res || !res.ok){
      setStatus('載入失敗：' + (res && res.message ? res.message : 'unknown'));
      alert(res && res.message ? res.message : '載入失敗');
      return;
    }

    renderRestDays(res.restDays);
    $('lockHint').textContent = `排班截止：每月 ${res.lockDay || '--'} 號`;
    $('mePill').textContent = `ID：${EMP_ID}`;

    renderTable(res);
    setStatus('完成 ✅');
  }

  $('reloadBtn').addEventListener('click', loadRoster);
  $('yearSel').addEventListener('change', loadRoster);
  $('monthSel').addEventListener('change', loadRoster);

  fillYM();
  loadRoster().catch(err=>{
    console.error(err);
    setStatus('發生錯誤：' + String(err && err.message ? err.message : err));
  });
</script>

</body>
</html>
