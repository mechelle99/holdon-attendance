<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>HOLDON å‡ºå‹¤ç³»çµ±</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;background:#f4f6f8;margin:0;padding:16px;}
    .top{display:flex;justify-content:space-between;align-items:center;margin:8px 0 14px;}
    .card{background:#fff;border-radius:14px;padding:14px;box-shadow:0 6px 20px rgba(0,0,0,.06);margin-bottom:12px;}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    .big{font-size:34px;font-weight:800;margin:0}
    .muted{color:#666;font-size:12px;margin:6px 0 0}
    button{width:100%;padding:12px;border:none;border-radius:12px;font-weight:800;cursor:pointer}
    .btn{background:#111;color:#fff}
    .btn2{background:#fff;border:1px solid #ddd}
    select,input,textarea{width:100%;box-sizing:border-box;padding:10px;border:1px solid #ddd;border-radius:12px;font-size:15px}
    label{display:block;margin:10px 0 6px;color:#666;font-size:13px}
  </style>
</head>
<body>

  <div class="top">
    <div>
      <div style="font-weight:800" id="who">...</div>
      <div class="muted" id="role"></div>
    </div>
    <button class="btn2" onclick="logout()">ç™»å‡º</button>
  </div>
  <div class="card" id="managerCard" style="display:none; border:2px solid #000;">
    <h3 style="margin:0 0 10px;">ğŸ‘‘ ä¸»ç®¡å°ˆå€</h3>
    <button class="btn" style="background:#333;" onclick="location.href='manager.html'">é€²å…¥ä¸»ç®¡å¯©æ ¸å¾Œå°</button>
  </div>
  <div class="grid">
    <div class="card">
      <div class="muted">ç‰¹ä¼‘å‰©é¤˜</div>
      <div class="big" id="annualRemain">-</div>
      <div class="muted">ï¼ˆä»¥æ ¸å‡†å¾Œå…¥å¸³ç‚ºæº–ï¼‰</div>
    </div>
    <div class="card">
      <div class="muted">è£œä¼‘å‰©é¤˜</div>
      <div class="big" id="compRemain">-</div>
      <div class="muted">ï¼ˆä»¥æ ¸å‡†å¾Œå…¥å¸³ç‚ºæº–ï¼‰</div>
    </div>
  </div>

  <div class="card">
    <div class="muted">ç”Ÿæ—¥å‡ï¼ˆç•¶æœˆï¼‰</div>
    <div class="big"><span id="birthdayRemain">-</span> å°æ™‚</div>
    <div class="muted" id="birthdayHint"></div>
  </div>

  <div class="card" id="scheduleCard" style="display:none">
    <button class="btn2" onclick="goSchedule()">æŸ¥çœ‹ / å¡«å¯«æ’ç­</button>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">æå‡ºç”³è«‹</h3>

    <label>é¡å‹</label>
    <select id="category" onchange="onCategoryChange()">
      <option value="LEAVE">è«‹å‡</option>
      <option value="OT">åŠ ç­ï¼ˆå¯è½‰è£œä¼‘ï¼‰</option>
      <option value="OUTING">å¤–å‡º</option>
    </select>

    <div id="leaveArea">
      <label>å‡åˆ¥</label>
      <select id="leaveType">
        <option value="annual">ç‰¹ä¼‘</option>
        <option value="sick">ç—…å‡</option>
        <option value="birthday">ç”Ÿæ—¥å‡</option>
        <option value="comp">è£œä¼‘</option>
      </select>
    </div>

    <label>é–‹å§‹æ™‚é–“</label>
    <input id="start" type="datetime-local"/>

    <label>çµæŸæ™‚é–“</label>
    <input id="end" type="datetime-local"/>

    <label>åŸå› </label>
    <textarea id="reason" rows="3" placeholder="è«‹è¼¸å…¥åŸå› "></textarea>

    <div style="height:10px"></div>
    <button class="btn" onclick="submit()">é€å‡ºç”³è«‹</button>
  </div>

  <div class="card">
    <button class="btn2" onclick="openMyRequests()">æŸ¥çœ‹æˆ‘çš„ç”³è«‹ç´€éŒ„</button>
  </div>

  <script src="config.js"></script>
  <script>
    const ENDPOINT = window.CONFIG?.GAS_ENDPOINT || "";
    const WEBHOOK_KEY = window.CONFIG?.WEBHOOK_KEY || "";

    const userId = localStorage.getItem("employeeId");
    const userName = localStorage.getItem("employeeName") || "Unknown";
    const canSchedule = localStorage.getItem("canSchedule") === "Y";

    if(!userId) location.href="index.html";

    document.getElementById("who").textContent = `${userName} (${userId})`;
    document.getElementById("role").textContent = canSchedule ? "å¯æ’ç­" : "";

    if (canSchedule) document.getElementById("scheduleCard").style.display = "block";

    function jsonpCall(action, dataObj = {}, timeoutMs = 12000){
      return new Promise((resolve, reject)=>{
        const cbName="__cb_"+Math.random().toString(36).slice(2);
        const payload={webhookKey:WEBHOOK_KEY, userId, ...dataObj};
        const qs=new URLSearchParams();
        qs.set("action", action);
        qs.set("payload", JSON.stringify(payload));
        const url = ENDPOINT + "?" + qs.toString() + "&callback=" + cbName;

        const script=document.createElement("script");
        let done=false;

        const timer=setTimeout(()=>{
          if(done) return;
          done=true; cleanup();
          reject(new Error("timeout"));
        }, timeoutMs);

        function cleanup(){
          clearTimeout(timer);
          try{ delete window[cbName]; }catch(e){}
          if(script.parentNode) script.parentNode.removeChild(script);
        }

        window[cbName]=(res)=>{
          if(done) return;
          done=true; cleanup();
          resolve(res);
        };
        script.onerror=()=>{
          if(done) return;
          done=true; cleanup();
          reject(new Error("network error"));
        };

        document.head.appendChild(script);
        script.src=url;
      });
    }

    async function refresh(){
      const res = await jsonpCall("get_balances", {});
      if(!res.ok) throw new Error(res.message||"fail");

      document.getElementById("annualRemain").textContent = `${res.annualRemainHours||0} å°æ™‚`;
      document.getElementById("compRemain").textContent = `${res.compRemainHours||0} å°æ™‚`;
      document.getElementById("birthdayRemain").textContent = res.birthdayRemainHours||0;
      document.getElementById("birthdayHint").textContent = res.birthdayEligible ? "æœ¬æœˆå¯ç”¨ï¼ˆæœ€å¤š 8 å°æ™‚ï¼‰" : "éç”Ÿæ—¥æœˆï¼Œç„¡æ³•ä½¿ç”¨";
    }

    refresh().catch(e=>alert(e.message));

    function onCategoryChange(){
      const c = document.getElementById("category").value;
      document.getElementById("leaveArea").style.display = (c==="LEAVE") ? "block":"none";
    }
    onCategoryChange();

    async function submit(){
      const category = document.getElementById("category").value;
      const leaveType = document.getElementById("leaveType").value;
      const start = document.getElementById("start").value;
      const end = document.getElementById("end").value;
      const reason = document.getElementById("reason").value;

      const payload = { category, start, end, reason };
      if(category==="LEAVE") payload.leaveType = leaveType;

      try{
        const res = await jsonpCall("submit_request", payload);
        if(!res.ok) throw new Error(res.message||"fail");
        alert(res.message || "å·²é€å‡º");
        await refresh();
      }catch(e){
        alert("é€å‡ºå¤±æ•—ï¼š" + e.message);
      }
    }

    function openMyRequests(){
      location.href="requests.html";
    }
    function goSchedule(){
      location.href="schedule.html";
    }
    function logout(){
      localStorage.clear();
      location.href="index.html";
    }
  </script>
</body>
</html>
