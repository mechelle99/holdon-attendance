<script>
/* ===== 設定 ===== */
const LIFF_ID = "2009036245-XmZMSuuS";
const GAS_URL = "https://script.google.com/macros/s/AKfycbz0YAlbpIYDqN6UC99TmaksEfzylud1QzuwTaupCp9zGdpUlReuRxaG8cvryxziHli_/exec";

/** ✅ 公司定位點（請改成你們實際地址座標；可放多個據點） */
const COMPANY_POINTS = [
  { name: "公司", lat: 25.033964, lng: 121.564468 } // 範例：台北101附近，請務必改掉
];

/** ✅ 允許打卡距離（公尺） */
const ALLOW_DISTANCE = 100;

function minDistanceToCompany(lat, lng){
  if(!Array.isArray(COMPANY_POINTS) || COMPANY_POINTS.length === 0){
    return { distance: Infinity, name: "未設定公司座標" };
  }
  let best = { distance: Infinity, name: "" };
  for(const p of COMPANY_POINTS){
    const d = calcDistance(lat, lng, p.lat, p.lng);
    if(d < best.distance) best = { distance: d, name: p.name || "公司" };
  }
  return best; // {distance, name}
}

let userId="", displayName="", ready=false, isManager=false;
let lastGPS = null; // {lat,lng,distance,companyName}

/* ===== 工具 ===== */
const $ = id => document.getElementById(id);
function setStatus(msg,type="muted"){
  $("status").className="status "+(type==="ok"?"ok":type==="err"?"err":"muted");
  $("status").innerText=msg||"";
}
function enableAll(on){
  ["btnIn","btnOut","btnGPS","btnOTApply","btnLeaveApply","btnReloadMine","btnReloadPending"].forEach(id=>{
    if($(id)) $(id).disabled=!on;
  });
}
function escapeHtml_(s){
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function traceId_(){ return "liff-"+Date.now()+"-"+Math.random().toString(16).slice(2); }

/* ===== 距離計算（公尺） ===== */
function calcDistance(lat1,lng1,lat2,lng2){
  const R = 6371000;
  const toRad = d=>d*Math.PI/180;
  const dLat = toRad(lat2-lat1);
  const dLng = toRad(lng2-lng1);
  const a =
    Math.sin(dLat/2)**2 +
    Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*
    Math.sin(dLng/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

/* ===== JSONP（讀/寫共用） ===== */
function jsonp_(paramsObj){
  return new Promise((resolve,reject)=>{
    const cb = "cb_" + Date.now() + "_" + Math.random().toString(16).slice(2);
    paramsObj.callback = cb;

    const url = GAS_URL + "?" + new URLSearchParams(paramsObj).toString();
    const script = document.createElement("script");

    window[cb] = (data)=>{
      try{ resolve(data); }
      finally{
        try{ delete window[cb]; }catch(_){}
        script.remove();
      }
    };

    script.src = url;
    script.onerror = ()=>{ try{ delete window[cb]; }catch(_){} script.remove(); reject(new Error("jsonp_failed")); };
    document.body.appendChild(script);

    setTimeout(()=>{
      if(window[cb]){
        try{ delete window[cb]; }catch(_){}
        script.remove();
        reject(new Error("jsonp_timeout"));
      }
    }, 12000);
  });
}

async function jsonpWrite_(paramsObj, okMsg){
  try{
    setStatus("送出中...");
    const data = await jsonp_(paramsObj);
    if(data?.ok){
      setStatus(okMsg,"ok");
      return true;
    }
    setStatus(data?.message || "送出失敗","err");
    return false;
  }catch(e){
    console.error(e);
    setStatus("送出失敗（連線/逾時）","err");
    return false;
  }
}

/* ===== GPS ===== */
async function getGPS_(){
  $("gpsHint").innerText = "定位：取得中…";
  return new Promise((resolve,reject)=>{
    if(!navigator.geolocation) return reject(new Error("此裝置不支援定位"));
    navigator.geolocation.getCurrentPosition(
      pos=>{
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        const best = minDistanceToCompany(lat, lng);
        const d = best.distance;

        lastGPS = { lat, lng, distance: d, companyName: best.name };
        $("gpsHint").innerText = `定位：距離 ${best.name} ${Math.round(d)} 公尺`;

        if(d > ALLOW_DISTANCE){
          return reject(new Error(`不在打卡範圍內（${Math.round(d)}m，需 ≤ ${ALLOW_DISTANCE}m）`));
        }
        resolve(lastGPS);
      },
      _err => reject(new Error("GPS 取得失敗，請開啟定位權限")),
      { enableHighAccuracy:true, timeout:12000, maximumAge:0 }
    );
  });
}

/* ===== 打卡（GPS 100m） ===== */
async function punch_(type){
  if(!ready) return;

  // 先鎖按鈕，避免連點
  $("btnIn").disabled = true;
  $("btnOut").disabled = true;

  try{
    // 強制每次打卡重新取定位（防作弊）
    const gps = await getGPS_();

    const ok = await jsonpWrite_({
      action: "punch",
      type, // "IN" or "OUT"
      userId,
      displayName,
      lat: gps.lat,
      lng: gps.lng,
      distance: Math.round(gps.distance),
      companyName: gps.companyName,
      ts: Date.now(),
      traceId: traceId_()
    }, type==="IN" ? "上班打卡成功 ✅" : "下班打卡成功 ✅");

    if(ok){
      // 打完卡順手更新「我的申請」或你的打卡紀錄區（你後面如果有列表就接）
      // loadMine();
    }
  }catch(e){
    setStatus(e.message || "打卡失敗","err");
  }finally{
    // 只要系統 ready，就放回按鈕（你也可以加上：依狀態決定能不能打 IN/OUT）
    $("btnIn").disabled = !ready;
    $("btnOut").disabled = !ready;
  }
}
</script>
