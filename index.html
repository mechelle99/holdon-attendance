<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>ç™»å…¥ - HR Portal</title>
  <style>
    body { font-family: -apple-system, sans-serif; background: #F3F4F6; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; color: #1F2937; }
    .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 320px; }
    h1 { font-size: 24px; text-align: center; margin-bottom: 24px; color: #4F46E5; }
    
    .input-group { margin-bottom: 16px; }
    label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; color: #4B5563; }
    input { width: 100%; padding: 12px; border: 1px solid #E5E7EB; border-radius: 10px; font-size: 16px; box-sizing: border-box; outline: none; transition: border 0.2s; }
    input:focus { border-color: #4F46E5; }
    
    button { width: 100%; background: #4F46E5; color: white; padding: 14px; border: none; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: background 0.2s; margin-top: 10px; }
    button:active { background: #4338CA; transform: scale(0.98); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    
    .link { text-align: center; margin-top: 16px; font-size: 13px; color: #6B7280; cursor: pointer; text-decoration: underline; }
    .hidden { display: none; }
  </style>
</head>
<body>

  <div id="loginForm" class="card">
    <h1>HR Portal</h1>
    <div class="input-group">
      <label>å“¡å·¥ç·¨è™Ÿ</label>
      <input type="text" id="uid" placeholder="ä¾‹å¦‚ï¼šA001">
    </div>
    <div class="input-group">
      <label>å¯†ç¢¼</label>
      <input type="password" id="pwd" placeholder="è¼¸å…¥å¯†ç¢¼">
    </div>
    <button id="btnLogin" onclick="login()">ç™»å…¥</button>
    <div class="link" onclick="showForgot()">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</div>
  </div>

  <div id="forgotForm" class="card hidden">
    <h1>é‡è¨­å¯†ç¢¼</h1>
    <div class="input-group">
      <label>å“¡å·¥ç·¨è™Ÿ</label>
      <input type="text" id="f_uid" placeholder="è¼¸å…¥å¸³è™Ÿ">
    </div>
    <div class="input-group">
      <label>è¨»å†Šä¿¡ç®±</label>
      <input type="email" id="f_email" placeholder="è¼¸å…¥ Email">
    </div>
    <button id="btnForgot" onclick="sendToken()">å¯„é€é©—è­‰ç¢¼</button>
    <div class="link" onclick="showLogin()">è¿”å›ç™»å…¥</div>
  </div>

  <div id="resetForm" class="card hidden">
    <h1>è¨­å®šæ–°å¯†ç¢¼</h1>
    <div class="input-group">
      <label>é©—è­‰ç¢¼</label>
      <input type="text" id="r_token" placeholder="æŸ¥çœ‹ä¿¡ç®±è¼¸å…¥ 6 ä½æ•¸">
    </div>
    <div class="input-group">
      <label>æ–°å¯†ç¢¼</label>
      <input type="password" id="r_newPwd" placeholder="è¼¸å…¥æ–°å¯†ç¢¼">
    </div>
    <button id="btnReset" onclick="doReset()">ç¢ºèªä¿®æ”¹</button>
    <div class="link" onclick="showLogin()">å–æ¶ˆ</div>
  </div>

<script src="config.js"></script>
<script>
  // åˆ‡æ›ç•«é¢
  function showLogin() { hideAll(); document.getElementById('loginForm').classList.remove('hidden'); }
  function showForgot() { hideAll(); document.getElementById('forgotForm').classList.remove('hidden'); }
  function showReset() { hideAll(); document.getElementById('resetForm').classList.remove('hidden'); }
  function hideAll() { document.querySelectorAll('.card').forEach(c => c.classList.add('hidden')); }

  // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥ï¼Œè‹¥å·²ç™»å…¥ç›´æ¥è·³è½‰
  if (localStorage.getItem("empId")) {
    location.href = "app.html";
  }

  // âœ… å‡ç´šç‰ˆï¼šä½¿ç”¨ç¾ä»£ fetch API ç™¼é€ POST è«‹æ±‚ï¼Œé¿é–‹å¤–æ›æ””æˆªèˆ‡é•·åº¦é™åˆ¶
  async function api(action, data={}) {
    if(!window.CONFIG || !window.CONFIG.GAS_ENDPOINT){
      alert("ç³»çµ±è¨­å®šéŒ¯èª¤ï¼šæ‰¾ä¸åˆ° CONFIG.GAS_ENDPOINT");
      throw new Error("No Config");
    }

    // å°‡ action å’Œè³‡æ–™åŒ…è£åœ¨ä¸€èµ·ï¼Œå°é½Šä½ å¾Œç«¯çš„è§£æé‚è¼¯
    const payloadBody = {
      action: action,
      payload: data
    };

    try {
      // å»ºç«‹ä¸€å€‹ 15 ç§’çš„ Timeout æ§åˆ¶å™¨
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 15000);

      const response = await fetch(window.CONFIG.GAS_ENDPOINT, {
        method: 'POST',
        // ğŸ’¡ é—œéµï¼šè¨­å®šç‚º text/plain é¿å…è§¸ç™¼åš´æ ¼çš„ CORS é æª¢ (Preflight)
        headers: {
          'Content-Type': 'text/plain;charset=utf-8', 
        },
        body: JSON.stringify(payloadBody),
        redirect: 'follow', // GAS å¿…å®šè½‰å€ï¼Œæ­¤è¨­å®šç‚ºå¿…é ˆ
        signal: controller.signal // ç¶å®š Timeout
      });

      clearTimeout(timeoutId); // æˆåŠŸå›æ‡‰å°±è§£é™¤ Timeout

      if (!response.ok) {
        throw new Error(`HTTP éŒ¯èª¤ç‹€æ…‹ç¢¼: ${response.status}`);
      }

      // ç›´æ¥å°‡ GAS å›å‚³çš„å­—ä¸²è§£æç‚º JSON
      const result = await response.json();
      return result;

    } catch (error) {
      console.error("API å‘¼å«å¤±æ•—:", error);
      if (error.name === 'AbortError') {
         throw new Error("ç¶²è·¯é€£ç·šé€¾æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦");
      }
      throw new Error("ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é˜²è­·å¤–æ›è¨­å®š");
    }
  }

  // ç™»å…¥
  async function login() {
      const id = document.getElementById("uid").value.trim();
      const pwd = document.getElementById("pwd").value.trim();
      if(!id || !pwd) { alert("è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"); return; }
      
      const btn = document.getElementById("btnLogin");
      btn.innerText = "ç™»å…¥ä¸­...";
      btn.disabled = true;

      try {
        const res = await api("login", { empId: id, pass: pwd });
        
        if(res && res.ok) {
            // âœ… çµ±ä¸€ localStorage çš„ Key å‘½åï¼Œèˆ‡ app.html å°é½Š
            localStorage.setItem("empId", res.empId);
            localStorage.setItem("empName", res.empName || res.name || id);
            localStorage.setItem("isManager", res.isManager ? "true" : "false");
            localStorage.setItem("canSchedule", res.canSchedule ? "true" : "false");
            
            location.href = "app.html";
        } else {
            alert(res ? res.message : "ç™»å…¥å¤±æ•—");
        }
      } catch(err) {
        alert(err.message || "ç™¼ç”ŸéŒ¯èª¤");
      } finally {
        btn.innerText = "ç™»å…¥";
        btn.disabled = false;
      }
  }

  // å¯„é€ Token
  async function sendToken() {
      const id = document.getElementById("f_uid").value.trim();
      const email = document.getElementById("f_email").value.trim();
      if(!id || !email) { alert("è«‹å¡«å¯«æ¬„ä½"); return; }
      
      const btn = document.getElementById("btnForgot");
      btn.innerText = "è™•ç†ä¸­...";
      btn.disabled = true;

      try {
        const res = await api("forgot_password", { empId: id, email: email });
        alert(res ? res.message : "è«‹æ±‚å·²é€å‡º");
        
        if(res && res.ok) showReset();
      } catch(err) {
        alert(err.message || "ç™¼ç”ŸéŒ¯èª¤");
      } finally {
        btn.innerText = "å¯„é€é©—è­‰ç¢¼";
        btn.disabled = false;
      }
  }

  // ä¿®æ”¹å¯†ç¢¼
  async function doReset() {
      const id = document.getElementById("f_uid").value.trim(); // æ²¿ç”¨ä¸Šä¸€é çš„ ID
      const token = document.getElementById("r_token").value.trim();
      const np = document.getElementById("r_newPwd").value.trim();
      if(!token || !np) { alert("è«‹å¡«å¯«æ¬„ä½"); return; }
      
      const btn = document.getElementById("btnReset");
      btn.innerText = "æ›´æ–°ä¸­...";
      btn.disabled = true;

      try {
        const res = await api("reset_password_confirm", { empId: id, token: token, newPass: np });
        alert(res ? res.message : "è™•ç†å®Œç•¢");
        
        if(res && res.ok) {
          // æ¸…ç©ºå¯†ç¢¼æ¬„ä½ä¸¦è¿”å›ç™»å…¥
          document.getElementById("r_newPwd").value = "";
          document.getElementById("pwd").value = "";
          showLogin();
        }
      } catch(err) {
        alert(err.message || "ç™¼ç”ŸéŒ¯èª¤");
      } finally {
        btn.innerText = "ç¢ºèªä¿®æ”¹";
        btn.disabled = false;
      }
  }
</script>
</body>
</html>
