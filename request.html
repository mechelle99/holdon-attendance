<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>æå‡ºç”³è«‹</title>
  <style>
    :root { --primary: #4F46E5; --bg: #F3F4F6; --card: #FFFFFF; --text: #1F2937; }
    body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 20px 20px 100px 20px; color: var(--text); }
    
    .header { margin-bottom: 20px; }
    h2 { margin: 0; font-size: 22px; }

    .form-card { background: var(--card); border-radius: 20px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    
    .input-group { margin-bottom: 20px; }
    label { display: block; font-size: 13px; font-weight: 600; color: #4B5563; margin-bottom: 6px; }
    
    select, input, textarea {
      width: 100%; padding: 12px; border: 1px solid #E5E7EB; border-radius: 12px;
      font-size: 16px; background: #F9FAFB; outline: none; -webkit-appearance: none;
    }
    
    /* é‡å° iOS Safari ä¸‹æ‹‰é¸å–®å„ªåŒ– */
    select { background-color: #F9FAFB; }

    /* Checkbox */
    .checkbox-wrapper { display: flex; align-items: center; gap: 10px; padding: 10px; background: #EEF2FF; border-radius: 12px; display: none; /* é è¨­éš±è— */ }
    .checkbox-wrapper input { width: 20px; height: 20px; margin: 0; }
    .checkbox-wrapper label { margin: 0; color: var(--primary); font-size: 14px; }

    .btn-submit {
      width: 100%; background: var(--primary); color: white; padding: 16px;
      border: none; border-radius: 16px; font-size: 16px; font-weight: 700;
      cursor: pointer; box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); margin-top: 10px;
    }
    .btn-submit:active { transform: scale(0.98); }

    .nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); padding: 12px 20px; padding-bottom: max(12px, env(safe-area-inset-bottom)); display: flex; justify-content: space-around; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); border-top-left-radius: 24px; border-top-right-radius: 24px; z-index: 100; }
    .nav-item { text-decoration: none; color: #9CA3AF; display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 4px; }
    .nav-item.active { color: var(--primary); }
    .nav-icon { font-size: 22px; }
  </style>
</head>
<body>

  <div class="header"><h2>ğŸ“ æå‡ºç”³è«‹</h2></div>

  <div class="form-card">
    <div class="input-group">
      <label>ç”³è«‹é¡å‹</label>
      <select id="cat" onchange="uiChange()">
        <option value="LEAVE">è«‹å‡</option>
        <option value="OT">åŠ ç­</option>
        <option value="CORRECTION">è£œå¡</option>
        <option value="OUTING">å¤–å‡ºç”³è«‹</option>
      </select>
    </div>

    <div class="input-group" id="typeGrp">
      <label>å‡åˆ¥</label>
      <select id="type">
        <option value="annual">ç‰¹ä¼‘</option>
        <option value="comp">è£œä¼‘</option>
        <option value="personal">äº‹å‡</option>
        <option value="sick">ç—…å‡</option>
        <option value="menstrual">ç”Ÿç†å‡</option>
        <option value="official">å…¬å‡</option>
        <option value="marriage">å©šå‡</option>
        <option value="bereavement">å–ªå‡</option>
        <option value="family">å®¶åº­ç…§é¡§å‡</option>
        <option value="maternity">ç”¢å‡</option>
        <option value="prenatal">ç”¢æª¢å‡</option>
        <option value="paternity">é™ªç”¢æª¢åŠé™ªç”¢å‡</option>
        <option value="miscarriage">æµç”¢å‡</option>
        <option value="injury">å…¬å‚·ç—…å‡</option>
        <option value="epidemic">é˜²ç–«ç…§é¡§å‡</option>
        <option value="birthday">ç”Ÿæ—¥å‡</option>
      </select>
    </div>

    <div class="input-group">
      <label id="startLbl">é–‹å§‹æ™‚é–“</label>
      <input type="datetime-local" id="start" onchange="calc()">
    </div>

    <div class="input-group" id="endGrp">
      <label>çµæŸæ™‚é–“</label>
      <input type="datetime-local" id="end" onchange="calc()">
    </div>
    
    <div class="input-group" id="hrsGrp">
      <label>æ™‚æ•¸ (è‡ªå‹•è¨ˆç®—)</label>
      <input type="number" id="hours" step="0.5" readonly style="color:#6B7280; background:#f3f4f6;">
    </div>

    <div class="checkbox-wrapper" id="autoClockGrp">
      <input type="checkbox" id="autoClock">
      <label for="autoClock">ç«‹å³æ‰“å¡ (ç¾åœ¨å‡ºé–€)</label>
    </div>

    <div class="input-group">
      <label>äº‹ç”±</label>
      <textarea id="reason" rows="3" placeholder="è«‹å¡«å¯«èªªæ˜..."></textarea>
    </div>

    <button class="btn-submit" onclick="submit()">é€å‡ºç”³è«‹</button>
  </div>

  <nav class="nav">
    <a href="app.html" class="nav-item"><span class="nav-icon">ğŸ </span>é¦–é </a>
    <a href="request.html" class="nav-item active"><span class="nav-icon">ğŸ“</span>ç”³è«‹</a>
    <a href="history.html" class="nav-item"><span class="nav-icon">ğŸ“‹</span>ç´€éŒ„</a>
    <a href="schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span>æ’ç­</a>
    <a href="manager.html" class="nav-item" id="mgrBtn" style="display:none"><span class="nav-icon">ğŸ‘‘</span>ä¸»ç®¡</a>
  </nav>

<script src="config.js"></script>
<script>
  const uid = localStorage.getItem("employeeId");
  const isMgr = localStorage.getItem("isManager") === "true";
  if(isMgr) document.getElementById("mgrBtn").style.display = 'flex';

  const fullLeaveOptions = document.getElementById("type").innerHTML;

  function uiChange() {
      const c = document.getElementById("cat").value;
      const typeDiv = document.getElementById("typeGrp");
      const endDiv = document.getElementById("endGrp");
      const hrsDiv = document.getElementById("hrsGrp");
      const lbl = document.getElementById("startLbl");
      const clockDiv = document.getElementById("autoClockGrp");

      // é‡ç½®é¡¯ç¤ºç‹€æ…‹
      typeDiv.style.display = 'block';
      endDiv.style.display = 'block';
      hrsDiv.style.display = 'block';
      clockDiv.style.display = 'none';
      lbl.innerText = 'é–‹å§‹æ™‚é–“';

      if (c === 'CORRECTION') { 
          // è£œå¡ï¼šåªæœ‰ä¸€å€‹æ™‚é–“é»ï¼Œç„¡å‡åˆ¥ï¼Œç„¡æ™‚æ•¸
          endDiv.style.display = 'none';
          hrsDiv.style.display = 'none';
          typeDiv.style.display = 'none';
          lbl.innerText = 'è£œå¡æ™‚é–“';
      } else if (c === 'OUTING') { 
          // å¤–å‡ºï¼šæœ‰èµ·è¨–ï¼Œä½†ç„¡å‡åˆ¥ï¼Œå¯è‡ªå‹•æ‰“å¡
          typeDiv.style.display = 'none'; 
          lbl.innerText = 'é è¨ˆå¤–å‡ºæ™‚é–“';
          clockDiv.style.display = 'flex';
          // å¤–å‡ºä¹Ÿéœ€è¦ç®—æ™‚æ•¸å—ï¼Ÿé€šå¸¸éœ€è¦ï¼Œè‹¥ä¸éœ€è¦å¯éš±è— hrsDiv
      } else if (c === 'OT') { 
          // åŠ ç­ï¼šæœ‰èµ·è¨–ï¼Œç„¡å‡åˆ¥
          typeDiv.style.display = 'none';
          lbl.innerText = 'åŠ ç­é–‹å§‹æ™‚é–“';
      } else {
          // è«‹å‡ï¼šå…¨é¡¯ç¤º
          document.getElementById("type").innerHTML = fullLeaveOptions;
      }
      
      // åˆ‡æ›é¡åˆ¥æ™‚é‡ç®—ä¸€æ¬¡ (é¿å…æ®˜ç•™èˆŠæ•¸å€¼)
      calc();
  }

  function calc() {
      const cat = document.getElementById("cat").value;
      const sVal = document.getElementById("start").value;
      const eVal = document.getElementById("end").value;
      const hInput = document.getElementById("hours");

      // è£œå¡ä¸éœ€è¦ç®—æ™‚æ•¸
      if (cat === 'CORRECTION') {
          hInput.value = 0;
          return;
      }

      if (sVal && eVal) {
          const s = new Date(sVal);
          const e = new Date(eVal);

          if (e <= s) {
              // çµæŸæ™‚é–“éŒ¯èª¤
              hInput.value = 0;
              return;
          }

          // åˆ¤æ–·æ˜¯å¦åŒå¤© (æ¯”å° å¹´/æœˆ/æ—¥)
          const isSameDay = (s.getFullYear() === e.getFullYear() && 
                             s.getMonth() === e.getMonth() && 
                             s.getDate() === e.getDate());

          if (isSameDay) {
              // åŒä¸€å¤©ï¼šç›´æ¥ç®—æ™‚é–“å·® (å°æ™‚)
              const diffMs = e - s;
              const hours = (diffMs / (1000 * 60 * 60)).toFixed(1);
              hInput.value = hours;
          } else {
              // è·¨å¤©ï¼šä¾éœ€æ±‚ã€Œä¸€å¤©8å°æ™‚ã€è¨ˆç®—
              // ç®—æ³•ï¼š(çµæŸæ—¥æœŸ - é–‹å§‹æ—¥æœŸ) çš„å¤©æ•¸å·®
              // è‹¥ 2/12 10:00 åˆ° 2/13 10:00ï¼Œç®— 2 å¤© = 16 å°æ™‚
              
              // å–å¾—ç´”æ—¥æœŸç‰©ä»¶ (æ™‚é–“è¨­ç‚º 00:00:00 ä»¥è¨ˆç®—å¤©æ•¸)
              const sDate = new Date(s.getFullYear(), s.getMonth(), s.getDate());
              const eDate = new Date(e.getFullYear(), e.getMonth(), e.getDate());
              
              // æ¯«ç§’å·®è½‰å¤©æ•¸
              const dayDiff = Math.round((eDate - sDate) / (1000 * 60 * 60 * 24));
              
              // ç¸½å¤©æ•¸ = é–“éš”å¤©æ•¸ + 1 (ä¾‹å¦‚ 12è™Ÿåˆ°13è™Ÿï¼Œé–“éš”1å¤©ï¼Œå…¶å¯¦æ˜¯æ¶µè“‹2å€‹å·¥ä½œæ—¥)
              const totalDays = dayDiff + 1;
              
              hInput.value = totalDays * 8;
          }
      }
  }

  function api(act, d={}) {
    return new Promise(r => {
      const s = document.createElement("script");
      s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${act}&payload=${encodeURIComponent(JSON.stringify({...d, userId:uid}))}&callback=cb${Date.now()}`;
      window[`cb${Date.now()}`] = (res) => { r(res); s.remove(); };
      document.body.appendChild(s);
    });
  }

  async function submit() {
      const cat = document.getElementById("cat").value;
      const start = document.getElementById("start").value;
      const end = document.getElementById("end").value;
      const auto = document.getElementById("autoClock").checked;
      
      if(!start) { alert("è«‹å¡«å¯«æ™‚é–“"); return; }
      if(cat !== 'CORRECTION' && !end) { alert("è«‹å¡«å¯«çµæŸæ™‚é–“"); return; }

      const btn = document.querySelector(".btn-submit");
      btn.innerText = "è™•ç†ä¸­..."; btn.disabled = true;

      const payload = {
          category: cat,
          leaveType: document.getElementById("type").value,
          start: start,
          end: cat === 'CORRECTION' ? start : end, // è£œå¡çµæŸæ™‚é–“åŒé–‹å§‹
          hours: document.getElementById("hours").value || 0,
          reason: document.getElementById("reason").value,
          autoClock: auto
      };

      const res = await api("submit_request", payload);
      alert(res.message);
      location.href = 'history.html';
  }
  
  // åˆå§‹åŒ–
  uiChange();
</script>
</body>
</html>
