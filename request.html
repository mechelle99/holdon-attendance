<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>å¡«å¯«ç”³è«‹å–®</title>
  <style>
    :root { --primary: #4F46E5; --bg: #F3F4F6; --card: #FFFFFF; --text: #1F2937; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); margin: 0; padding: 20px 20px 80px 20px; color: var(--text); }
    h2 { font-size: 20px; margin-bottom: 12px; font-weight: 700; }
    .hint { font-size:12px; color:#6B7280; margin:0 0 14px; }
    .form-group { margin-bottom: 18px; }
    label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: #4B5563; }
    input, select, textarea { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #E5E7EB; background: #fff; font-size: 16px; box-sizing: border-box; -webkit-appearance: none; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
    textarea { resize: vertical; min-height: 80px; }
    .row { display:flex; gap:10px; }
    .row > div { flex:1; }
    .chip { display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border:1px solid #E5E7EB; border-radius:12px; background:#fff; }
    .chip input { width:auto; }
    .btn-submit { width: 100%; background: var(--primary); color: white; padding: 14px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; margin-top: 10px; cursor: pointer; }
    .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; }
    .nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--card); padding: 12px 20px; padding-bottom: max(12px, env(safe-area-inset-bottom)); display: flex; justify-content: space-around; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); border-top-left-radius: 24px; border-top-right-radius: 24px; z-index: 100; }
    .nav-item { text-decoration: none; color: #9CA3AF; display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 4px; }
    .nav-item.active { color: var(--primary); } .nav-icon { font-size: 22px; }
  </style>
</head>
<body>

  <h2>ğŸ“ å¡«å¯«ç”³è«‹å–®</h2>
  <p class="hint">è«‹å‡ï¼šä»¥ã€Œæ’ç­ã€ç‚ºå„ªå…ˆï¼ˆå«å‡æ—¥æ’ç­ï¼‰ï¼›æ²’æ’ç­æ‰ç”¨é è¨­ 10:00-18:00ã€‚åŠ ç­/å¤–å‡ºï¼šç”¨å¯¦éš›å€é–“ä¸¦æ‰£åˆä¼‘ã€‚</p>

  <div class="form-group">
    <label>ç”³è«‹é¡å‹</label>
    <select id="cat" onchange="toggleType()">
      <option value="LEAVE">è«‹å‡</option>
      <option value="OT">åŠ ç­</option>
      <option value="OUTING">å¤–å‡º</option>
      <option value="CORRECTION">è£œå¡</option>
    </select>
  </div>

  <div class="form-group" id="typeGroup">
    <label>å‡åˆ¥</label>
    <select id="type" onchange="calcHoursSmart()">
      <option value="annual">ç‰¹ä¼‘</option>
      <option value="comp">è£œä¼‘</option>
      <option value="personal">äº‹å‡</option>
      <option value="sick">ç—…å‡</option>
      <option value="official">å…¬å‡</option>
      <option value="marriage">å©šå‡</option>
      <option value="bereavement">å–ªå‡</option>
      <option value="menstrual">ç”Ÿç†å‡</option>
      <option value="maternity">ç”¢å‡</option>
      <option value="paternity">é™ªç”¢å‡</option>
      <option value="family">å®¶åº­ç…§é¡§å‡</option>
      <option value="birthday">ç”Ÿæ—¥å‡</option>
    </select>
  </div>

  <div class="form-group">
    <label>é–‹å§‹æ™‚é–“</label>
    <input type="datetime-local" id="start" onchange="onTimeChange()">
  </div>

  <div class="form-group" id="endGroup">
    <label>çµæŸæ™‚é–“</label>
    <input type="datetime-local" id="end" onchange="onTimeChange()">
  </div>

  <div class="form-group" id="extraGroup" style="display:none;">
    <div class="row">
      <div class="chip">
        <input type="checkbox" id="isTrip" onchange="calcHoursSmart()"/>
        <label for="isTrip" style="margin:0;">å‡ºå·®ï¼ˆå¤–å‡ºå¯è¶…é 8 å°æ™‚ï¼‰</label>
      </div>
      <div class="chip">
        <input type="checkbox" id="autoClock" />
        <label for="autoClock" style="margin:0;">å¤–å‡ºå–®åŒæ™‚è‡ªå‹•æ‰“å¡</label>
      </div>
    </div>
  </div>

  <div class="form-group" id="hoursGroup">
    <label>æ™‚æ•¸ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</label>
    <input type="number" id="hours" value="0" readonly style="background-color: #F3F4F6;">
  </div>

  <div class="form-group">
    <label>äº‹ç”±</label>
    <textarea id="reason" placeholder="è«‹å¡«å¯«èªªæ˜..."></textarea>
  </div>

  <button class="btn-submit" id="submitBtn" onclick="submitReq()">é€å‡ºç”³è«‹</button>

  <nav class="nav">
    <a href="app.html" class="nav-item"><span class="nav-icon">ğŸ </span>é¦–é </a>
    <a href="request.html" class="nav-item active"><span class="nav-icon">ğŸ“</span>ç”³è«‹</a>
    <a href="history.html" class="nav-item"><span class="nav-icon">ğŸ“‹</span>ç´€éŒ„</a>
    <a href="schedule.html" class="nav-item"><span class="nav-icon">ğŸ“…</span>æ’ç­</a>
    <a href="manager.html" class="nav-item"><span class="nav-icon">ğŸ‘‘</span>ä¸»ç®¡</a>
  </nav>

<script src="config.js"></script>
<script>
  const uid = localStorage.getItem("employeeId");
  if(!uid) location.href='index.html';

  // ======== JSONP API (å« timeoutï¼Œé¿å…ã€Œé€å‡ºä¸­å¡ä½ã€) ========
  function api(act, d={}) {
    return new Promise((resolve, reject) => {
      const cbName = "cb_" + Date.now() + "_" + Math.floor(Math.random() * 100000);
      const s = document.createElement("script");

      const payload = encodeURIComponent(JSON.stringify({...d, userId: uid}));
      s.src = `${window.CONFIG.GAS_ENDPOINT}?action=${act}&payload=${payload}&callback=${cbName}&_=${Date.now()}`;

      const timer = setTimeout(() => {
        cleanup();
        reject(new Error("timeout"));
      }, 15000);

      function cleanup(){
        clearTimeout(timer);
        try { delete window[cbName]; } catch(e){}
        try { s.remove(); } catch(e){}
      }

      window[cbName] = (res) => { cleanup(); resolve(res); };
      s.onerror = () => { cleanup(); reject(new Error("Network Error")); };
      document.body.appendChild(s);
    });
  }

  // ======== è¦å‰‡è³‡æ–™å¿«å– ========
  let RULES = null; // { holidays:Set, scheduleMap:{'yyyy-mm-dd':'EARLY|LATE|OFF'} }

  async function ensureRules(){
    if (RULES) return RULES;
    const sVal = document.getElementById("start").value;
    const eVal = document.getElementById("end").value || sVal;

    const res = await api("get_rules", { start: sVal, end: eVal });
    if (!res || !res.ok) throw new Error(res && res.message ? res.message : "get_rules failed");

    RULES = {
      holidays: new Set(res.holidays || []),
      scheduleMap: res.scheduleMap || {}
    };
    return RULES;
  }

  // ======== åˆå§‹åŒ–æ™‚é–“ï¼šä»Šå¤© 10:00-18:00ï¼ˆç¬¦åˆä½ å€‘é è¨­ï¼‰ ========
  const now = new Date();
  const ymd = now.toISOString().split('T')[0];
  document.getElementById("start").value = `${ymd}T10:00`;
  document.getElementById("end").value   = `${ymd}T18:00`;

  // ======== UI toggle ========
  function toggleType() {
    const cat = document.getElementById("cat").value;
    const typeGroup = document.getElementById("typeGroup");
    const hoursGroup = document.getElementById("hoursGroup");
    const endGroup = document.getElementById("endGroup");
    const extraGroup = document.getElementById("extraGroup");

    RULES = null; // reset cache

    if (cat === 'CORRECTION') {
      typeGroup.style.display = 'none';
      hoursGroup.style.display = 'none';
      endGroup.style.display = 'none';
      extraGroup.style.display = 'none';
      const sVal = document.getElementById("start").value;
      if (sVal) document.getElementById("end").value = sVal;
      document.getElementById("hours").value = 0;
    } else if (cat === 'OUTING') {
      typeGroup.style.display = 'none';
      hoursGroup.style.display = 'block';
      endGroup.style.display = 'block';
      extraGroup.style.display = 'block';
      calcHoursSmart();
    } else if (cat === 'OT') {
      typeGroup.style.display = 'none';
      extraGroup.style.display = 'none';
      hoursGroup.style.display = 'block';
      endGroup.style.display = 'block';
      calcHoursSmart();
    } else {
      typeGroup.style.display = 'block';
      extraGroup.style.display = 'none';
      hoursGroup.style.display = 'block';
      endGroup.style.display = 'block';
      calcHoursSmart();
    }
  }

  function onTimeChange(){
    const sVal = document.getElementById("start").value;
    const eVal = document.getElementById("end").value;
    if (sVal && eVal) {
      const s = new Date(sVal);
      const e = new Date(eVal);
      if (e < s) document.getElementById("end").value = sVal;
    }
    RULES = null;
    calcHoursSmart();
  }

  // ======== å·¥å…·ï¼šæ—¥æœŸ/å€é–“ ========
  function toYMD(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function isWeekend(d){ const w = d.getDay(); return w===0 || w===6; }

  // åˆä¼‘æ‰£é™¤ï¼ˆä¿ç•™åŸé‚è¼¯ï¼šåªæœ‰ OT/OUTING æ‰æ‰£ï¼›LEAVE ä¸æ‰£ï¼‰
  function breakDeductionHours(s, e){
    const b1s = new Date(s); b1s.setHours(12,0,0,0);
    const b1e = new Date(s); b1e.setHours(13,0,0,0);
    const overlap = Math.max(0, Math.min(e, b1e) - Math.max(s, b1s));
    return overlap > 0 ? 1 : 0;
  }

  // ======== ç­åˆ¥æ™‚é–“çª—ï¼šä½ å€‘è¦å‰‡ ========
  // EARLY: 10:00-18:00 (8h)
  // LATE : 12:00-21:00 (9hï¼Œé€™è£¡ä¸æ‰£ä¼‘æ¯ï¼Œå› ç‚ºä½ èªªå¤§å®¶è‡ªå·±æ‰¾æ™‚é–“ä¼‘æ¯ï¼›è«‹å‡ä»¥æ’ç­æ™‚æ®µç‚ºæº–)
  // OFF  : 0h
  function buildShiftWindow(dayDate, shiftRaw){
    const s = String(shiftRaw || "").trim().toUpperCase();
    const start = new Date(dayDate); start.setHours(10,0,0,0);
    const end   = new Date(dayDate); end.setHours(18,0,0,0);

    if (!s || s.includes("EARLY") || s.includes("æ—©")) {
      return { start, end, hours: 8 };
    }
    if (s.includes("LATE") || s.includes("åˆ")) {
      const ls = new Date(dayDate); ls.setHours(12,0,0,0);
      const le = new Date(dayDate); le.setHours(21,0,0,0);
      return { start: ls, end: le, hours: 9 };
    }
    if (s.includes("OFF") || s.includes("ä¼‘")) {
      return { start, end: start, hours: 0 };
    }
    // å…¶ä»–æœªçŸ¥å€¼ï¼šä¿å®ˆç”¨é è¨­æ—©ç­
    return { start, end, hours: 8 };
  }

  function clampToDayWindow(s, e, win){
    const ss = new Date(Math.max(s.getTime(), win.start.getTime()));
    const ee = new Date(Math.min(e.getTime(), win.end.getTime()));
    if (ee <= ss) return 0;
    return (ee - ss) / (1000*60*60);
  }

  // ======== æ ¸å¿ƒï¼šæ™ºèƒ½ç®—æ™‚æ•¸ ========
  async function calcHoursSmart(){
    const cat = document.getElementById("cat").value;
    if (cat === 'CORRECTION') return;

    const sVal = document.getElementById("start").value;
    const eVal = document.getElementById("end").value;
    if (!sVal || !eVal) return;

    const s = new Date(sVal);
    const e = new Date(eVal);

    if (e <= s){
      document.getElementById("hours").value = 0;
      return;
    }

    try{
      // =========================
      // âœ… è«‹å‡ï¼šæ’ç­å„ªå…ˆï¼ˆå«å‡æ—¥æ’ç­ï¼‰
      // è¦å‰‡ï¼š
      // - è‹¥ç•¶å¤©æœ‰æ’ç­ï¼šç…§æ’ç­ç­åˆ¥æ™‚é–“çª—ç®—ï¼ˆEARLY/LATEï¼‰
      // - è‹¥ç•¶å¤©ç„¡æ’ç­ï¼š
      //   - å¹³æ—¥ï¼šç”¨é è¨­ 10:00-18:00 (8h)
      //   - å‡æ—¥/é€±æœ«ï¼š0
      // - æ”¯æ´éƒ¨åˆ†å¤©ï¼šä¾ start/end èˆ‡ç­åˆ¥æ™‚é–“çª—äº¤é›†ç®—
      // =========================
      if (cat === 'LEAVE'){
        const rules = await ensureRules();

        let total = 0;
        const cur = new Date(s); cur.setHours(0,0,0,0);
        const endDay = new Date(e); endDay.setHours(0,0,0,0);

        while (cur <= endDay){
          const ymdKey = toYMD(cur);

          const shift = (rules.scheduleMap[ymdKey] || ""); // âœ… å¯èƒ½ç©º
          const shiftStr = String(shift).trim();
          const upper = shiftStr.toUpperCase();

          const hasSchedule = shiftStr !== "" && !upper.includes("OFF") && !shiftStr.includes("ä¼‘");
          const isHol = rules.holidays.has(ymdKey);

          // âœ… å‡æ—¥ä¹Ÿå¯èƒ½æ’ç­ï¼šå‡æ—¥/é€±æœ«ã€Œæ²’æ’ç­ã€æ‰ç®— 0
          if ((isWeekend(cur) || isHol) && !hasSchedule) {
            cur.setDate(cur.getDate()+1);
            continue;
          }

          const win = hasSchedule
            ? buildShiftWindow(cur, shiftStr)
            : buildShiftWindow(cur, "EARLY"); // å¹³æ—¥ç„¡æ’ç­ â†’ ç”¨é è¨­æ—©ç­

          // ç•¶å¤©å¯¦éš›è«‹å‡å€é–“ï¼ˆåˆ‡å‡ºç•¶å¤© 00:00~24:00 çš„äº¤é›†ï¼‰
          const dayStart = new Date(cur); dayStart.setHours(0,0,0,0);
          const dayEnd = new Date(cur); dayEnd.setHours(23,59,59,999);

          const segS = new Date(Math.max(s.getTime(), dayStart.getTime()));
          const segE = new Date(Math.min(e.getTime(), dayEnd.getTime()));

          // èˆ‡ç­åˆ¥æ™‚é–“çª—äº¤é›†
          const hrs = clampToDayWindow(segS, segE, win);
          total += hrs;

          cur.setDate(cur.getDate()+1);
        }

        // ä½ å€‘ä¸èªª 0.5 å–®ä½ï¼Œæˆ‘å…ˆä¸ç¡¬åˆ‡ï¼›è‹¥è¦ 0.5 å–®ä½å†åŠ 
        document.getElementById("hours").value = (Math.round(total * 10) / 10).toFixed(1);
        return;
      }

      // åŠ ç­ï¼šå¯¦éš›å€é–“ - æ‰£åˆä¼‘ï¼›æœ€å° 0.5
      if (cat === 'OT'){
        let diff = (e - s) / (1000*60*60);
        diff -= breakDeductionHours(s, e);
        diff = Math.max(0, diff);
        diff = Math.max(0.5, Math.round(diff * 2) / 2);
        document.getElementById("hours").value = diff.toFixed(1);
        return;
      }

      // å¤–å‡ºï¼šå¯¦éš›å€é–“ - æ‰£åˆä¼‘ï¼›æœ€å° 0.5ï¼›æœ€å¤š 8ï¼ˆå‡ºå·®é™¤å¤–ï¼‰
      if (cat === 'OUTING'){
        const isTrip = document.getElementById("isTrip").checked;
        let diff = (e - s) / (1000*60*60);
        diff -= breakDeductionHours(s, e);
        diff = Math.max(0, diff);

        diff = Math.round(diff * 2) / 2;
        diff = Math.max(0.5, diff);

        if (!isTrip) diff = Math.min(8, diff);

        document.getElementById("hours").value = diff.toFixed(1);
        return;
      }
    }catch(err){
      // fallbackï¼šä¿å®ˆï¼ˆä¸é«˜ä¼°ï¼‰
      // âœ… è«‹å‡ fallbackï¼šå¹³æ—¥ç”¨é è¨­æ—©ç­æ™‚é–“çª—äº¤é›†ï¼›å‡æ—¥/é€±æœ« 0
      if (cat === 'LEAVE'){
        let total = 0;
        const cur = new Date(s); cur.setHours(0,0,0,0);
        const endDay = new Date(e); endDay.setHours(0,0,0,0);

        while(cur <= endDay){
          if (isWeekend(cur)) { cur.setDate(cur.getDate()+1); continue; }

          const win = buildShiftWindow(cur, "EARLY"); // 10-18
          const dayStart = new Date(cur); dayStart.setHours(0,0,0,0);
          const dayEnd = new Date(cur); dayEnd.setHours(23,59,59,999);

          const segS = new Date(Math.max(s.getTime(), dayStart.getTime()));
          const segE = new Date(Math.min(e.getTime(), dayEnd.getTime()));

          total += clampToDayWindow(segS, segE, win);
          cur.setDate(cur.getDate()+1);
        }
        document.getElementById("hours").value = (Math.round(total * 10) / 10).toFixed(1);
      } else {
        const diff = Math.max(0, (e - s) / (1000*60*60));
        document.getElementById("hours").value = diff.toFixed(1);
      }
    }
  }

  // ======== é€å‡º ========
  async function submitReq(){
    const btn = document.getElementById("submitBtn");
    const cat = document.getElementById("cat").value;

    btn.disabled = true;
    btn.innerText = "é€å‡ºä¸­...";

    const start = document.getElementById("start").value;
    const end = (cat === 'CORRECTION') ? start : document.getElementById("end").value;
    const hours = (cat === 'CORRECTION') ? 0 : Number(document.getElementById("hours").value || 0);

    if (cat !== 'CORRECTION' && hours <= 0){
      alert("æ™‚æ•¸ä¸æ­£ç¢ºï¼šè«‹ç¢ºèªé–‹å§‹/çµæŸæ™‚é–“");
      btn.disabled = false;
      btn.innerText = "é€å‡ºç”³è«‹";
      return;
    }

    const data = {
      category: cat,
      leaveType: (cat === 'LEAVE') ? document.getElementById("type").value : (cat === 'OT') ? 'comp' : '',
      start, end,
      hours,
      reason: document.getElementById("reason").value || "",
      autoClock: (cat === 'OUTING') ? (document.getElementById("autoClock").checked ? true : false) : false,
      isTrip: (cat === 'OUTING') ? (document.getElementById("isTrip").checked ? true : false) : false
    };

    try{
      const res = await api("submit_request", data);
      if(res && res.ok){
        alert("ç”³è«‹æˆåŠŸï¼");
        location.href = "history.html";
      }else{
        alert("å¤±æ•—ï¼š" + (res && res.message ? res.message : "unknown"));
        btn.disabled = false;
        btn.innerText = "é€å‡ºç”³è«‹";
      }
    }catch(e){
      alert("ç¶²è·¯æˆ–ä¼ºæœå™¨é€¾æ™‚ï¼Œè«‹ç¨å¾Œé‡è©¦");
      btn.disabled = false;
      btn.innerText = "é€å‡ºç”³è«‹";
    }
  }

  toggleType();
  calcHoursSmart();
</script>
</body>
</html>
